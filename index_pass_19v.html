<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YuraCRM Admin Пасажири v17</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a3a5e;
            --primary-dark: #0d1f3c;
            --accent: #d90d0d;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --orange: #f97316;
            --pink: #ec4899;
            --teal: #14b8a6;
            --bg-main: #f5f7fa;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg-main); color: var(--text-primary); min-height: 100vh; }

        /* HEADER */
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 10px 12px; position: sticky; top: 0; z-index: 100; }
        .header-top { display: flex; align-items: center; gap: 10px; }
        .burger-btn { display: none; width: 32px; height: 32px; background: rgba(255,255,255,0.15); border: none; border-radius: 6px; color: white; font-size: 18px; cursor: pointer; align-items: center; justify-content: center; }
        .logo { font-size: 13px; font-weight: 800; color: white; white-space: nowrap; }
        .logo span { color: var(--accent); }
        .search-box { flex: 1; position: relative; }
        .search-input { width: 100%; padding: 8px 12px 8px 32px; border: none; border-radius: 6px; background: rgba(255,255,255,0.15); color: white; font-family: inherit; font-size: 12px; outline: none; }
        .search-input::placeholder { color: rgba(255,255,255,0.6); }
        .search-input:focus { background: rgba(255,255,255,0.25); }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; opacity: 0.7; }
        .header-right { display: flex; align-items: center; gap: 10px; margin-left: auto; }
        .role-badge { background: rgba(255,255,255,0.2); color: white; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; display: none; }
        .user-avatar { width: 30px; height: 30px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 11px; flex-shrink: 0; cursor: pointer; }

        /* MAIN LAYOUT with PC SIDEBAR */
        .main-layout { display: flex; min-height: calc(100vh - 52px); }
        
        /* PC SIDEBAR - STICKY with collapse */
        .pc-sidebar {
            width: 300px;
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            border-right: none;
            flex-shrink: 0;
            overflow-y: auto;
            display: block;
            position: sticky;
            top: 52px;
            height: calc(100vh - 52px);
            box-shadow: 4px 0 20px rgba(0,0,0,0.08);
            transition: width 0.3s ease, min-width 0.3s ease;
            min-width: 300px;
        }
        .pc-sidebar.collapsed-sidebar {
            width: 0;
            min-width: 0;
            overflow: hidden;
            padding: 0;
            box-shadow: none;
        }
        .pc-sidebar-collapse-btn {
            display: none;
            position: fixed;
            top: 60px;
            left: 300px;
            z-index: 150;
            width: 24px;
            height: 48px;
            background: white;
            border: 1px solid var(--border);
            border-left: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-secondary);
            box-shadow: 2px 0 8px rgba(0,0,0,0.08);
            transition: left 0.3s ease, background 0.2s;
        }
        .pc-sidebar-collapse-btn:hover { background: var(--bg-main); color: var(--primary); }
        .pc-sidebar-section { margin: 0; border-bottom: 1px solid var(--border); }
        .pc-sidebar-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 14px 16px; 
            cursor: pointer; 
            background: white;
            transition: all 0.3s ease;
        }
        .pc-sidebar-header:hover { background: #f0f4f8; }
        .pc-sidebar-title { 
            font-size: 13px; 
            font-weight: 800; 
            color: var(--primary); 
            text-transform: uppercase; 
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .pc-sidebar-toggle { 
            font-size: 12px; 
            color: var(--text-secondary); 
            transition: transform 0.3s ease;
        }
        .pc-sidebar-header.collapsed .pc-sidebar-toggle { transform: rotate(-90deg); }
        .pc-sidebar-content { 
            padding: 10px 14px 14px; 
            background: #fafbfc;
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }
        .pc-sidebar-content.collapsed { 
            max-height: 0; 
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }
        
        .pc-sidebar-item { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 11px 14px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 13px; 
            font-weight: 600; 
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.2px;
            color: var(--text-primary); 
            margin-bottom: 5px; 
            background: white;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        .pc-sidebar-item:hover { 
            border-color: var(--primary); 
            background: white;
            box-shadow: 0 3px 10px rgba(26, 58, 94, 0.12);
            transform: translateX(3px);
        }
        .pc-sidebar-item.active { 
            background: var(--primary); 
            color: white; 
            border-color: var(--primary);
            box-shadow: 0 3px 12px rgba(26, 58, 94, 0.3);
        }
        .pc-sidebar-item .item-icon { margin-right: 10px; font-size: 15px; }
        .pc-sidebar-item .item-text { 
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .pc-sidebar-item .item-count { 
            background: var(--bg-main); 
            color: var(--primary); 
            padding: 4px 12px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: 700;
            min-width: 32px;
            text-align: center;
        }
        .pc-sidebar-item.active .item-count { background: rgba(255,255,255,0.25); color: white; }
        .pc-sidebar-item.route { color: var(--success); font-weight: 600; }
        .pc-sidebar-item.route:hover { border-color: var(--success); }
        .pc-sidebar-item.route.active { background: var(--success); color: white; border-color: var(--success); }
        .pc-sidebar-item.optimize { color: var(--purple); font-weight: 600; }
        .pc-sidebar-item.optimize:hover { border-color: var(--purple); }
        .pc-sidebar-item.optimize.active { background: var(--purple); color: white; border-color: var(--purple); }
        .pc-sidebar-item.archive { color: #6b7280; font-weight: 600; }
        .pc-sidebar-item.archive:hover { border-color: #6b7280; }
        .pc-sidebar-item.archive.active { background: #6b7280; color: white; border-color: #6b7280; }
        .pc-sidebar-item.warning { color: var(--warning); font-weight: 600; }
        .pc-sidebar-item.warning:hover { border-color: var(--warning); }
        .pc-sidebar-item.warning .item-count { background: #fef3c7; color: var(--warning); }
        
        .pc-sidebar-calendar { background: white; border-radius: 8px; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .pc-sidebar-add { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 11px; 
            border: 2px dashed var(--border); 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 700; 
            letter-spacing: 0.3px;
            color: var(--info); 
            margin-top: 8px;
            background: white;
            transition: all 0.2s ease;
        }
        .pc-sidebar-add:hover { border-color: var(--info); background: #eff6ff; }
        
        /* Main content area */
        .main-content-area { flex: 1; padding: 12px; overflow-y: auto; transition: margin-left 0.3s ease, margin-right 0.3s ease; }
        .main-content-area.shifted-by-bulk { margin-left: 300px; }
        /* Коли PC sidebar розгорнутий — bulk sidebar = 300px = PC sidebar, зсув не потрібен */
        .pc-sidebar:not(.collapsed-sidebar) ~ .main-content-area.shifted-by-bulk { margin-left: 0; }
        @media (max-width: 1099px) {
            .main-content-area.shifted-by-bulk { margin-left: 0; margin-right: 180px; }
        }

        /* DASHBOARD - Owner Only */
        .dashboard-panel {
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            cursor: pointer;
        }
        .dashboard-header:hover { opacity: 0.95; }
        .dashboard-title {
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dashboard-toggle {
            font-size: 12px;
            transition: transform 0.3s;
        }
        .dashboard-header.collapsed .dashboard-toggle { transform: rotate(-90deg); }
        .dashboard-content {
            padding: 16px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }
        .dashboard-content.collapsed {
            max-height: 0;
            padding: 0 16px;
            opacity: 0;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .dashboard-card {
            background: var(--bg-main);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid var(--border);
        }
        .dashboard-card-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .dashboard-stat {
            text-align: center;
            padding: 12px 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .dashboard-stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }
        .dashboard-stat-value.success { color: var(--success); }
        .dashboard-stat-value.warning { color: var(--warning); }
        .dashboard-stat-value.danger { color: var(--danger); }
        .dashboard-stat-label {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-weight: 600;
        }
        
        .dashboard-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }
        .dashboard-table th {
            text-align: left;
            padding: 8px 10px;
            background: white;
            font-weight: 700;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
        }
        .dashboard-table td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
        }
        .dashboard-table tr:hover td {
            background: rgba(26, 58, 94, 0.03);
        }
        .dashboard-table .text-right { text-align: right; }
        .dashboard-table .text-center { text-align: center; }
        .dashboard-table .font-bold { font-weight: 700; }
        
        .dashboard-alert {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--warning);
        }
        .dashboard-alert.danger { border-left-color: var(--danger); }
        
        /* Dashboard status items */
        .dashboard-statuses { display: flex; flex-direction: column; gap: 6px; }
        .dashboard-status-item { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 10px 12px; 
            background: white; 
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .dashboard-status-item:hover { background: var(--bg-main); transform: translateX(4px); }
        .dashboard-status-item .status-icon { font-size: 16px; }
        .dashboard-status-item .status-name { flex: 1; font-size: 13px; font-weight: 600; }
        .dashboard-status-item .status-count { 
            font-size: 14px; 
            font-weight: 700; 
            background: var(--bg-main); 
            padding: 4px 10px; 
            border-radius: 12px; 
        }
        .dashboard-alert-text {
            font-size: 12px;
            font-weight: 600;
        }
        .dashboard-alert-count {
            font-size: 14px;
            font-weight: 800;
            color: var(--warning);
        }
        .dashboard-alert.danger .dashboard-alert-count { color: var(--danger); }

        /* SIDE MENU (Mobile) */
        .side-menu-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; }
        .side-menu-overlay.show { display: block; }
        .side-menu { 
            position: fixed; 
            top: 0; 
            left: -200px; 
            width: 200px; 
            height: 100%; 
            background: linear-gradient(180deg, #1e3a5f 0%, #0f2744 100%); 
            z-index: 201; 
            transition: left 0.3s ease; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        }
        .side-menu.open { left: 0; }
        .side-menu-header { 
            background: rgba(255,255,255,0.1); 
            color: white; 
            padding: 14px 12px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .side-menu-title { font-size: 13px; font-weight: 700; }
        .side-menu-close { 
            background: rgba(255,255,255,0.15); 
            border: none; 
            color: white; 
            width: 26px; 
            height: 26px; 
            border-radius: 6px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .side-menu-close:hover { background: rgba(255,255,255,0.25); }
        .side-menu-content { flex: 1; overflow-y: auto; padding: 8px; }
        .side-menu-section { margin-bottom: 6px; }
        .side-menu-section-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 10px 12px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 8px; 
            cursor: pointer; 
            margin-bottom: 4px; 
            border: none;
            transition: all 0.2s ease;
        }
        .side-menu-section-header:hover { background: rgba(255,255,255,0.15); }
        .side-menu-section-title { font-size: 11px; font-weight: 600; color: white; }
        .section-toggle { font-size: 8px; color: rgba(255,255,255,0.6); transition: transform 0.2s; }
        .section-toggle.open { transform: rotate(180deg); }
        .side-menu-collapsible { display: none; }
        .side-menu-collapsible.open { display: block; }
        .side-menu-item { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 10px 12px; 
            background: rgba(255,255,255,0.08); 
            border: none; 
            border-radius: 6px; 
            margin-bottom: 3px; 
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .side-menu-item:hover { 
            background: rgba(255,255,255,0.15); 
            transform: translateX(3px);
        }
        .side-menu-item.active { background: rgba(255,255,255,0.25); }
        .side-menu-item-left { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 11px; 
            font-weight: 600; 
            color: white;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }
        .side-menu-item-count { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            padding: 2px 6px; 
            border-radius: 8px; 
            font-size: 9px; 
            font-weight: 700; 
        }
        .side-menu-item.active .side-menu-item-count { background: rgba(255,255,255,0.4); }
        .side-menu-item.optimize { background: rgba(139,92,246,0.3); }
        .side-menu-item.optimize:hover, .side-menu-item.optimize.active { background: rgba(139,92,246,0.5); }
        .side-menu-item.route { background: rgba(34,197,94,0.3); }
        .side-menu-item.route:hover, .side-menu-item.route.active { background: rgba(34,197,94,0.5); }
        .side-menu-item.archive { background: rgba(107,114,128,0.3); }
        .side-menu-item.archive:hover, .side-menu-item.archive.active { background: rgba(107,114,128,0.5); }
        
        /* Календар в бургер меню - темна тема */
        .side-menu .calendar-box { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 8px; }
        .side-menu .calendar-header { padding: 6px 0; }
        .side-menu .calendar-title { font-size: 11px; color: white; }
        .side-menu .calendar-nav button { 
            width: 24px; 
            height: 24px; 
            font-size: 10px; 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: white;
            border-radius: 4px;
        }
        .side-menu .calendar-nav button:hover { background: rgba(255,255,255,0.2); }
        .side-menu .calendar-weekdays { margin-bottom: 4px; }
        .side-menu .calendar-weekday { font-size: 8px; color: rgba(255,255,255,0.5); padding: 3px 0; }
        .side-menu .calendar-days { gap: 2px; }
        .side-menu .calendar-day { 
            height: 26px; 
            font-size: 10px; 
            background: rgba(255,255,255,0.08); 
            color: rgba(255,255,255,0.7);
            border-radius: 4px;
        }
        .side-menu .calendar-day:hover { background: rgba(255,255,255,0.15); }
        .side-menu .calendar-day.other-month { color: rgba(255,255,255,0.25); background: transparent; }
        .side-menu .calendar-day.today { border: 2px solid #60a5fa; background: rgba(96,165,250,0.2); }
        .side-menu .calendar-day.selected { background: #3b82f6; color: white; }
        .side-menu .calendar-day.has-leads { background: rgba(59,130,246,0.3); color: white; }
        .side-menu .calendar-day.overbooked { background: rgba(239,68,68,0.3) !important; border: 1px solid #ef4444 !important; }
        .side-menu .calendar-day-count { 
            font-size: 7px; 
            padding: 0 2px; 
            min-width: 10px; 
            top: 1px; 
            right: 1px;
            background: #3b82f6;
        }
        .side-menu .calendar-actions { margin-top: 6px; gap: 4px; }
        .side-menu .calendar-actions button { 
            padding: 6px; 
            font-size: 9px; 
            border: none;
        }
        .side-menu .calendar-actions .btn-clear { 
            background: rgba(255,255,255,0.1); 
            color: rgba(255,255,255,0.7); 
        }
        .side-menu .calendar-actions .btn-today { 
            background: #3b82f6; 
            color: white; 
        }

        /* CALENDAR */
        .calendar-box { background: white; border-radius: 8px; padding: 12px; }
        .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .calendar-title { font-size: 14px; font-weight: 700; color: var(--primary); }
        .calendar-nav { display: flex; gap: 4px; }
        .calendar-nav button { width: 30px; height: 30px; border: 1px solid var(--border); background: white; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .calendar-nav button:hover { background: var(--bg-main); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; margin-bottom: 4px; }
        .calendar-weekday { font-size: 10px; font-weight: 700; color: var(--text-secondary); padding: 4px 0; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { position: relative; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; border-radius: 6px; cursor: pointer; background: var(--bg-main); color: var(--text-secondary); height: 32px; }
        .calendar-day:hover { background: var(--border); }
        .calendar-day.other-month { color: #cbd5e1; background: transparent; cursor: default; }
        .calendar-day.other-month:hover { background: transparent; }
        .calendar-day.today { border: 2px solid var(--primary); background: white; }
        .calendar-day.selected { background: var(--primary); color: white; }
        .calendar-day.has-leads { background: #dbeafe; color: var(--info); font-weight: 700; }
        .calendar-day.has-leads.selected { background: var(--primary); color: white; }
        .calendar-day-count { position: absolute; top: 1px; right: 2px; font-size: 8px; font-weight: 700; color: white; background: var(--accent); padding: 1px 3px; border-radius: 6px; line-height: 1; min-width: 12px; text-align: center; }
        .calendar-day.selected .calendar-day-count { background: rgba(255,255,255,0.9); color: var(--primary); }
        .calendar-day.overbooked { background: #fee2e2 !important; border: 2px solid #ef4444 !important; }
        .calendar-day.overbooked .calendar-day-count { background: #ef4444; }
        .calendar-day.overbooked.selected { background: #ef4444 !important; color: white; }
        .calendar-actions { display: flex; gap: 8px; margin-top: 10px; }
        .calendar-actions button { flex: 1; padding: 8px; border: none; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .calendar-actions .btn-clear { background: var(--bg-main); color: var(--text-secondary); }
        .calendar-actions .btn-today { background: var(--primary); color: white; }

        /* MAIN */
        .main-content { padding: 10px; max-width: 1100px; margin: 0 auto; padding-bottom: 130px; }

        /* WORKFLOW BAR */
        .workflow-bar { background: white; border-radius: 8px; padding: 10px; margin-bottom: 10px; box-shadow: var(--shadow); }
        .workflow-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .workflow-left { display: flex; align-items: center; gap: 8px; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .checkbox-wrapper input { width: 16px; height: 16px; cursor: pointer; }
        .checkbox-wrapper label { font-size: 10px; font-weight: 600; color: var(--text-secondary); cursor: pointer; }
        .selected-info { font-size: 10px; color: var(--info); font-weight: 600; }
        .workflow-buttons { display: flex; gap: 6px; flex-wrap: wrap; margin-left: auto; }
        .dropdown-container { position: relative; }
        .wf-btn { display: flex; align-items: center; gap: 4px; padding: 7px 12px; border: 2px solid var(--border); border-radius: 6px; background: white; color: var(--text-primary); font-family: inherit; font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .wf-btn:hover { border-color: var(--primary); background: #f8fafc; }
        .wf-btn.active { border-color: var(--primary); background: var(--primary); color: white; }
        .wf-btn .count { background: var(--bg-main); color: var(--primary); padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 700; }
        .wf-btn.active .count { background: rgba(255,255,255,0.3); color: white; }
        .wf-btn.optimize { border-color: var(--purple); color: var(--purple); }
        .wf-btn.optimize:hover, .wf-btn.optimize.active { background: var(--purple); color: white; border-color: var(--purple); }
        .wf-btn.route { border-color: var(--success); color: var(--success); }
        .wf-btn.route:hover, .wf-btn.route.active { background: var(--success); color: white; border-color: var(--success); }
        .wf-btn.archive { border-color: #6b7280; color: #6b7280; }
        .wf-btn.archive:hover, .wf-btn.archive.active { background: #6b7280; color: white; border-color: #6b7280; }
        .dropdown-menu { position: absolute; top: calc(100% + 4px); left: 0; background: white; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); min-width: 280px; display: none; z-index: 300; padding: 10px; }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 10px 12px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); color: var(--text-primary); }
        .dropdown-item:last-child { border: none; }
        .dropdown-item:hover { background: var(--bg-main); }
        .dropdown-item .badge { font-size: 10px; color: white; background: var(--primary); padding: 2px 8px; border-radius: 10px; font-weight: 600; }

        /* OPTIMIZATION PANEL */
        .optimization-panel { display: none; background: linear-gradient(135deg, #f0e6ff, #e6f0ff); border: 2px solid var(--purple); border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .optimization-panel.show { display: block; }
        .opt-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .opt-title { font-size: 13px; font-weight: 700; color: var(--purple); }
        .opt-close { background: none; border: none; font-size: 18px; cursor: pointer; color: var(--text-secondary); }
        .opt-stats { display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap; }
        .opt-stat { text-align: center; }
        .opt-stat-value { font-size: 20px; font-weight: 700; color: var(--primary); }
        .opt-stat-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
        .opt-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .opt-btn { padding: 10px 16px; border: none; border-radius: 6px; font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; }
        .opt-btn.map { background: var(--info); color: white; }
        .opt-btn.confirm { background: var(--success); color: white; }

        /* CARDS - NEW DESIGN */
        .cards-list { display: flex; flex-direction: column; gap: 8px; }
        .lead-card { background: white; border-radius: 8px; box-shadow: var(--shadow); border-left: 4px solid var(--border); position: relative; }
        .lead-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .lead-card.status-new { border-left-color: var(--warning); }
        .lead-card.status-work { border-left-color: var(--info); }
        .lead-card.status-optimize { border-left-color: var(--purple); }
        .lead-card.status-route { border-left-color: var(--success); }
        .lead-card.status-archived { border-left-color: #6b7280; opacity: 0.7; }
        .lead-card.status-refused { border-left-color: var(--danger); background: #fef2f2; }
        .lead-card.status-transferred { border-left-color: var(--teal); background: #f0fdfa; }
        .lead-card.status-deleted { border-left-color: #9ca3af; background: #f3f4f6; opacity: 0.6; }
        .lead-card.selected { background: #f0f7ff; }
        
        /* Статуси водія */
        .lead-card.driver-completed { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-left-color: #28a745; }
        .lead-card.driver-in-progress { background: linear-gradient(135deg, #cce5ff 0%, #b8daff 100%); border-left-color: #007bff; }
        .lead-card.driver-cancelled { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border-left-color: #dc3545; }
        .lead-card.driver-archived { background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%); border-left-color: #6c757d; opacity: 0.8; }
        
        /* Badge статусу */
        .status-badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
        .status-badge.pending { background: #e9ecef; color: #6c757d; }
        .status-badge.completed { background: #28a745; color: white; }
        .status-badge.in-progress { background: #007bff; color: white; }
        .status-badge.cancelled { background: #dc3545; color: white; }
        .status-badge.archived { background: #6c757d; color: white; }
        
        /* Номер в маршруті */
        .route-order-num { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: var(--primary); color: white; border-radius: 50%; font-size: 11px; font-weight: 700; }
        
        .card-header { display: flex; align-items: stretch; padding: 0; cursor: pointer; border-radius: 8px 8px 0 0; overflow: hidden; }
        .card-checkbox-wrap { display: flex; align-items: center; justify-content: center; padding: 10px 8px; background: var(--bg-main); border-right: 1px solid var(--border); flex-shrink: 0; }
        .card-checkbox { width: 18px; height: 18px; cursor: pointer; }
        
        .card-body { flex: 1; padding: 10px; display: flex; flex-direction: column; gap: 4px; min-width: 0; overflow: hidden; }
        .card-body:hover { background: #fafbfc; }
        
        /* Дозволяємо виділення тексту для копіювання */
        .card-phone, .card-id, .card-name, .card-route { 
            user-select: text; 
            cursor: text;
        }
        .card-phone:hover, .card-id:hover { 
            background: rgba(26, 58, 94, 0.1); 
            border-radius: 4px;
            padding: 1px 4px;
            margin: -1px -4px;
        }
        
        /* Row 1: Direction, Phone, Seats, Date, Price */
        .card-top-row { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; min-height: 24px; }
        .card-direction { font-size: 14px; flex-shrink: 0; min-width: 56px; width: auto; text-align: center; white-space: nowrap; }
        .card-phone { font-size: 14px; font-weight: 700; color: var(--primary); letter-spacing: 0.3px; white-space: nowrap; min-width: 120px; }
        .card-seats { background: var(--info); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 700; flex-shrink: 0; min-width: 36px; text-align: center; }
        .card-date { background: var(--bg-main); color: var(--text-primary); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; flex-shrink: 0; white-space: nowrap; }
        .card-price { font-size: 14px; font-weight: 700; color: var(--success); flex-shrink: 0; margin-left: auto; }
        
        /* Row 2 wrapper */
        .card-row2-wrap { display: flex; flex-direction: column; gap: 3px; }
        
        /* Route row */
        .card-route-row { display: flex; align-items: center; min-height: 18px; }
        .card-route { font-size: 12px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .card-route-arrow { color: var(--success); font-weight: 700; margin: 0 4px; }
        
        /* Info row: ID + Name */
        .card-info-row { display: flex; align-items: center; gap: 6px; min-height: 18px; }
        .card-id { font-size: 10px; color: var(--text-secondary); font-weight: 500; background: var(--bg-main); padding: 1px 4px; border-radius: 3px; flex-shrink: 0; }
        .card-name { font-size: 11px; color: var(--text-secondary); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .new-tag { background: var(--accent); color: white; padding: 2px 5px; border-radius: 4px; font-size: 8px; font-weight: 700; text-transform: uppercase; flex-shrink: 0; }
        .order-num { background: var(--purple); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; flex-shrink: 0; }
        
        /* Right section - Авто вгорі, кнопка внизу */
        .card-right-section { display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 6px 10px; border-left: 1px solid var(--border); flex-shrink: 0; min-width: 75px; overflow: visible; position: relative; }
        .card-vehicle-badge { background: var(--info); color: white; padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: 600; cursor: pointer; white-space: nowrap; text-align: center; }
        .card-vehicle-badge:hover { background: var(--primary); }
        .card-vehicle-badge.empty { background: var(--bg-main); color: var(--text-secondary); border: 1px dashed var(--text-secondary); }
        .card-vehicle-badge.empty:hover { background: var(--info); color: white; border-style: solid; }
        .card-actions-toggle { width: 28px; height: 28px; border: none; border-radius: 6px; background: var(--bg-main); cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; margin-top: auto; }
        .card-actions-toggle:hover { background: var(--primary); color: white; }
        .card-actions-toggle.open { background: var(--primary); color: white; transform: rotate(180deg); }
        
        /* Details panel */
        .card-details { display: none; padding: 12px; background: #f8fafc; border-top: 1px solid var(--border); }
        .card-details.show { display: block; }
        .details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .detail-item { background: white; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border); }
        .detail-label { display: block; font-size: 10px; color: var(--text-secondary); margin-bottom: 2px; }
        .detail-value { font-size: 12px; font-weight: 600; color: var(--text); word-break: break-word; }
        .detail-note { background: #fffbeb; padding: 10px; border-radius: 6px; margin-top: 10px; border: 1px solid #fef3c7; }
        .detail-note .detail-label { margin-bottom: 4px; }
        .card-expand-icon { font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .lead-card.expanded .card-expand-icon { transform: rotate(180deg); }
        .detail-block { background: white; border: 1px solid var(--border); border-left: 3px solid var(--primary); border-radius: 6px; padding: 8px 10px; }
        .detail-block-label { font-size: 9px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 2px; }
        .detail-block-value { font-size: 12px; font-weight: 600; color: var(--text-primary); word-break: break-word; }
        .detail-block-value.empty { color: var(--text-secondary); opacity: 0.5; }
        
        /* Actions panel - 2x2 grid */
        .card-actions { display: none; padding: 10px 12px; background: white; border-top: 1px solid var(--border); }
        .card-actions.show { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .btn-card-action { padding: 10px 6px; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; font-family: inherit; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .btn-card-action.btn-delete { background: #fee2e2; color: #dc2626; }
        .btn-card-action.btn-delete:hover { background: #dc2626; color: white; }
        
        /* Route stats - адаптивна статистика */
        .route-stats-box { background: white; border-radius: 8px; padding: 12px; margin-bottom: 12px; box-shadow: var(--shadow); }
        .route-stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; text-align: center; }
        .route-stat-item { cursor: pointer; padding: 8px 4px; border-radius: 8px; transition: all 0.2s ease; }
        .route-stat-item:hover { background: var(--bg-main); }
        .route-stat-item.active { background: var(--primary); color: white !important; }
        .route-stat-item.active.pending { background: #6c757d; }
        .route-stat-item.active.in-progress { background: #007bff; }
        .route-stat-item.active.completed { background: #28a745; }
        .route-stat-item.active.cancelled { background: #dc3545; }
        .route-stat-item.active.not-notified { background: #f97316; }
        .route-stat-num { font-size: 18px; font-weight: 700; }
        .route-stat-label { font-size: 9px; white-space: nowrap; }
        
        @media (max-width: 500px) {
            .route-stats-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; }
            .route-stat-item { padding: 10px 6px; }
            .route-stat-num { font-size: 20px; }
            .route-stat-label { font-size: 10px; }
            /* Картки на мобільному */
            .card-top-row { flex-wrap: wrap; }
            .card-phone { min-width: auto; }
            .card-direction { width: auto; }
        }
        .btn-call { background: var(--primary); color: white; }
        .btn-msg { background: #7c3aed; color: white; }
        .btn-map { background: var(--info); color: white; }
        .btn-edit { background: var(--warning); color: white; }
        
        /* Vehicle badge - тільки відображення */
        .card-vehicle { }
        .card-vehicle-badge { background: var(--info); color: white; padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: 600; white-space: nowrap; text-align: center; cursor: default; }
        .card-vehicle-badge.empty { background: var(--bg-main); color: var(--text-secondary); }
        
        /* DRAG HANDLE */
        .drag-handle { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; cursor: grab; color: var(--text-secondary); opacity: 0.4; padding: 12px 8px; background: var(--bg-main); border-right: 1px solid var(--border); }
        .drag-handle:hover { opacity: 1; background: #e8eaed; }
        .drag-handle span { display: block; width: 14px; height: 2px; background: currentColor; border-radius: 1px; }
        .drag-handle:active { cursor: grabbing; }
        .lead-card.dragging { opacity: 0.5; transform: scale(1.02); }
        .lead-card.drag-over { border-top: 3px solid var(--success); margin-top: -3px; }

        /* BULK ACTIONS SIDEBAR - виїзна панель (червоно-бордова) */
        .bulk-actions-sidebar {
            display: none;
            position: fixed;
            top: 52px;
            left: 0;
            bottom: 0;
            width: 300px;
            background: linear-gradient(180deg, #7f1d1d 0%, #450a0a 100%);
            z-index: 200;
            box-shadow: 4px 0 20px rgba(0,0,0,0.3);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        .bulk-actions-sidebar.show {
            display: flex;
            flex-direction: column;
            transform: translateX(0);
        }
        /* Кнопка Меню у bulk sidebar */
        .bulk-sidebar-menu-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 14px;
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.85);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }
        .bulk-sidebar-menu-btn:hover {
            background: rgba(255,255,255,0.18);
            color: white;
        }
        .bulk-sidebar-header {
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bulk-sidebar-title {
            color: white;
            font-size: 14px;
            font-weight: 700;
        }
        .bulk-sidebar-count {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .bulk-sidebar-actions {
            flex: 1;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .bulk-sidebar-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }
        .bulk-sidebar-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(4px);
        }
        .bulk-sidebar-btn:active {
            transform: scale(0.98);
        }
        /* Всі кнопки однакові - стильно */
        .bulk-sidebar-btn .btn-icon { 
            font-size: 18px; 
            width: 24px; 
            text-align: center;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
        }
        .bulk-sidebar-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 8px 0;
        }
        .bulk-sidebar-close {
            padding: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .bulk-sidebar-close-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: transparent;
            color: white;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .bulk-sidebar-close-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* COLLAPSIBLE SECONDARY ACTIONS */
        .bulk-sidebar-more-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 14px;
            border: 1px dashed rgba(255,255,255,0.3);
            border-radius: 8px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            font-family: inherit;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }
        .bulk-sidebar-more-toggle:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            border-color: rgba(255,255,255,0.5);
        }
        .bulk-sidebar-more-toggle .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 10px;
        }
        .bulk-sidebar-more-toggle.expanded .toggle-arrow {
            transform: rotate(180deg);
        }
        .bulk-sidebar-secondary {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .bulk-sidebar-secondary.expanded {
            max-height: 300px;
            opacity: 1;
        }

        /* ROUTE PROGRESS — centered overlay */
        .route-progress-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1200;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.25);
            backdrop-filter: blur(2px);
        }
        .route-progress-card {
            background: white;
            border-radius: 16px;
            padding: 28px 36px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            min-width: 200px;
            max-width: 280px;
            animation: routeCardIn 0.3s ease;
        }
        @keyframes routeCardIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .route-progress-spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: routeSpin 0.8s linear infinite;
        }
        @keyframes routeSpin {
            to { transform: rotate(360deg); }
        }
        .route-progress-text {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
        }
        /* ROUTE CONFLICT MODAL - redesigned */
        .route-conflict-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1100;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 0;
            opacity: 0;
            transition: opacity 0.25s ease;
        }
        .route-conflict-overlay.show { opacity: 1; }
        .route-conflict-sheet {
            background: white;
            border-radius: 16px 16px 0 0;
            width: 100%;
            max-width: 420px;
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        .route-conflict-overlay.show .route-conflict-sheet {
            transform: translateY(0);
        }
        .route-conflict-handle {
            width: 36px;
            height: 4px;
            background: #d1d5db;
            border-radius: 2px;
            margin: 10px auto;
        }
        .route-conflict-title {
            font-size: 15px;
            font-weight: 700;
            color: #1f2937;
            padding: 4px 20px 12px;
            text-align: center;
        }
        .route-conflict-info {
            padding: 0 20px 12px;
        }
        .route-conflict-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 6px;
        }
        .route-conflict-item-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        .route-conflict-item-text {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }
        .route-conflict-item-sub {
            font-size: 11px;
            color: #9ca3af;
            font-weight: 400;
        }
        .route-conflict-actions {
            padding: 12px 16px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .route-conflict-btn {
            padding: 12px 10px;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .route-conflict-btn:active { transform: scale(0.96); }
        .route-conflict-btn.cancel { background: #f3f4f6; color: #6b7280; grid-column: 1 / -1; }
        .route-conflict-btn.cancel:hover { background: #e5e7eb; }
        .route-conflict-btn.add { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .route-conflict-btn.add:hover { box-shadow: 0 4px 12px rgba(59,130,246,0.4); }
        .route-conflict-btn.archive { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .route-conflict-btn.archive:hover { box-shadow: 0 4px 12px rgba(245,158,11,0.4); }
        .route-conflict-btn.clear { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .route-conflict-btn.clear:hover { box-shadow: 0 4px 12px rgba(239,68,68,0.4); }
        .route-conflict-btn .btn-emoji { font-size: 20px; }
        .route-conflict-btn .btn-label { font-size: 11px; }

        @media (min-width: 600px) {
            .route-conflict-overlay { align-items: center; padding: 20px; }
            .route-conflict-sheet { border-radius: 16px; max-width: 400px; }
        }

        /* Стара панель - приховуємо на PC */
        @media (min-width: 1100px) {
            .bulk-actions-bar { display: none !important; }
        }
        
        /* Mobile styles */
        @media (max-width: 1099px) {
            /* Bulk actions sidebar - СПРАВА на мобільному */
            .bulk-actions-bar { display: none !important; }
            .bulk-actions-sidebar {
                display: none;
                position: fixed;
                top: 52px;
                right: 0;
                left: auto;
                bottom: 0;
                width: 180px;
                transform: translateX(100%);
                box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            }
            .bulk-actions-sidebar.show {
                display: flex;
                transform: translateX(0);
            }
            .bulk-sidebar-header { padding: 12px; }
            .bulk-sidebar-title { font-size: 13px; }
            .bulk-sidebar-count { font-size: 11px; padding: 3px 8px; }
            .bulk-sidebar-actions { padding: 6px; gap: 3px; }
            .bulk-sidebar-btn {
                padding: 10px 12px;
                font-size: 12px;
                border-radius: 6px;
            }
            .bulk-sidebar-btn .btn-icon { font-size: 14px; }
            .bulk-sidebar-divider { margin: 6px 0; }
            .bulk-sidebar-menu-btn { display: none; }
            .bulk-sidebar-close { padding: 8px; }
            .bulk-sidebar-close-btn { padding: 10px; font-size: 12px; }
            .bulk-sidebar-more-toggle { padding: 8px 10px; font-size: 11px; }
            .bulk-sidebar-secondary .bulk-sidebar-btn { padding: 8px 10px; font-size: 11px; }
        }

        /* VEHICLE BADGE ON CARD */
        .card-vehicle { position: relative; }
        .card-vehicle-badge { background: var(--info); color: white; padding: 3px 8px; border-radius: 4px; font-size: 9px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .card-vehicle-badge:hover { background: var(--primary); }
        .card-vehicle-badge.empty { background: var(--border); color: var(--text-secondary); border: 1px dashed var(--text-secondary); }
        .card-vehicle-badge.empty:hover { background: var(--info); color: white; border-style: solid; }
        .vehicle-dropdown { position: absolute; top: calc(100% + 4px); right: 0; background: white; border-radius: 6px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); min-width: 130px; z-index: 50; overflow: hidden; display: none; }
        .vehicle-dropdown.show { display: block; }
        .vehicle-dropdown-item { padding: 8px 12px; font-size: 11px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .vehicle-dropdown-item:last-child { border: none; }
        .vehicle-dropdown-item:hover { background: var(--bg-main); }
        .vehicle-dropdown-item.active { background: var(--info); color: white; }

        /* VEHICLE SELECT MODAL */
        .vehicle-select-list { display: flex; flex-direction: column; gap: 8px; }
        .vehicle-select-item { padding: 14px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .vehicle-select-item:hover { border-color: var(--info); background: #f0f7ff; }
        .vehicle-select-name { font-size: 13px; font-weight: 700; }
        .vehicle-select-info { font-size: 11px; color: var(--text-secondary); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid var(--border); padding: 6px 10px; z-index: 100; display: flex; justify-content: space-around; transition: transform 0.3s ease, opacity 0.3s ease; }
        .bottom-nav.hidden-by-bulk { transform: translateY(100%); opacity: 0; pointer-events: none; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 5px 12px; border: none; background: none; font-family: inherit; font-size: 9px; color: var(--text-secondary); cursor: pointer; position: relative; }
        .nav-item.active { color: var(--accent); }
        .nav-item span:first-child { font-size: 18px; }

        /* DIRECTION POPUP */
        .direction-popup { position: fixed; bottom: 60px; left: 10px; background: white; border-radius: 12px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); padding: 8px; display: none; z-index: 150; min-width: 200px; }
        .direction-popup.show { display: block; }
        .direction-option { display: flex; align-items: center; gap: 10px; padding: 12px 14px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--text-primary); }
        .direction-option:hover { background: var(--bg-main); }
        .direction-option.active { background: var(--primary); color: white; }
        .direction-option span:first-child { font-size: 16px; }
        .dir-count { margin-left: auto; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        .direction-option.active .dir-count { background: rgba(255,255,255,0.3); }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 10px; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 8px; width: 100%; max-width: 400px; max-height: 85vh; overflow: hidden; }
        .modal-header { background: var(--primary); color: white; padding: 10px 12px; display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font-size: 13px; font-weight: 700; }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 26px; height: 26px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .modal-body { padding: 12px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 10px 12px; background: var(--bg-main); display: flex; justify-content: flex-end; gap: 6px; }
        .form-group { margin-bottom: 8px; }
        .form-group label { display: block; font-size: 9px; font-weight: 600; color: var(--text-secondary); margin-bottom: 2px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 7px; border: 2px solid var(--border); border-radius: 4px; font-size: 12px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .btn-cancel { padding: 7px 12px; background: white; border: 2px solid var(--border); border-radius: 4px; font-size: 10px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .btn-save { padding: 7px 14px; background: var(--success); border: none; border-radius: 4px; color: white; font-size: 10px; font-weight: 700; cursor: pointer; font-family: inherit; }
        .columns-hint { background: #fffbeb; border-left: 2px solid var(--warning); padding: 6px 8px; border-radius: 4px; font-size: 9px; color: var(--text-secondary); margin-bottom: 10px; }
        .columns-section { margin-bottom: 12px; }
        .columns-section-title { font-size: 10px; font-weight: 700; color: var(--primary); margin-bottom: 5px; padding-bottom: 3px; border-bottom: 2px solid var(--primary); }
        .columns-list { display: flex; flex-direction: column; gap: 2px; }
        .column-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: var(--bg-main); border-radius: 4px; cursor: pointer; }
        .column-item:hover { background: var(--border); }
        .column-item input { width: 13px; height: 13px; }
        .column-item label { font-size: 10px; flex: 1; cursor: pointer; }
        .column-item.disabled { opacity: 0.4; pointer-events: none; }

        /* MAP MODAL */
        .map-options { display: flex; flex-direction: column; gap: 8px; }
        .map-option-btn { display: flex; align-items: center; gap: 12px; padding: 14px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; text-align: left; transition: all 0.2s; }
        .map-option-btn:hover { border-color: var(--primary); background: #f8fafc; }
        .map-option-btn.route { border-color: var(--success); background: #f0fdf4; }
        .map-option-btn.route:hover { background: var(--success); color: white; }
        .map-option-btn.route:hover .map-option-label { color: white; }
        .map-option-btn.route:hover .map-option-address { color: rgba(255,255,255,0.8); }
        .map-option-icon { font-size: 20px; }
        .map-option-text { display: flex; flex-direction: column; gap: 2px; flex: 1; min-width: 0; }
        .map-option-label { font-size: 12px; font-weight: 600; color: var(--text-primary); }
        .map-option-address { font-size: 11px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .toast { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 10px 20px; border-radius: 6px; font-size: 11px; font-weight: 600; display: none; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .toast.show { display: block; }
        .empty-state { text-align: center; padding: 30px 15px; color: var(--text-secondary); }
        .empty-state-icon { font-size: 36px; margin-bottom: 8px; }
        
        /* Search highlight */
        .search-highlight { background: #fef08a; color: #000; padding: 0 2px; border-radius: 2px; }

        /* OPTIMIZE MODAL STYLES */
        .optimize-info { display: flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 12px 16px; border-radius: 10px; margin-bottom: 16px; }
        .optimize-info-icon { font-size: 24px; }
        .optimize-info-text { font-size: 14px; color: #0d47a1; }
        .optimize-section { margin-bottom: 16px; }
        .optimize-label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text); font-size: 13px; }
        .optimize-radio-group { display: flex; flex-direction: column; gap: 8px; }
        .optimize-radio { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .optimize-radio:hover { border-color: var(--primary); background: rgba(15,52,96,0.03); }
        .optimize-radio.selected { border-color: var(--primary); background: rgba(15,52,96,0.08); }
        .optimize-radio-icon { font-size: 20px; }
        .optimize-radio-text { display: flex; flex-direction: column; }
        .optimize-radio-text strong { font-size: 13px; color: var(--text); }
        .optimize-radio-text small { font-size: 11px; color: var(--text-secondary); }
        .optimize-input { width: 100%; padding: 10px 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg); color: var(--text); }
        .optimize-input:focus { outline: none; border-color: var(--primary); }
        .optimize-hint { display: block; font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
        .optimize-method { background: #fff3e0; padding: 10px 14px; border-radius: 8px; font-size: 12px; color: #e65100; text-align: center; }
        
        .optimize-loading { text-align: center; padding: 30px; }
        .optimize-spinner { border: 3px solid var(--border); border-top: 3px solid var(--primary); border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .optimize-loading-text { font-weight: 600; color: var(--primary); margin-bottom: 4px; }
        .optimize-loading small { color: var(--text-secondary); }
        
        /* Global Loader */
        .global-loader { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px); }
        .global-loader.show { display: flex; }
        .loader-box { background: white; padding: 30px 50px; border-radius: 16px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .loader-spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
        .loader-text { font-weight: 600; color: var(--primary); font-size: 14px; }
        .loader-progress { font-size: 12px; color: var(--text-secondary); margin-top: 8px; }
        
        /* Capacity Alert - ненав'язливе сповіщення справа */
        .capacity-alert { position: fixed; top: 70px; right: 20px; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 2px solid #ef4444; border-radius: 12px; padding: 14px 18px; box-shadow: 0 4px 20px rgba(239,68,68,0.3); z-index: 500; max-width: 280px; animation: slideInRight 0.4s ease, pulse 2s ease-in-out infinite; cursor: pointer; }
        .capacity-alert:hover { transform: scale(1.02); }
        .capacity-alert-header { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #dc2626; font-size: 13px; margin-bottom: 6px; }
        .capacity-alert-body { font-size: 12px; color: #7f1d1d; line-height: 1.4; }
        .capacity-alert-close { position: absolute; top: 8px; right: 10px; background: none; border: none; font-size: 16px; cursor: pointer; color: #dc2626; opacity: 0.6; }
        .capacity-alert-close:hover { opacity: 1; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { box-shadow: 0 4px 20px rgba(239,68,68,0.3); } 50% { box-shadow: 0 4px 30px rgba(239,68,68,0.5); } }
        
        .optimize-result-header { font-size: 18px; font-weight: 700; color: var(--success); text-align: center; margin-bottom: 16px; }
        .optimize-stats { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 16px; }
        .optimize-stat-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px solid var(--border); }
        .optimize-stat-row:last-child { border-bottom: none; }
        .optimize-stat-label { color: var(--text-secondary); }
        .optimize-stat-value { font-weight: 600; color: var(--text); }
        
        .optimize-not-geocoded { background: #fff5f5; border: 1px solid #fecaca; border-radius: 10px; padding: 12px; margin-bottom: 16px; }
        .optimize-not-geocoded-title { font-size: 13px; font-weight: 600; color: #dc2626; margin-bottom: 8px; }
        .optimize-not-geocoded-list { font-size: 12px; color: #991b1b; }
        .optimize-not-geocoded-item { padding: 4px 0; border-bottom: 1px solid #fecaca; }
        .optimize-not-geocoded-item:last-child { border-bottom: none; }
        
        .optimize-map-links { display: flex; flex-direction: column; gap: 8px; }
        .optimize-map-btn { display: block; padding: 14px; background: linear-gradient(135deg, var(--primary), #1e4976); color: white; text-decoration: none; border-radius: 10px; text-align: center; font-weight: 700; font-size: 14px; transition: transform 0.2s; }
        .optimize-map-btn:hover { transform: scale(1.02); }
        
        .not-geocoded-card { border-left: 3px solid #dc2626 !important; background: #fff5f5 !important; }

        @media (max-width: 900px) {
            .burger-btn { display: flex; }
            .workflow-bar { display: none; }
            .search-box { max-width: none; }
            .pc-sidebar { display: none; }
        }

        @media (min-width: 901px) {
            .side-menu, .side-menu-overlay { display: none !important; }
            .header { padding: 12px 20px; }
            .logo { font-size: 15px; }
            .search-box { max-width: 300px; }
            .role-badge { display: block; }
            .main-content-area { padding: 16px 24px; padding-bottom: 130px; }
            .card-name { font-size: 14px; }
            .card-extra, .card-extra2 { font-size: 11px; }
            .card-route { font-size: 12px; }
            .card-price { font-size: 15px; }
            .details-grid { grid-template-columns: repeat(4, 1fr); }
            .card-actions.show { grid-template-columns: repeat(4, 1fr); }
            .workflow-bar { display: none; }
            .pc-sidebar-collapse-btn { display: flex; }
        }
    </style>
</head>
<body>

<!-- SIDE MENU -->
<div class="side-menu-overlay" id="sideMenuOverlay" onclick="closeSideMenu()"></div>
<div class="side-menu" id="sideMenu">
    <div class="side-menu-header">
        <span class="side-menu-title">📋 Фільтри</span>
        <button class="side-menu-close" onclick="closeSideMenu()">×</button>
    </div>
    <div class="side-menu-content">
        <!-- Напрямок -->
        <div class="side-menu-section">
            <div class="side-menu-section-header" onclick="toggleMobileSection('direction')">
                <span class="side-menu-section-title">🧭 Напрямок</span>
                <span class="section-toggle" id="toggleDirection">▼</span>
            </div>
            <div class="side-menu-collapsible" id="mobileDirectionSection">
                <div class="side-menu-item" id="mobileNewLeads" onclick="showNewLeads(); closeSideMenu();" style="background:rgba(59,130,246,0.25);">
                    <span class="side-menu-item-left" style="color:white;font-weight:700;">🆕 Нові (24 год)</span>
                    <span class="side-menu-item-count" id="mobileCountNew" style="background:var(--accent);color:white;">0</span>
                </div>
                <div class="side-menu-item" id="mobileDirectionAll" onclick="setDirection('all'); closeSideMenu();">
                    <span class="side-menu-item-left">📊 Всі напрямки</span>
                    <span class="side-menu-item-count" id="mobileCountAll">0</span>
                </div>
                <div class="side-menu-item" id="mobileDirectionUaEu" onclick="setDirection('ua-eu'); closeSideMenu();">
                    <span class="side-menu-item-left">🇺🇦→🇪🇺 Україна-Європа</span>
                    <span class="side-menu-item-count" id="mobileCountUaEu">0</span>
                </div>
                <div class="side-menu-item" id="mobileDirectionEuUa" onclick="setDirection('eu-ua'); closeSideMenu();">
                    <span class="side-menu-item-left">🇪🇺→🇺🇦 Європа-Україна</span>
                    <span class="side-menu-item-count" id="mobileCountEuUa">0</span>
                </div>
            </div>
        </div>
        
        <!-- Дати - Календар -->
        <div class="side-menu-section">
            <div class="side-menu-section-header" onclick="toggleMobileSection('dates')">
                <span class="side-menu-section-title">📅 Дата виїзду</span>
                <span class="section-toggle" id="toggleDates">▼</span>
            </div>
            <div class="side-menu-collapsible" id="mobileDatesSection">
                <div class="calendar-box" id="mobileCalendar"></div>
            </div>
        </div>
        
        <!-- Авто -->
        <div class="side-menu-section">
            <div class="side-menu-section-header" onclick="toggleMobileSection('vehicles')">
                <span class="side-menu-section-title">🚐 Автомобіль</span>
                <span class="section-toggle" id="toggleVehicles">▼</span>
            </div>
            <div class="side-menu-collapsible" id="mobileVehiclesSection">
                <div class="side-menu-item" style="border-color:var(--warning);color:var(--warning);" onclick="mobileSetVehicle('none')">
                    <span class="side-menu-item-left">❓ Без авто</span>
                    <span class="side-menu-item-count" id="mobileCountNoVehicle">0</span>
                </div>
                <div id="mobileVehiclesList"></div>
                <div class="side-menu-item" onclick="openAddVehicleModal(); closeSideMenu();" style="color:var(--info);font-weight:600;border-top:1px solid var(--border);margin-top:8px;">
                    <span class="side-menu-item-left">➕ Додати авто</span>
                </div>
            </div>
        </div>
        
        <!-- Маршрути -->
        <div class="side-menu-section">
            <div class="side-menu-section-header" onclick="toggleMobileSection('routes')">
                <span class="side-menu-section-title">🚀 Маршрути</span>
                <span class="section-toggle" id="toggleRoutes">▼</span>
            </div>
            <div class="side-menu-collapsible" id="mobileRoutesSection">
                <div class="side-menu-item" onclick="showAllRoutes(); closeSideMenu();">
                    <span class="side-menu-item-left">📋 Всі маршрути</span>
                    <span class="side-menu-item-count" id="mobileCountRoute">0</span>
                </div>
                <div id="mobileRoutesList"></div>
            </div>
        </div>
        
        <!-- Дії -->
        <div class="side-menu-section">
            <div class="side-menu-section-header" onclick="toggleMobileSection('actions')">
                <span class="side-menu-section-title">📋 Статуси</span>
                <span class="section-toggle" id="toggleActions">▼</span>
            </div>
            <div class="side-menu-collapsible" id="mobileActionsSection">
                <div class="side-menu-item" onclick="showStatusFilter('archived'); closeSideMenu();">
                    <span class="side-menu-item-left">📦 Архів</span>
                    <span class="side-menu-item-count" id="mobileCountArchive">0</span>
                </div>
                <div class="side-menu-item" onclick="showStatusFilter('refused'); closeSideMenu();">
                    <span class="side-menu-item-left">❌ Відмови</span>
                    <span class="side-menu-item-count" id="mobileCountRefused">0</span>
                </div>
                <div class="side-menu-item" onclick="showStatusFilter('transferred'); closeSideMenu();">
                    <span class="side-menu-item-left">🤝 Пересадки</span>
                    <span class="side-menu-item-count" id="mobileCountTransferred">0</span>
                </div>
                <div class="side-menu-item" onclick="showStatusFilter('deleted'); closeSideMenu();">
                    <span class="side-menu-item-left">🗑️ Видалені</span>
                    <span class="side-menu-item-count" id="mobileCountDeleted">0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- HEADER -->
<header class="header">
    <div class="header-top">
        <button class="burger-btn" onclick="openSideMenu()">☰</button>
        <div class="logo">YURA<span>TRANSPORTATION</span></div>
        <div class="search-box">
            <span class="search-icon">🔍</span>
            <input type="text" class="search-input" id="searchInput" placeholder="Пошук..." oninput="handleSearch()">
        </div>
        <div class="header-right">
            <span class="role-badge">👤 Адмін</span>
            <div class="user-avatar">Y</div>
        </div>
    </div>
</header>

<!-- MAIN LAYOUT with PC SIDEBAR -->
<div class="main-layout">
    <!-- PC SIDEBAR -->
    <aside class="pc-sidebar" id="pcSidebar">
        <!-- Напрямок -->
        <div class="pc-sidebar-section">
            <div class="pc-sidebar-header" onclick="togglePcSection('direction')">
                <span class="pc-sidebar-title"><span>🧭</span> Напрямок</span>
                <span class="pc-sidebar-toggle" id="pcToggleDirection">▼</span>
            </div>
            <div class="pc-sidebar-content" id="pcSectionDirection">
                <div class="pc-sidebar-item" id="pcNewLeads" onclick="showNewLeads()" style="background:rgba(59,130,246,0.08);color:var(--primary);">
                    <span><span class="item-icon">🆕</span>Нові (24 год)</span>
                    <span class="item-count" id="pcCountNew" style="background:var(--accent);color:white;">0</span>
                </div>
                <div class="pc-sidebar-item" id="pcDirectionAll" onclick="setDirection('all')">
                    <span><span class="item-icon">📊</span>Всі напрямки</span>
                    <span class="item-count" id="pcCountAll">0</span>
                </div>
                <div class="pc-sidebar-item" id="pcDirectionUaEu" onclick="setDirection('ua-eu')">
                    <span><span class="item-icon">🇺🇦→🇪🇺</span>Україна-Європа</span>
                    <span class="item-count" id="pcCountUaEu">0</span>
                </div>
                <div class="pc-sidebar-item" id="pcDirectionEuUa" onclick="setDirection('eu-ua')">
                    <span><span class="item-icon">🇪🇺→🇺🇦</span>Європа-Україна</span>
                    <span class="item-count" id="pcCountEuUa">0</span>
                </div>
            </div>
        </div>
        
        <!-- Дата -->
        <div class="pc-sidebar-section">
            <div class="pc-sidebar-header collapsed" onclick="togglePcSection('date')">
                <span class="pc-sidebar-title"><span>📅</span> Дата виїзду</span>
                <span class="pc-sidebar-toggle" id="pcToggleDate">▼</span>
            </div>
            <div class="pc-sidebar-content collapsed" id="pcSectionDate">
                <div class="pc-sidebar-calendar" id="pcCalendar"></div>
            </div>
        </div>
        
        <!-- Автомобіль -->
        <div class="pc-sidebar-section">
            <div class="pc-sidebar-header collapsed" onclick="togglePcSection('vehicles')">
                <span class="pc-sidebar-title"><span>🚐</span> Автомобіль</span>
                <span class="pc-sidebar-toggle" id="pcToggleVehicles">▼</span>
            </div>
            <div class="pc-sidebar-content collapsed" id="pcSectionVehicles">
                <div class="pc-sidebar-item warning" id="pcVehicleNone" onclick="setVehicleFilter('none')">
                    <span><span class="item-icon">❓</span>Без авто</span>
                    <span class="item-count" id="pcCountNoVehicle">0</span>
                </div>
                <div id="pcVehiclesList"></div>
                <div class="pc-sidebar-add" onclick="openAddVehicleModal()">➕ Додати авто</div>
            </div>
        </div>
        
        <!-- Маршрути -->
        <div class="pc-sidebar-section">
            <div class="pc-sidebar-header collapsed" onclick="togglePcSection('routes')">
                <span class="pc-sidebar-title"><span>🚀</span> Маршрути</span>
                <span class="pc-sidebar-toggle" id="pcToggleRoutes">▼</span>
            </div>
            <div class="pc-sidebar-content collapsed" id="pcSectionRoutes">
                <div class="pc-sidebar-item route" id="pcRouteAll" onclick="showAllRoutes()">
                    <span><span class="item-icon">📋</span>Всі маршрути</span>
                    <span class="item-count" id="pcCountRoute">0</span>
                </div>
                <div id="pcRoutesList"></div>
            </div>
        </div>
        
        <!-- Дії -->
        <div class="pc-sidebar-section">
            <div class="pc-sidebar-header collapsed" onclick="togglePcSection('actions')">
                <span class="pc-sidebar-title"><span>📋</span> Статуси</span>
                <span class="pc-sidebar-toggle" id="pcToggleActions">▼</span>
            </div>
            <div class="pc-sidebar-content collapsed" id="pcSectionActions">
                <div class="pc-sidebar-item archive" id="pcArchive" onclick="showStatusFilter('archived')">
                    <span><span class="item-icon">📦</span>Архів</span>
                    <span class="item-count" id="pcCountArchive">0</span>
                </div>
                <div class="pc-sidebar-item" id="pcRefused" onclick="showStatusFilter('refused')">
                    <span><span class="item-icon">❌</span>Відмови</span>
                    <span class="item-count" id="pcCountRefused">0</span>
                </div>
                <div class="pc-sidebar-item" id="pcTransferred" onclick="showStatusFilter('transferred')">
                    <span><span class="item-icon">🤝</span>Пересадки</span>
                    <span class="item-count" id="pcCountTransferred">0</span>
                </div>
                <div class="pc-sidebar-item" id="pcDeleted" onclick="showStatusFilter('deleted')">
                    <span><span class="item-icon">🗑️</span>Видалені</span>
                    <span class="item-count" id="pcCountDeleted">0</span>
                </div>
            </div>
        </div>
    </aside>
    <button class="pc-sidebar-collapse-btn" id="pcSidebarCollapseBtn" onclick="togglePcSidebar()" title="Згорнути/розгорнути меню">◀</button>

    <!-- MAIN CONTENT AREA -->
    <main class="main-content-area">
        <!-- DASHBOARD - Owner Only -->
        <div class="dashboard-panel" id="dashboardPanel" data-access="owner">
            <div class="dashboard-header collapsed" onclick="toggleDashboard()">
                <span class="dashboard-title">📊 Дашборд власника</span>
                <span class="dashboard-toggle" id="dashboardToggle">▼</span>
            </div>
            <div class="dashboard-content collapsed" id="dashboardContent">
                <div class="dashboard-grid">
                    <!-- Загальна статистика -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">📈 Загальна статистика</div>
                        <div class="dashboard-stats">
                            <div class="dashboard-stat">
                                <div class="dashboard-stat-value" id="dashTotalOrders">0</div>
                                <div class="dashboard-stat-label">Всього заявок</div>
                            </div>
                            <div class="dashboard-stat">
                                <div class="dashboard-stat-value success" id="dashCompleted">0</div>
                                <div class="dashboard-stat-label">Виконано</div>
                            </div>
                            <div class="dashboard-stat">
                                <div class="dashboard-stat-value" id="dashTotalSeats">0</div>
                                <div class="dashboard-stat-label">Пасажирів</div>
                            </div>
                            <div class="dashboard-stat">
                                <div class="dashboard-stat-value success" id="dashTotalSum">€0</div>
                                <div class="dashboard-stat-label">Загальна сума</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Потребують уваги -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">⚠️ Потребують уваги</div>
                        <div class="dashboard-alert">
                            <span class="dashboard-alert-text">❓ Без авто</span>
                            <span class="dashboard-alert-count" id="dashNoVehicle">0</span>
                        </div>
                        <div class="dashboard-alert danger">
                            <span class="dashboard-alert-text">💰 Без оплати</span>
                            <span class="dashboard-alert-count" id="dashNoPayment">0</span>
                        </div>
                        <div class="dashboard-alert">
                            <span class="dashboard-alert-text">🔄 В роботі</span>
                            <span class="dashboard-alert-count" id="dashInWork">0</span>
                        </div>
                    </div>
                    
                    <!-- По авто -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">🚐 Статистика по авто</div>
                        <table class="dashboard-table">
                            <thead>
                                <tr>
                                    <th>Авто</th>
                                    <th class="text-center">Заявок</th>
                                    <th class="text-center">Місць</th>
                                    <th class="text-right">Сума</th>
                                </tr>
                            </thead>
                            <tbody id="dashVehicleStats"></tbody>
                        </table>
                    </div>
                    
                    <!-- Постійні клієнти -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">👥 Постійні клієнти (топ-10)</div>
                        <table class="dashboard-table">
                            <thead>
                                <tr>
                                    <th>Клієнт</th>
                                    <th class="text-center">Поїздок</th>
                                    <th class="text-right">Сума</th>
                                </tr>
                            </thead>
                            <tbody id="dashTopClients"></tbody>
                        </table>
                    </div>
                    
                    <!-- Статуси заявок -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">📋 Статуси заявок</div>
                        <div class="dashboard-statuses">
                            <div class="dashboard-status-item" onclick="showStatusFilter('archived')" style="cursor:pointer;">
                                <span class="status-icon">📦</span>
                                <span class="status-name">Архів</span>
                                <span class="status-count" id="dashArchived">0</span>
                            </div>
                            <div class="dashboard-status-item" onclick="showStatusFilter('refused')" style="cursor:pointer;color:var(--danger);">
                                <span class="status-icon">❌</span>
                                <span class="status-name">Відмови</span>
                                <span class="status-count" id="dashRefused">0</span>
                            </div>
                            <div class="dashboard-status-item" onclick="showStatusFilter('transferred')" style="cursor:pointer;color:var(--teal);">
                                <span class="status-icon">🤝</span>
                                <span class="status-name">Пересадки</span>
                                <span class="status-count" id="dashTransferred">0</span>
                            </div>
                            <div class="dashboard-status-item" onclick="showStatusFilter('deleted')" style="cursor:pointer;color:#6b7280;">
                                <span class="status-icon">🗑️</span>
                                <span class="status-name">Видалені</span>
                                <span class="status-count" id="dashDeleted">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="workflow-bar">
            <div class="workflow-row">
                <div class="workflow-left">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <label for="selectAll">Всі</label>
                    </div>
                    <span class="selected-info" id="selectedInfo"></span>
                </div>
                <div class="workflow-buttons">
                    <button class="wf-btn" onclick="resetFilters()">📊 Всі <span class="count" id="countAll">0</span></button>
                    <div class="dropdown-container">
                        <button class="wf-btn" id="btnDate" onclick="toggleDropdown('dateDropdown')">📅 <span id="dateLabel">Дата</span> <span class="count" id="dateCount" style="display:none">0</span> ▼</button>
                        <div class="dropdown-menu" id="dateDropdown">
                            <div id="desktopCalendar"></div>
                        </div>
                    </div>
                    <div class="dropdown-container">
                        <button class="wf-btn" id="btnVehicle" onclick="toggleDropdown('vehicleDropdown')">🚐 <span id="vehicleLabel">Авто</span> ▼</button>
                        <div class="dropdown-menu" id="vehicleDropdown" style="padding:0;">
                            <div class="dropdown-item" onclick="setVehicleFilter('')">Всі авто</div>
                            <div class="dropdown-item" onclick="setVehicleFilter('none')" style="color:var(--warning);">❓ Без авто <span class="badge" style="background:var(--warning);" id="countNoVehicle">0</span></div>
                            <div id="vehiclesList"></div>
                            <div class="dropdown-item" onclick="openAddVehicleModal()" style="color:var(--info);font-weight:600;border-top:1px solid var(--border);">➕ Додати авто</div>
                        </div>
                    </div>
                    <div class="dropdown-container">
                        <button class="wf-btn route" id="btnRoute" onclick="toggleDropdown('routeDropdown')">🚀 Маршрути <span class="count" id="countRoute">0</span> ▼</button>
                        <div class="dropdown-menu" id="routeDropdown" style="padding:0;">
                            <div class="dropdown-item" onclick="showAllRoutes()">📋 Всі маршрути</div>
                            <div id="routesList"></div>
                        </div>
                    </div>
                    <button class="wf-btn optimize" onclick="runOptimization()">⚡ Оптимізація</button>
                    <button class="wf-btn archive" id="btnArchive" onclick="toggleArchiveFilter()">📦 <span class="count" id="countArchive">0</span></button>
                </div>
            </div>
        </div>

        <div class="optimization-panel" id="optimizationPanel">
            <div class="opt-header">
                <div class="opt-title">⚡ Оптимізація</div>
                <button class="opt-close" onclick="closeOptimization()">×</button>
            </div>
            <div class="opt-stats">
                <div class="opt-stat"><div class="opt-stat-value" id="optLeads">0</div><div class="opt-stat-label">Пасажирів</div></div>
                <div class="opt-stat"><div class="opt-stat-value" id="optSeats">0</div><div class="opt-stat-label">Місць</div></div>
                <div class="opt-stat"><div class="opt-stat-value" id="optSum">€0</div><div class="opt-stat-label">Сума</div></div>
            </div>
            <div class="opt-actions">
                <button class="opt-btn map" onclick="openGoogleMaps()">🗺️ Карта</button>
                <button class="opt-btn confirm" onclick="confirmOptimization()">✅ В маршрут</button>
            </div>
        </div>

        <div class="cards-list" id="cardsList"></div>
    </main>
</div>

<!-- GLOBAL LOADER -->
<div class="global-loader" id="globalLoader">
    <div class="loader-box">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loaderText">Завантаження...</div>
        <div class="loader-progress" id="loaderProgress"></div>
    </div>
</div>

<!-- BULK ACTIONS SIDEBAR - PC версія (виїзна панель зліва) -->
<div class="bulk-actions-sidebar" id="bulkActionsSidebar">
    <div class="bulk-sidebar-header">
        <span class="bulk-sidebar-title">Дії</span>
        <span class="bulk-sidebar-count"><span id="bulkCountSidebar">0</span> вибрано</span>
    </div>
    <div class="bulk-sidebar-actions">
        <button class="bulk-sidebar-menu-btn" onclick="switchToMenu()">
            <span>☰</span> Меню
        </button>
        <button class="bulk-sidebar-btn" onclick="selectAllVisible()">
            <span class="btn-icon">☑️</span> Вибрати всіх
        </button>
        <div class="bulk-sidebar-divider"></div>
        <button class="bulk-sidebar-btn" onclick="openBulkVehicleModal()">
            <span class="btn-icon">🚐</span> Призначити авто
        </button>
        <button class="bulk-sidebar-btn" onclick="bulkOptimize()">
            <span class="btn-icon">⚡</span> Оптимізація
        </button>
        <button class="bulk-sidebar-btn" onclick="bulkMoveToRoute()">
            <span class="btn-icon">🚀</span> В маршрут
        </button>
        <button class="bulk-sidebar-btn" onclick="openTagModal()" style="background:rgba(139,92,246,0.3);">
            <span class="btn-icon">🏷️</span> Протегувати
        </button>
        <button class="bulk-sidebar-btn" id="btnSidebarNotify" onclick="bulkMarkNotified()" style="display:none;">
            <span class="btn-icon">🔔</span> Сповіщено
        </button>
        <div class="bulk-sidebar-divider"></div>
        <button class="bulk-sidebar-more-toggle" id="bulkMoreToggle" onclick="toggleBulkSecondary()">
            <span>Ще дії</span> <span class="toggle-arrow">▼</span>
        </button>
        <div class="bulk-sidebar-secondary" id="bulkSecondaryActions">
            <button class="bulk-sidebar-btn" onclick="bulkRefuse()">
                <span class="btn-icon">❌</span> Відмова
            </button>
            <button class="bulk-sidebar-btn" onclick="bulkTransfer()">
                <span class="btn-icon">🤝</span> Пересадка
            </button>
            <button class="bulk-sidebar-btn" onclick="bulkDelete()">
                <span class="btn-icon">🗑️</span> Видалити
            </button>
            <button class="bulk-sidebar-btn" onclick="bulkArchive()">
                <span class="btn-icon">📦</span> В архів
            </button>
        </div>
        <button class="bulk-sidebar-btn" id="btnSidebarRestore" onclick="bulkRestore()" style="display:none;">
            <span class="btn-icon">↩️</span> Відновити
        </button>
        <button class="bulk-sidebar-btn" id="btnSidebarDeleteForever" onclick="bulkDeleteForever()" style="display:none;">
            <span class="btn-icon">💀</span> Видалити назавжди
        </button>
    </div>
    <div class="bulk-sidebar-close">
        <button class="bulk-sidebar-close-btn" onclick="clearSelection()">
            <span>✕</span> Закрити
        </button>
    </div>
</div>

<!-- BULK ACTIONS BAR - Mobile версія -->
<div class="bulk-actions-bar" id="bulkActionsBar">
    <div class="bulk-actions-content">
        <span class="bulk-selected">Вибрано: <span id="bulkCount">0</span></span>
        <div class="bulk-buttons">
            <button class="bulk-btn select-all" onclick="selectAllVisible()">☑️ Всі</button>
            <button class="bulk-btn vehicle" onclick="openBulkVehicleModal()">🚐 Авто</button>
            <button class="bulk-btn optimize" onclick="bulkOptimize()">⚡</button>
            <button class="bulk-btn route" onclick="bulkMoveToRoute()">🚀</button>
            <button class="bulk-btn" onclick="openTagModal()" style="background:#7c3aed;color:white;">🏷️</button>
            <button class="bulk-btn notify" id="btnBulkNotify" onclick="bulkMarkNotified()" style="display:none;background:#f97316;">🔔</button>
            <button class="bulk-btn archive" id="btnBulkArchive" onclick="bulkArchive()">📦</button>
            <button class="bulk-btn restore" id="btnBulkRestore" onclick="bulkRestore()" style="display:none;background:var(--success);">↩️</button>
            <button class="bulk-btn cancel" onclick="clearSelection()">✕</button>
        </div>
    </div>
</div>

<!-- DIRECTION POPUP -->
<div class="direction-popup" id="directionPopup">
    <div class="direction-option active" data-dir="all" onclick="setDirection('all')">
        <span>📊</span> Всі <span class="dir-count" id="countDirAll">0</span>
    </div>
    <div class="direction-option" data-dir="ua-eu" onclick="setDirection('ua-eu')">
        <span>🇺🇦→🇪🇺</span> Україна-Європа <span class="dir-count" id="countDirUaEu">0</span>
    </div>
    <div class="direction-option" data-dir="eu-ua" onclick="setDirection('eu-ua')">
        <span>🇪🇺→🇺🇦</span> Європа-Україна <span class="dir-count" id="countDirEuUa">0</span>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" id="navPassengers" onclick="toggleDirectionPopup()">
        <span>👥</span>
        <span id="navPassengersLabel">Пасажири</span>
    </button>
    <button class="nav-item" onclick="showToast('📦 Скоро!')"><span>📦</span>Посилки</button>
    <button class="nav-item" onclick="syncWithSheets()"><span>🔄</span>Синхр.</button>
    <button class="nav-item" onclick="openColumnsModal()"><span>⚙️</span>Колонки</button>
    <button class="nav-item" onclick="openAddModal()"><span>➕</span>Додати</button>
</nav>

<!-- MODALS -->
<div class="modal-overlay" id="passengerModal" onclick="if(event.target===this)closeModal('passengerModal')">
    <div class="modal">
        <div class="modal-header"><span class="modal-title" id="passengerModalTitle">Додати</span><button class="modal-close" onclick="closeModal('passengerModal')">×</button></div>
        <div class="modal-body">
            <div class="form-group">
                <label>Напрямок</label>
                <select id="fDirection" style="background:var(--bg-main);">
                    <option value="ua-eu">🇺🇦→🇪🇺 Україна-Європа</option>
                    <option value="eu-ua">🇪🇺→🇺🇦 Європа-Україна</option>
                </select>
            </div>
            <div class="form-row"><div class="form-group"><label>Дата виїзду</label><input type="date" id="fDate"></div><div class="form-group"><label>Місць</label><input type="number" id="fSeats" value="1" min="1"></div></div>
            <div class="form-group"><label>ПіБ</label><input type="text" id="fName"></div>
            <div class="form-row"><div class="form-group"><label>Телефон пасажира</label><input type="tel" id="fPhone"></div><div class="form-group"><label>Тел. реєстратора</label><input type="tel" id="fPhoneReg"></div></div>
            <div class="form-group"><label>Адреса відправки</label><input type="text" id="fFrom"></div>
            <div class="form-group"><label>Адреса прибуття</label><input type="text" id="fTo"></div>
            <div class="form-row"><div class="form-group"><label>Оплата €</label><input type="text" id="fPayment"></div><div class="form-group"><label>Відсоток %</label><input type="text" id="fPercent"></div></div>
            <div class="form-row"><div class="form-group"><label>Авто</label><select id="fVehicle"><option value="">—</option></select></div><div class="form-group"><label>Відмітка</label><input type="text" id="fMark"></div></div>
            <div class="form-row"><div class="form-group"><label>Диспечер</label><input type="text" id="fDispatcher"></div><div class="form-group"><label>Вага (кг)</label><input type="text" id="fWeight"></div></div>
            <div class="form-row"><div class="form-group"><label>Таймінг</label><input type="text" id="fTiming"></div><div class="form-group"><label>Дата оформлення</label><input type="date" id="fDateReg"></div></div>
            <div class="form-group"><label>Примітка</label><textarea id="fNote" rows="2"></textarea></div>
        </div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('passengerModal')">Скасувати</button><button class="btn-save" onclick="savePassenger()">💾 Зберегти</button></div>
    </div>
</div>


<div class="modal-overlay" id="bulkVehicleModal" onclick="if(event.target===this)closeModal('bulkVehicleModal')">
    <div class="modal" style="max-width:320px">
        <div class="modal-header"><span class="modal-title">🚐 Призначити авто</span><button class="modal-close" onclick="closeModal('bulkVehicleModal')">×</button></div>
        <div class="modal-body">
            <p style="font-size:11px;color:var(--text-secondary);margin-bottom:12px;">Виберіть авто для <strong id="bulkVehicleCount">0</strong> пасажирів:</p>
            <div class="vehicle-select-list" id="bulkVehicleList"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('bulkVehicleModal')">Скасувати</button>
            <button class="btn-save" id="bulkVehicleConfirmBtn" onclick="confirmBulkAssignVehicle()" disabled style="opacity:0.5;">🚐 Призначити</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="columnsModal" onclick="if(event.target===this)closeModal('columnsModal')">
    <div class="modal" style="max-width:350px">
        <div class="modal-header"><span class="modal-title">⚙️ Колонки</span><button class="modal-close" onclick="closeModal('columnsModal')">×</button></div>
        <div class="modal-body">
            <div class="columns-hint">Якщо в заголовку — не в деталях</div>
            <div class="columns-section"><div class="columns-section-title">Заголовок</div><div class="columns-list" id="headerColList"></div></div>
            <div class="columns-section"><div class="columns-section-title">Деталі</div><div class="columns-list" id="detailsColList"></div></div>
        </div>
        <div class="modal-footer" style="display:flex;gap:8px;">
            <button class="btn-secondary" onclick="resetColumnsSettings()" style="flex:1;">🔄 Скинути</button>
            <button class="btn-save" onclick="saveColumnsSettings()" style="flex:1;">💾 Зберегти</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="mapModal" onclick="if(event.target===this)closeModal('mapModal')">
    <div class="modal" style="max-width:320px">
        <div class="modal-header"><span class="modal-title">🗺️ Карта</span><button class="modal-close" onclick="closeModal('mapModal')">×</button></div>
        <div class="modal-body">
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Оберіть що переглянути:</p>
            <div class="map-options">
                <button class="map-option-btn" onclick="openMapLocation('from')">
                    <span class="map-option-icon">📍</span>
                    <span class="map-option-text">
                        <span class="map-option-label">Пункт відправки</span>
                        <span class="map-option-address" id="mapFromAddress">—</span>
                    </span>
                </button>
                <button class="map-option-btn" onclick="openMapLocation('to')">
                    <span class="map-option-icon">🏁</span>
                    <span class="map-option-text">
                        <span class="map-option-label">Пункт прибуття</span>
                        <span class="map-option-address" id="mapToAddress">—</span>
                    </span>
                </button>
                <button class="map-option-btn route" onclick="openMapLocation('route')">
                    <span class="map-option-icon">🛣️</span>
                    <span class="map-option-text">
                        <span class="map-option-label">Прокласти маршрут</span>
                        <span class="map-option-address" id="mapRouteAddress">—</span>
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- МОДАЛКА ДОДАТИ АВТО -->
<div class="modal-overlay" id="vehicleModal" onclick="if(event.target===this)closeModal('vehicleModal')">
    <div class="modal" style="max-width:340px">
        <div class="modal-header"><span class="modal-title">🚐 Нове авто</span><button class="modal-close" onclick="closeModal('vehicleModal')">×</button></div>
        <div class="modal-body">
            <div class="form-group">
                <label>Назва авто</label>
                <input type="text" id="vName" placeholder="Наприклад: Авто 4">
            </div>
            <div class="form-group">
                <label>Кількість місць</label>
                <input type="number" id="vSeats" value="8" min="1">
            </div>
            <div style="background:#fff3e0;padding:10px;border-radius:6px;font-size:11px;color:#e65100;margin-top:12px;">
                ⚠️ Буде створено новий аркуш в таблиці "Маршрут Пасажири"
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('vehicleModal')">Скасувати</button>
            <button class="btn-save" onclick="saveVehicle()">💾 Створити</button>
        </div>
    </div>
</div>

<!-- МОДАЛКА ОПТИМІЗАЦІЇ -->
<div class="modal-overlay" id="optimizeModal" onclick="if(event.target===this)closeModal('optimizeModal')">
    <div class="modal" style="max-width:420px">
        <div class="modal-header">
            <span class="modal-title">🚀 Оптимізація маршруту</span>
            <button class="modal-close" onclick="closeModal('optimizeModal')">×</button>
        </div>
        <div class="modal-body" id="optimizeFormBody">
            <div class="optimize-info">
                <span class="optimize-info-icon">📦</span>
                <span class="optimize-info-text">Заявок для оптимізації: <strong id="optimizeCount">0</strong></span>
            </div>
            
            <div class="optimize-section">
                <label class="optimize-label">📋 Оптимізувати по:</label>
                <div class="optimize-radio-group">
                    <label class="optimize-radio selected" id="optFrom" onclick="selectOptimizeBy('from')">
                        <span class="optimize-radio-icon">📍</span>
                        <span class="optimize-radio-text">
                            <strong>Адреса ВІДПРАВКИ</strong>
                            <small>де забирати пасажирів</small>
                        </span>
                    </label>
                    <label class="optimize-radio" id="optTo" onclick="selectOptimizeBy('to')">
                        <span class="optimize-radio-icon">🏁</span>
                        <span class="optimize-radio-text">
                            <strong>Адреса ПРИБУТТЯ</strong>
                            <small>де висаджувати пасажирів</small>
                        </span>
                    </label>
                </div>
            </div>
            
            <div class="optimize-section">
                <label class="optimize-label">📍 Точка старту:</label>
                <input type="text" class="optimize-input" id="optimizeStart" placeholder="Залиште пустим → Ужгород">
                <small class="optimize-hint">Звідки починається маршрут</small>
            </div>
            
            <div class="optimize-section">
                <label class="optimize-label">🏁 Точка закінчення:</label>
                <input type="text" class="optimize-input" id="optimizeEnd" placeholder="Залиште пустим → остання точка">
                <small class="optimize-hint">Де закінчується маршрут</small>
            </div>
            
            <div class="optimize-method">
                🗺️ Google Directions API + посилання на карту
            </div>
        </div>
        
        <!-- Результат оптимізації -->
        <div class="modal-body" id="optimizeResultBody" style="display:none">
            <div class="optimize-result-header">✅ Маршрут оптимізовано!</div>
            <div class="optimize-stats" id="optimizeStats"></div>
            <div class="optimize-not-geocoded" id="optimizeNotGeocoded" style="display:none">
                <div class="optimize-not-geocoded-title">⚠️ Не вдалось знайти адреси:</div>
                <div class="optimize-not-geocoded-list" id="optimizeNotGeocodedList"></div>
            </div>
            <div class="optimize-map-links" id="optimizeMapLinks"></div>
        </div>
        
        <!-- Завантаження -->
        <div class="modal-body" id="optimizeLoadingBody" style="display:none">
            <div class="optimize-loading">
                <div class="optimize-spinner"></div>
                <div class="optimize-loading-text" id="optimizeLoadingText">Оптимізація маршруту...</div>
                <small id="optimizeLoadingProgress">Це може зайняти 10-30 секунд</small>
            </div>
        </div>
        
        <div class="modal-footer" id="optimizeFormFooter">
            <button class="btn-cancel" onclick="closeModal('optimizeModal')">Скасувати</button>
            <button class="btn-save" onclick="startOptimization()">🚀 Оптимізувати</button>
        </div>
        <div class="modal-footer" id="optimizeResultFooter" style="display:none">
            <button class="btn-save" onclick="closeModal('optimizeModal')">Закрити</button>
        </div>
    </div>
</div>

<!-- TAG MODAL -->
<div class="modal-overlay" id="tagModal" onclick="if(event.target===this)closeTagModal()">
    <div class="modal" style="max-width:420px">
        <div class="modal-header" style="background:#f3e8ff;">
            <span class="modal-title" style="color:#7c3aed;">🏷️ Протегувати в Smart Sender</span>
            <button class="modal-close" onclick="closeTagModal()">×</button>
        </div>
        <div class="modal-body" id="tagFormBody">
            <div style="margin-bottom:12px;font-size:13px;color:var(--text-secondary);">
                Вибрано пасажирів: <strong id="tagSelectedCount">0</strong>
            </div>
            <div class="form-group">
                <label>Назва тегу</label>
                <input type="text" id="tagNameInput" placeholder="Наприклад: Братислава_20.02" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:13px;">
            </div>
            <div style="background:#f3e8ff;padding:10px;border-radius:6px;font-size:11px;color:#5b21b6;margin-top:8px;">
                🏷️ Тег буде створено (або знайдено існуючий) і прив'язано до кожного вибраного ліда по ІД
            </div>
        </div>
        <div class="modal-body" id="tagProgressBody" style="display:none;">
            <div id="tagProgressText" style="font-size:13px;font-weight:600;color:var(--primary);margin-bottom:12px;">⏳ Тегування...</div>
            <div style="background:var(--bg-main);border-radius:8px;overflow:hidden;height:8px;margin-bottom:12px;">
                <div id="tagProgressBar" style="height:100%;background:#7c3aed;width:0%;transition:width 0.3s;border-radius:8px;"></div>
            </div>
            <div id="tagLog" style="max-height:250px;overflow-y:auto;font-size:11px;font-family:monospace;background:#fafafa;padding:10px;border-radius:6px;border:1px solid var(--border);white-space:pre-wrap;"></div>
        </div>
        <div class="modal-footer" id="tagFormFooter">
            <button onclick="closeTagModal()" style="padding:8px 16px;border:1px solid var(--border);background:white;border-radius:6px;cursor:pointer;font-family:inherit;">Скасувати</button>
            <button onclick="startTagging()" style="padding:8px 16px;background:#7c3aed;color:white;border:none;border-radius:6px;cursor:pointer;font-family:inherit;font-weight:600;">🏷️ Протегувати</button>
        </div>
        <div class="modal-footer" id="tagResultFooter" style="display:none;">
            <button onclick="closeTagModal()" style="padding:8px 16px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;font-family:inherit;font-weight:600;">Закрити</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
// Google Maps API init callback
window.mapsApiReady = false;
window.mapsGeocoder = null;
window.mapsDirections = null;
function initMapsAPI() {
    window.mapsApiReady = true;
    window.mapsGeocoder = new google.maps.Geocoder();
    window.mapsDirections = new google.maps.DirectionsService();
    console.log('✅ Google Maps API ready');
}
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCthPzhD6zDM9zR-re0R2ceohyhCRdawNc&callback=initMapsAPI"></script>

<script>
const ALL_COLUMNS = {
    name:{label:'ПіБ',group:'row1'},
    phone:{label:'Телефон',group:'row1'},
    seats:{label:'Місць',group:'row1'},
    id:{label:'ІД',group:'row1'},
    from:{label:'Звідки',group:'row2'},
    to:{label:'Куди',group:'row2'},
    vehicle:{label:'Авто',group:'row2'},
    date:{label:'Дата виїзду',group:'meta'},
    payment:{label:'Оплата',group:'meta'},
    percent:{label:'Відсоток',group:'meta'},
    mark:{label:'Відмітка',group:'details'},
    dispatcher:{label:'Диспечер',group:'details'},
    phoneReg:{label:'Тел. реєстратора',group:'details'},
    weight:{label:'Вага',group:'details'},
    timing:{label:'Таймінг',group:'details'},
    dateReg:{label:'Дата оформлення',group:'details'},
    note:{label:'Примітка',group:'details'}
};

let colSettings = {header:['name','phone','seats','from','to','date','payment'],details:['percent','note','mark','dispatcher','phoneReg','timing','dateReg','weight']};
let passengers = [
    {id:'p1',date:'2025-02-20',name:'Семен Гора',phone:'+380639763484',from:'Кошице',to:'Ужгород',seats:2,payment:'60',vehicle:'v1',status:'new',isNew:true,order:0,direction:'eu-ua'},
    {id:'p2',date:'2025-02-20',name:'Катерина Ятухівська',phone:'+380973874545',from:'Братислава',to:'Ужгород',seats:1,payment:'60',vehicle:'v1',status:'work',isNew:false,order:1,direction:'eu-ua'},
    {id:'p3',date:'2025-02-20',name:'Мирослава Попович',phone:'+380668910320',from:'Прешов',to:'Ужгород',seats:2,payment:'120',vehicle:'',status:'new',isNew:false,order:2,direction:'eu-ua'},
    {id:'p4',date:'2025-02-21',name:'Ольга Рудніцька',phone:'+380963890596',from:'Київ',to:'Братислава',seats:1,payment:'80',vehicle:'',status:'new',isNew:true,order:3,direction:'ua-eu'},
    {id:'p5',date:'2025-02-21',name:'Віктор Давидов',phone:'+380961524193',from:'Житомир',to:'Братислава',seats:2,payment:'120',vehicle:'v2',status:'route',isNew:false,order:4,direction:'ua-eu'},
    {id:'p6',date:'2025-02-22',name:'Алла Бердникова',phone:'+421907299343',from:'Братислава',to:'Вінниця',seats:1,payment:'60',vehicle:'',status:'new',isNew:true,order:5,direction:'eu-ua'}
];
// Таблиця маршрутів пасажирів
const ROUTE_SPREADSHEET_ID = '1iKlD0Bj-5qB3Gc1d5ZBHscbRipcSe5xU7svqBfpB77Y';

const DEFAULT_VEHICLES = [
    {id:'v1', name:'Авто 1', seats:8, routeSheet:'Пас. Маршрут 1'},
    {id:'v2', name:'Авто 2', seats:6, routeSheet:'Пас. Маршрут 2'},
    {id:'v3', name:'Авто 3', seats:8, routeSheet:'Пас. Маршрут 3'}
];
let vehicles = DEFAULT_VEHICLES.map(v => ({...v}));

// Список службових аркушів які НЕ є маршрутами
const EXCLUDED_SHEETS = ['логи', 'розсилка', 'лог', 'logs', 'mailing', 'провірка'];

function isRouteSheet(name) {
    return !EXCLUDED_SHEETS.some(ex => name.toLowerCase().includes(ex));
}

// Синхронізація vehicles з сервера — підтягує нові аркуші, видаляє зниклі
async function syncVehiclesFromServer() {
    try {
        const res = await fetch(ROUTE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'getAvailableRoutes' })
        });
        const data = await res.json();
        if (!data.success || !data.routes) return;

        // Фільтруємо лише маршрутні аркуші
        const serverSheets = data.routes.filter(r => isRouteSheet(r.name));

        // 1) Додаємо нові аркуші яких немає в vehicles
        for (const sheet of serverSheets) {
            const exists = vehicles.find(v =>
                v.routeSheet === sheet.name || v.name === sheet.name
            );
            if (!exists) {
                vehicles.push({
                    id: 'v' + Date.now() + '_' + Math.random().toString(36).slice(2, 6),
                    name: sheet.name.replace(/^Пас\.\s*/, ''),
                    seats: 8,
                    routeSheet: sheet.name
                });
            }
        }

        // 2) Помічаємо авто чий аркуш зник з сервера (але не видаляємо дефолтні)
        const serverNames = serverSheets.map(s => s.name);
        vehicles = vehicles.filter(v => {
            if (!v.routeSheet) return true; // без аркуша — залишаємо
            if (serverNames.includes(v.routeSheet)) return true; // є на сервері
            // Перевіряємо чи це дефолтне авто — залишаємо як fallback
            if (DEFAULT_VEHICLES.find(d => d.id === v.id)) return true;
            return false; // аркуш видалено з сервера — прибираємо
        });

        // Оновлюємо UI
        updateVehiclesList();
        updateMobileVehicles();
        if (typeof updateRoutesList === 'function') updateRoutesList();
        if (typeof updatePcVehiclesList === 'function') updatePcVehiclesList();
    } catch (e) {
        console.error('syncVehiclesFromServer error:', e);
    }
}
let filters = {date:'',vehicle:'',search:'',showArchive:false,statusFilter:'',routeVehicle:'',direction:'all',specialStatus:'',statusDateFrom:'',statusDateTo:'',showNewOnly:true};
let selectedIds = new Set();
let editingId = null;
let openDetailsId = null;
let openActionsId = null;
let calendarDate = new Date(); // Поточна дата
let draggedId = null;
let undoHistory = []; // Історія для відміни дій

// INIT
document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    renderCalendars();
    
    // За замовчуванням показуємо нові ліди
    filters.showNewOnly = true;
    document.getElementById('pcNewLeads')?.classList.add('active');
    document.getElementById('mobileNewLeads')?.classList.add('active');
    const navLabel = document.getElementById('navPassengersLabel');
    if (navLabel) navLabel.textContent = '🆕 Нові';
    
    render();
    updateVehiclesList();
    updateAllCounts();

    // Синхронізуємо авто з сервера (підтягуємо нові аркуші)
    syncVehiclesFromServer().then(() => updateAllCounts());

    // Перевірка перевищення місткості при завантаженні (з затримкою)
    setTimeout(() => checkAllCapacityWarnings(), 2000);

    // Періодична перевірка кожні 5 хвилин
    setInterval(() => checkAllCapacityWarnings(), 300000);

    // Тихе авто-оновлення кожні 60 секунд
    setInterval(() => silentSync(), 60000);
});

// Тиха синхронізація (без loader)
function silentSync() {
    // Не оновлюємо якщо відкрита модалка редагування
    if (document.getElementById('passengerModal')?.classList.contains('show')) return;
    
    fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'getAll' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const oldCount = passengers.length;
            const serverPassengers = data.passengers.map(p => {
                // Нормалізуємо статус (lowercase, trim)
                let normalizedStatus = (p.status || '').toString().toLowerCase().trim();
                if (!normalizedStatus) normalizedStatus = 'new';
                
                return {
                    id: p.id || 'srv_' + p.rowNum,
                    date: normalizeDate(p.date),
                    name: p.name || '',
                    phone: p.phone || '',
                    phoneReg: p.phoneReg || '',
                    from: p.from || '',
                    to: p.to || '',
                    seats: p.seats || 1,
                    payment: p.payment || '',
                    percent: p.percent || '',
                    mark: p.mark || '',
                    dispatcher: p.dispatcher || '',
                    weight: p.weight || '',
                    vehicle: p.vehicle || '',
                    timing: p.timing || '',
                    dateReg: normalizeDate(p.dateReg),
                    note: p.note || '',
                    direction: p.direction,
                    status: normalizedStatus,
                    statusDate: p.statusDate || '',
                    isNew: p.isNew,
                    isNew24h: p.isNew,
                    _sheet: p.sheet,
                    _rowNum: p.rowNum
                };
            });
            
            // Перевіряємо чи є нові ліди
            const hiddenStatuses = ['archived', 'refused', 'transferred', 'deleted'];
            const newCount = serverPassengers.filter(p => p.isNew && !hiddenStatuses.includes(p.status)).length;
            const oldNewCount = passengers.filter(p => p.isNew && !hiddenStatuses.includes(p.status)).length;
            
            passengers = serverPassengers;
            saveSettings();
            
            // Оновлюємо UI тільки якщо не в режимі маршруту
            if (filters.statusFilter !== 'route') {
                render();
                updateAllCounts();
                renderCalendars();
            }
            
            // Якщо з'явились нові ліди - сповіщаємо
            if (newCount > oldNewCount) {
                playNotificationSound();
                showToast(`🆕 Новий лід! (${newCount})`);
            }
        }
    })
    .catch(err => {
        console.log('Silent sync failed:', err);
    });
}

// Звук сповіщення для нових лідів
function playNotificationSound() {
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.1;
        
        oscillator.start();
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        oscillator.stop(audioCtx.currentTime + 0.3);
    } catch(e) {
        console.log('Sound not supported');
    }
}

function loadSettings() { try { const s = JSON.parse(localStorage.getItem('yuraCrmV16')||'{}'); if(s.colSettings)colSettings=s.colSettings; if(s.passengers)passengers=s.passengers; } catch(e){} }
function saveSettings() { localStorage.setItem('yuraCrmV16', JSON.stringify({colSettings,passengers})); }

// SIDE MENU
function openSideMenu() { document.getElementById('sideMenu').classList.add('open'); document.getElementById('sideMenuOverlay').classList.add('show'); renderMobileCalendar(); updateMobileVehicles(); }
function closeSideMenu() { document.getElementById('sideMenu').classList.remove('open'); document.getElementById('sideMenuOverlay').classList.remove('show'); }

function toggleMobileSection(section) {
    const ids = {direction:'mobileDirectionSection',dates:'mobileDatesSection',vehicles:'mobileVehiclesSection',routes:'mobileRoutesSection',actions:'mobileActionsSection'};
    const toggles = {direction:'toggleDirection',dates:'toggleDates',vehicles:'toggleVehicles',routes:'toggleRoutes',actions:'toggleActions'};
    document.getElementById(ids[section])?.classList.toggle('open');
    document.getElementById(toggles[section])?.classList.toggle('open');
}

// PC Sidebar згортання
function togglePcSection(section) {
    const sectionMap = {
        direction: { content: 'pcSectionDirection', toggle: 'pcToggleDirection', header: null },
        date: { content: 'pcSectionDate', toggle: 'pcToggleDate', header: null },
        vehicles: { content: 'pcSectionVehicles', toggle: 'pcToggleVehicles', header: null },
        routes: { content: 'pcSectionRoutes', toggle: 'pcToggleRoutes', header: null },
        actions: { content: 'pcSectionActions', toggle: 'pcToggleActions', header: null }
    };
    
    const config = sectionMap[section];
    if (!config) return;
    
    const content = document.getElementById(config.content);
    const toggle = document.getElementById(config.toggle);
    const header = toggle?.parentElement;
    
    if (content) content.classList.toggle('collapsed');
    if (header) header.classList.toggle('collapsed');
}

// PC Sidebar повне згортання/розгортання
function togglePcSidebar() {
    const sidebar = document.getElementById('pcSidebar');
    const btn = document.getElementById('pcSidebarCollapseBtn');
    if (!sidebar || !btn) return;
    const isCollapsed = sidebar.classList.toggle('collapsed-sidebar');
    btn.classList.toggle('sidebar-hidden', isCollapsed);
    btn.textContent = isCollapsed ? '▶' : '◀';
    btn.style.left = isCollapsed ? '0px' : '300px';
}

// ============================================
// DASHBOARD - Owner Only
// ============================================
const USER_ACCESS = 'owner'; // 'owner' | 'admin' | 'dispatcher'

function toggleDashboard() {
    const content = document.getElementById('dashboardContent');
    const header = document.querySelector('.dashboard-header');
    content.classList.toggle('collapsed');
    header.classList.toggle('collapsed');
    
    // Оновлюємо дані при відкритті
    if (!content.classList.contains('collapsed')) {
        updateDashboard();
    }
}

function updateDashboard() {
    // Перевірка доступу (на майбутнє)
    if (USER_ACCESS !== 'owner') {
        document.getElementById('dashboardPanel').style.display = 'none';
        return;
    }
    
    const active = passengers.filter(p => p.status !== 'archived');
    
    // 1. Загальна статистика
    const totalOrders = active.length;
    const completed = active.filter(p => p.status === 'route' || p.status === 'done').length;
    const totalSeats = active.reduce((sum, p) => sum + (parseInt(p.seats) || 1), 0);
    const totalSum = active.reduce((sum, p) => {
        const payment = parseFloat(String(p.payment || '0').replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
        return sum + payment;
    }, 0);
    
    document.getElementById('dashTotalOrders').textContent = totalOrders;
    document.getElementById('dashCompleted').textContent = completed;
    document.getElementById('dashTotalSeats').textContent = totalSeats;
    document.getElementById('dashTotalSum').textContent = '€' + totalSum.toFixed(0);
    
    // 2. Потребують уваги
    const noVehicle = active.filter(p => !p.vehicle).length;
    const noPayment = active.filter(p => !p.payment || p.payment === '' || p.payment === '0').length;
    const inWork = active.filter(p => p.status === 'work' || p.status === 'new').length;
    
    document.getElementById('dashNoVehicle').textContent = noVehicle;
    document.getElementById('dashNoPayment').textContent = noPayment;
    document.getElementById('dashInWork').textContent = inWork;
    
    // 3. Статистика по авто
    const vehicleStats = {};
    vehicles.forEach(v => {
        vehicleStats[v.id] = { name: v.name, orders: 0, seats: 0, sum: 0 };
    });
    
    active.forEach(p => {
        const veh = vehicles.find(v => v.id === p.vehicle || v.name === p.vehicle);
        if (veh && vehicleStats[veh.id]) {
            vehicleStats[veh.id].orders++;
            vehicleStats[veh.id].seats += parseInt(p.seats) || 1;
            const payment = parseFloat(String(p.payment || '0').replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
            vehicleStats[veh.id].sum += payment;
        }
    });
    
    const vehicleStatsHtml = Object.values(vehicleStats)
        .filter(v => v.orders > 0)
        .sort((a, b) => b.sum - a.sum)
        .map(v => `
            <tr>
                <td class="font-bold">🚐 ${v.name}</td>
                <td class="text-center">${v.orders}</td>
                <td class="text-center">${v.seats}</td>
                <td class="text-right font-bold">€${v.sum.toFixed(0)}</td>
            </tr>
        `).join('') || '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary);">Немає даних</td></tr>';
    
    document.getElementById('dashVehicleStats').innerHTML = vehicleStatsHtml;
    
    // 4. Постійні клієнти (групування по телефону)
    const clientsMap = {};
    active.forEach(p => {
        const phone = (p.phone || '').replace(/\D/g, '');
        if (!phone) return;
        
        if (!clientsMap[phone]) {
            clientsMap[phone] = { 
                phone: p.phone, 
                name: p.name || 'Невідомий', 
                trips: 0, 
                sum: 0 
            };
        }
        clientsMap[phone].trips++;
        const payment = parseFloat(String(p.payment || '0').replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
        clientsMap[phone].sum += payment;
        // Оновлюємо ім'я якщо є
        if (p.name && p.name.length > clientsMap[phone].name.length) {
            clientsMap[phone].name = p.name;
        }
    });
    
    const topClients = Object.values(clientsMap)
        .filter(c => c.trips >= 2) // Мінімум 2 поїздки
        .sort((a, b) => b.trips - a.trips || b.sum - a.sum)
        .slice(0, 10);
    
    const clientsHtml = topClients.length > 0 
        ? topClients.map(c => `
            <tr>
                <td>
                    <div class="font-bold">${c.name}</div>
                    <div style="font-size:10px;color:var(--text-secondary);">${c.phone}</div>
                </td>
                <td class="text-center font-bold">${c.trips}</td>
                <td class="text-right font-bold">€${c.sum.toFixed(0)}</td>
            </tr>
        `).join('')
        : '<tr><td colspan="3" style="text-align:center;color:var(--text-secondary);">Немає постійних клієнтів</td></tr>';
    
    document.getElementById('dashTopClients').innerHTML = clientsHtml;
}

// CALENDAR
function renderCalendars() { renderCalendarTo('desktopCalendar'); renderMobileCalendar(); renderCalendarTo('pcCalendar'); }
function renderMobileCalendar() { renderCalendarTo('mobileCalendar'); }

function renderCalendarTo(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const year = calendarDate.getFullYear(), month = calendarDate.getMonth();
    const months = ['Січень','Лютий','Березень','Квітень','Травень','Червень','Липень','Серпень','Вересень','Жовтень','Листопад','Грудень'];
    const today = new Date().toISOString().split('T')[0];
    
    // Рахуємо кількість МІСЦЬ (не лідів) на кожну дату
    const seatCounts = {};
    const leadCounts = {};
    passengers.filter(p => p.status !== 'archived').forEach(p => { 
        if(p.date) {
            leadCounts[p.date] = (leadCounts[p.date]||0) + 1;
            seatCounts[p.date] = (seatCounts[p.date]||0) + (parseInt(p.seats) || 1);
        }
    });
    
    // Загальна місткість всіх авто
    const totalCapacity = vehicles.reduce((sum, v) => sum + (parseInt(v.seats) || 8), 0);
    
    const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
    const startDay = (firstDay.getDay() + 6) % 7, daysInMonth = lastDay.getDate();
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    let daysHtml = '';
    
    // Дні попереднього місяця (блідо)
    for (let i = startDay - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        daysHtml += `<div class="calendar-day other-month">${day}</div>`;
    }
    
    // Дні поточного місяця
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const count = leadCounts[dateStr] || 0;
        const seats = seatCounts[dateStr] || 0;
        const isOverbooked = seats > totalCapacity;
        let cls = 'calendar-day';
        if (dateStr === today) cls += ' today';
        if (dateStr === filters.date) cls += ' selected';
        if (count > 0) cls += ' has-leads';
        if (isOverbooked) cls += ' overbooked';
        const tooltip = isOverbooked ? `title="⚠️ ${seats}/${totalCapacity} місць"` : '';
        daysHtml += `<div class="${cls}" onclick="selectDate('${dateStr}')" ${tooltip}>${day}${count ? `<span class="calendar-day-count">${count}</span>` : ''}</div>`;
    }
    
    // Дні наступного місяця (блідо)
    const totalCells = startDay + daysInMonth;
    const remainder = totalCells % 7;
    if (remainder > 0) {
        for (let i = 1; i <= 7 - remainder; i++) {
            daysHtml += `<div class="calendar-day other-month">${i}</div>`;
        }
    }
    
    container.innerHTML = `
        <div class="calendar-header">
            <div class="calendar-nav"><button onclick="event.stopPropagation();changeMonth(-1)">◀</button></div>
            <div class="calendar-title">${months[month]} ${year}</div>
            <div class="calendar-nav"><button onclick="event.stopPropagation();changeMonth(1)">▶</button></div>
        </div>
        <div class="calendar-weekdays">
            <div class="calendar-weekday">Пн</div>
            <div class="calendar-weekday">Вт</div>
            <div class="calendar-weekday">Ср</div>
            <div class="calendar-weekday">Чт</div>
            <div class="calendar-weekday">Пт</div>
            <div class="calendar-weekday">Сб</div>
            <div class="calendar-weekday">Нд</div>
        </div>
        <div class="calendar-days">${daysHtml}</div>
        <div class="calendar-actions">
            <button class="btn-clear" onclick="event.stopPropagation();selectDate('')">Скинути</button>
            <button class="btn-today" onclick="event.stopPropagation();goToday()">Сьогодні</button>
        </div>
    `;
}

function changeMonth(delta) { calendarDate.setMonth(calendarDate.getMonth() + delta); renderCalendars(); }
function goToday() { calendarDate = new Date(); selectDate(new Date().toISOString().split('T')[0]); }
function selectDate(dateStr) { 
    filters.date = dateStr; 
    filters.statusFilter = ''; 
    renderCalendars(); 
    render(); 
    updateFilterButtons(); 
    updateVehiclesList(); 
    document.getElementById('dateDropdown')?.classList.remove('show');
    
    // Перевірка на перевищення місткості
    if (dateStr) {
        checkCapacityWarning(dateStr);
    }
}

// Перевірка місткості на дату (при виборі)
function checkCapacityWarning(dateStr) {
    const totalCapacity = vehicles.reduce((sum, v) => sum + (parseInt(v.seats) || 8), 0);
    const seatsOnDate = passengers
        .filter(p => p.date === dateStr && p.status !== 'archived')
        .reduce((sum, p) => sum + (parseInt(p.seats) || 1), 0);
    
    if (seatsOnDate > totalCapacity) {
        const dateFormatted = new Date(dateStr).toLocaleDateString('uk-UA');
        showCapacityWarning(dateFormatted, seatsOnDate, totalCapacity);
    }
}

// Перевірка всіх дат на перевищення (при завантаженні та періодично)
function checkAllCapacityWarnings() {
    const totalCapacity = vehicles.reduce((sum, v) => sum + (parseInt(v.seats) || 8), 0);
    if (totalCapacity === 0) return;
    
    // Групуємо по датах
    const seatsByDate = {};
    passengers.filter(p => p.status !== 'archived' && p.date).forEach(p => {
        seatsByDate[p.date] = (seatsByDate[p.date] || 0) + (parseInt(p.seats) || 1);
    });
    
    // Шукаємо перевищення (тільки майбутні дати)
    const today = new Date().toISOString().split('T')[0];
    const overbooked = [];
    
    for (const [date, seats] of Object.entries(seatsByDate)) {
        if (date >= today && seats > totalCapacity) {
            overbooked.push({ date, seats, diff: seats - totalCapacity });
        }
    }
    
    // Показуємо сповіщення якщо є перевищення
    if (overbooked.length > 0) {
        showCapacityAlert(overbooked, totalCapacity);
    }
}

// Ненав'язливе сповіщення справа
function showCapacityAlert(overbooked, capacity) {
    // Видаляємо старе якщо є
    document.getElementById('capacityAlert')?.remove();
    
    const dates = overbooked.slice(0, 5).map(o => {
        const d = new Date(o.date);
        return `<div><strong>${d.toLocaleDateString('uk-UA')}</strong>: ${o.seats}/${capacity} (+${o.diff})</div>`;
    }).join('');
    
    const moreText = overbooked.length > 5 ? `<div style="margin-top:4px;font-size:10px;">...ще ${overbooked.length - 5} дат</div>` : '';
    
    const alert = document.createElement('div');
    alert.className = 'capacity-alert';
    alert.id = 'capacityAlert';
    alert.innerHTML = `
        <button class="capacity-alert-close" onclick="event.stopPropagation();this.parentElement.remove()">✕</button>
        <div class="capacity-alert-header">⚠️ Перевищення місткості!</div>
        <div class="capacity-alert-body">
            ${dates}
            ${moreText}
            <div style="margin-top:8px;font-size:11px;opacity:0.8;">Натисніть для деталей</div>
        </div>
    `;
    alert.onclick = (e) => {
        if (e.target.classList.contains('capacity-alert-close')) return;
        alert.remove();
        // Показуємо першу дату з перевищенням
        const first = overbooked[0];
        const dateFormatted = new Date(first.date).toLocaleDateString('uk-UA');
        showCapacityWarning(dateFormatted, first.seats, capacity);
    };
    
    document.body.appendChild(alert);
    
    // Автоматично ховаємо через 5 секунд
    setTimeout(() => alert?.remove(), 5000);
}

// Показати детальне попередження (модалка)
function showCapacityWarning(date, seats, capacity) {
    const diff = seats - capacity;
    document.getElementById('capacityWarningModal')?.remove();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'capacityWarningModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;">
            <div class="modal-header" style="background:#fee2e2;border-bottom:1px solid #fecaca;">
                <span class="modal-title" style="color:#dc2626;">⚠️ Перевищення місткості!</span>
                <button class="modal-close" onclick="document.getElementById('capacityWarningModal').remove()">✕</button>
            </div>
            <div class="modal-body" style="text-align:center;padding:24px;">
                <div style="font-size:48px;margin-bottom:16px;">🚐💥</div>
                <div style="font-size:16px;font-weight:700;margin-bottom:8px;">На ${date}</div>
                <div style="font-size:14px;color:var(--text-secondary);margin-bottom:16px;">
                    Заброньовано <strong style="color:#dc2626;">${seats}</strong> місць<br>
                    Доступно <strong style="color:var(--success);">${capacity}</strong> місць
                </div>
                <div style="background:#fef3c7;padding:12px;border-radius:8px;font-size:13px;color:#92400e;">
                    <strong>+${diff}</strong> зайвих місць!<br>
                    Додайте авто або відмовте клієнту
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('capacityWarningModal').remove()">Зрозуміло</button>
                <button class="btn-save" onclick="document.getElementById('capacityWarningModal').remove();openAddVehicleModal()">➕ Додати авто</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function updateMobileVehicles() {
    const el = document.getElementById('mobileVehiclesList');
    if (!el) return;
    el.innerHTML = vehicles.map(v => {
        const count = passengers.filter(p => p.vehicle === v.id && p.status !== 'archived').length;
        const active = filters.vehicle === v.id;
        return `<div class="side-menu-item ${active?'active':''}" onclick="mobileSetVehicle('${v.id}')"><span class="side-menu-item-left">🚐 ${v.name}</span><span class="side-menu-item-count">${count}</span></div>`;
    }).join('');
}

function mobileFilterAll() { filters.date=''; filters.vehicle=''; filters.showArchive=false; filters.statusFilter=''; closeSideMenu(); render(); updateAllCounts(); }
function mobileSetVehicle(id) { filters.vehicle = id; filters.statusFilter = ''; closeSideMenu(); render(); }

// DATA
function getFieldValue(p, key) {
    const v = vehicles.find(x => x.id === p.vehicle);
    const val = p[key];
    if (!val && val !== 0) return '';
    if (key === 'date' || key === 'dateReg') { 
        const d = new Date(val); 
        if (isNaN(d.getTime())) return val;
        // Формат DD.MM.YYYY
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}.${month}.${year}`;
    }
    if (key === 'payment') return '€' + val;
    if (key === 'percent') return val + '%';
    if (key === 'vehicle') return v ? v.name : '';
    if (key === 'seats') return val + ' м';
    if (key === 'weight') return val ? val + ' кг' : '';
    return val;
}

function getFilteredData() {
    let data = [...passengers];
    
    // Фільтр "Нові" - заявки за останні 24 години
    if (filters.showNewOnly) {
        const now = new Date();
        const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        // Фільтруємо по даті оформлення (dateReg) або isNew24h
        data = data.filter(p => {
            // Якщо є dateReg - перевіряємо чи за останні 24 год
            if (p.dateReg && p.dateReg >= yesterdayStr) return true;
            // Або якщо позначено як isNew24h
            if (p.isNew24h) return true;
            return false;
        });
        
        // Приховуємо закриті статуси
        const hiddenStatuses = ['archived', 'refused', 'transferred', 'deleted'];
        data = data.filter(p => !hiddenStatuses.includes(p.status));
    }
    // Спеціальний фільтр по статусу (archived, refused, transferred, deleted)
    else if (filters.specialStatus) {
        data = data.filter(p => p.status === filters.specialStatus);
    } else if (filters.showArchive) {
        data = data.filter(p => p.status === 'archived');
    } else {
        // Приховуємо всі "закриті" статуси в звичайному режимі
        const hiddenStatuses = ['archived', 'refused', 'transferred', 'deleted'];
        data = data.filter(p => !hiddenStatuses.includes(p.status));
    }
    
    if (!filters.showNewOnly && filters.direction && filters.direction !== 'all') data = data.filter(p => p.direction === filters.direction);
    if (filters.statusFilter) data = data.filter(p => p.status === filters.statusFilter);
    if (filters.routeVehicle) data = data.filter(p => p.vehicle === filters.routeVehicle);
    if (filters.search && filters.search.trim()) { 
        const s = filters.search.trim().toLowerCase();
        data = data.filter(p => {
            // Збираємо всі текстові поля в один рядок
            const searchStr = [
                p.id || '',
                p.name || '',
                p.phone || '',
                p.phoneReg || '',
                p.from || '',
                p.to || '',
                p.note || '',
                p.dispatcher || '',
                p.payment || '',
                p.mark || ''
            ].join(' ').toLowerCase();
            return searchStr.includes(s);
        }); 
    }
    if (!filters.showNewOnly && filters.date) data = data.filter(p => p.date === filters.date);
    if (filters.vehicle === 'none') {
        data = data.filter(p => !p.vehicle);
    } else if (filters.vehicle && !filters.routeVehicle) {
        // Знаходимо авто по ID
        const v = vehicles.find(x => x.id === filters.vehicle);
        const vName = v ? v.name : filters.vehicle;
        // Порівнюємо і по id і по name
        data = data.filter(p => p.vehicle === filters.vehicle || p.vehicle === vName);
    }
    
    // Фільтр по даті статусу (для архіву, відмов, тощо)
    if (filters.statusDateFrom) {
        data = data.filter(p => p.statusDate >= filters.statusDateFrom);
    }
    if (filters.statusDateTo) {
        data = data.filter(p => p.statusDate <= filters.statusDateTo);
    }
    
    return data.sort((a,b) => {
        // Нові (isNew) завжди зверху
        if (a.isNew && !b.isNew) return -1;
        if (!a.isNew && b.isNew) return 1;
        // Потім по даті статусу (для архіву/відмов - новіші зверху)
        if (filters.specialStatus && a.statusDate && b.statusDate) {
            return b.statusDate.localeCompare(a.statusDate);
        }
        // Потім по даті реєстрації (новіші зверху)
        const dateA = new Date(a.dateReg || '1970-01-01');
        const dateB = new Date(b.dateReg || '1970-01-01');
        if (dateB - dateA !== 0) return dateB - dateA;
        // Потім по order
        return (a.order||0) - (b.order||0);
    });
}

// Функція підсвічування пошукового запиту
function highlightSearch(text) {
    if (!text || !filters.search || !filters.search.trim()) return text;
    const search = filters.search.trim();
    const regex = new RegExp(`(${search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return String(text).replace(regex, '<span class="search-highlight">$1</span>');
}

function render() {
    const c = document.getElementById('cardsList');
    
    // Якщо це режим маршруту - рендеримо пасажирів з таблиці маршрутів
    if (filters.statusFilter === 'route' && filters.routeVehicle) {
        renderRoutePassengers();
        return;
    }
    
    let data = getFilteredData();
    updateFilterButtons();
    updateBulkBar();
    
    if (!data.length) { c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔍</div><div>Не знайдено</div></div>'; return; }
    
    const detailCols = colSettings.details;
    const isRouteView = filters.statusFilter === 'route';
    const canDrag = true; // Завжди дозволяємо перетягування
    const hasSearch = filters.search && filters.search.trim();
    
    c.innerHTML = data.map((p, idx) => {
        // Унікальний ключ для картки (sheet + rowNum)
        const uniqueKey = (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : `local_${idx}`;
        
        const sel = selectedIds.has(uniqueKey);
        const dOpen = openDetailsId === uniqueKey;
        const aOpen = openActionsId === uniqueKey;
        const veh = vehicles.find(v => v.id === p.vehicle || v.name === p.vehicle);
        const isArchived = p.status === 'archived';
        
        // Direction emoji
        const dirEmoji = p.direction === 'ua-eu' ? '🇺🇦→🇪🇺' : '🇪🇺→🇺🇦';
        
        // Format values з підсвічуванням
        const phoneDisplay = hasSearch ? highlightSearch(p.phone || '—') : (p.phone || '—');
        const seatsDisplay = p.seats || 1;
        const dateDisplay = p.date ? getFieldValue(p, 'date') : '—';
        const priceDisplay = p.payment ? '€' + p.payment : '';
        const routeFrom = hasSearch ? highlightSearch(p.from || '—') : (p.from || '—');
        const routeTo = hasSearch ? highlightSearch(p.to || '—') : (p.to || '—');
        const idDisplay = hasSearch ? highlightSearch(p.id || '—') : (p.id || '—');
        const nameDisplay = hasSearch ? highlightSearch(p.name || '—') : (p.name || '—');
        
        // Vehicle badge - просто відображення, без кліку
        const vehicleBadge = veh 
            ? `<span class="card-vehicle-badge">${veh.name}</span>` 
            : `<span class="card-vehicle-badge empty">—</span>`;
        
        // Details blocks з підсвічуванням
        const detailsHtml = detailCols.map(k => {
            let val = getFieldValue(p, k);
            if (hasSearch && val) val = highlightSearch(val);
            return `<div class="detail-block">
                <div class="detail-block-label">${ALL_COLUMNS[k]?.label || k}</div>
                <div class="detail-block-value ${!getFieldValue(p,k) ? 'empty' : ''}">${val || '—'}</div>
            </div>`;
        }).join('');
        
        // Order number for route view
        const orderNum = isRouteView ? `<span class="order-num">${idx + 1}</span>` : '';
        
        
        // Клас для не геокодованих карток
        const notGeocodedClass = p._notGeocoded ? 'not-geocoded-card' : '';
        
        return `<div class="lead-card status-${p.status} ${sel ? 'selected' : ''} ${notGeocodedClass}" data-uid="${uniqueKey}" data-id="${p.id}" draggable="true" ondragstart="handleDragStart(event,'${uniqueKey}')" ondragend="handleDragEnd(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event,'${uniqueKey}')">
            <div class="card-header">
                <div class="drag-handle"><span></span><span></span><span></span></div>
                <div class="card-checkbox-wrap">
                    <input type="checkbox" class="card-checkbox" ${sel ? 'checked' : ''} onclick="event.stopPropagation();toggleSelect('${uniqueKey}')">
                </div>
                <div class="card-body" onclick="toggleDetails('${uniqueKey}')">
                    <div class="card-top-row">
                        ${orderNum}
                        <span class="card-direction" title="${p.direction === 'ua-eu' ? 'Україна → Європа' : 'Європа → Україна'}">${dirEmoji}</span>
                        <span class="card-phone" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">${phoneDisplay}</span>
                        <span class="card-seats">👥 ${seatsDisplay}</span>
                        <span class="card-date">${dateDisplay}</span>
                        <span class="card-price">${priceDisplay}</span>
                    </div>
                    <div class="card-row2-wrap">
                        <div class="card-route-row">
                            <span class="card-route" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">${routeFrom} <span class="card-route-arrow">→</span> ${routeTo}</span>
                        </div>
                        <div class="card-info-row">
                            <span class="card-id" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">${idDisplay}</span>
                            <span class="card-name" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">${nameDisplay}</span>
                            ${p.isNew ? '<span class="new-tag">NEW</span>' : ''}
                        </div>
                    </div>
                </div>
                <div class="card-right-section">
                    <div class="card-vehicle">
                        ${vehicleBadge}
                    </div>
                    <button class="card-actions-toggle ${aOpen ? 'open' : ''}" onclick="event.stopPropagation();toggleActions('${uniqueKey}')">▼</button>
                </div>
            </div>
            <div class="card-details ${dOpen ? 'show' : ''}">
                <div class="details-grid">${detailsHtml || '<div style="text-align:center;color:var(--text-secondary);font-size:11px;">Немає додаткової інформації</div>'}</div>
            </div>
            <div class="card-actions ${aOpen ? 'show' : ''}">
                <button class="btn-card-action btn-call" onclick="event.stopPropagation();location.href='tel:${p.phone}'">📞 Дзвонити</button>
                <button class="btn-card-action btn-msg" onclick="event.stopPropagation();showToast('💬 Скоро!')">💬 Писати</button>
                <button class="btn-card-action btn-map" onclick="event.stopPropagation();openMapModal('${uniqueKey}')">🗺️ Карта</button>
                <button class="btn-card-action btn-edit" onclick="event.stopPropagation();editPassenger('${uniqueKey}')">✏️ Редагувати</button>
                <button class="btn-card-action btn-delete" onclick="event.stopPropagation();deletePassenger('${uniqueKey}')">🗑️ Видалити</button>
            </div>
        </div>`;
    }).join('');
}

// DRAG & DROP
function handleDragStart(e, id) { draggedId = id; e.target.classList.add('dragging'); }
function handleDragEnd(e) { e.target.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); draggedId = null; }
function handleDragOver(e) { e.preventDefault(); const card = e.target.closest('.lead-card'); if (card && card.dataset.id !== draggedId) { document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); card.classList.add('drag-over'); } }
function handleDrop(e, targetId) {
    e.preventDefault();
    if (!draggedId || draggedId === targetId) return;
    const data = getFilteredData();
    const dragIdx = data.findIndex(p => p.id === draggedId);
    const targetIdx = data.findIndex(p => p.id === targetId);
    if (dragIdx === -1 || targetIdx === -1) return;
    // Reorder
    data.forEach((p, i) => { const orig = passengers.find(x => x.id === p.id); if(orig) orig.order = i * 10; });
    const draggedP = passengers.find(p => p.id === draggedId);
    const targetP = passengers.find(p => p.id === targetId);
    if (draggedP && targetP) {
        const newOrder = dragIdx < targetIdx ? targetP.order + 1 : targetP.order - 1;
        draggedP.order = newOrder;
    }
    saveSettings();
    render();
    showToast('↕️ Порядок змінено');
}

// Хелпер: знайти пасажира по uniqueKey
function findPassengerByUid(uid) {
    if (!uid) return null;
    if (uid.startsWith('local_')) {
        const idx = parseInt(uid.replace('local_', ''));
        const data = getFilteredData();
        return data[idx] || null;
    }
    // uid = "sheet_rowNum"
    const parts = uid.split('_');
    const rowNum = parseInt(parts.pop());
    const sheet = parts.join('_');
    return passengers.find(p => p._sheet === sheet && p._rowNum === rowNum);
}

// SELECTION & BULK ACTIONS
function toggleDetails(uid) {
    const p = findPassengerByUid(uid);
    if (p?.isNew) { p.isNew = false; saveSettings(); }
    // Закриваємо дії інших карток
    if (openActionsId) {
        document.querySelector(`[data-uid="${openActionsId}"] .card-actions`)?.classList.remove('show');
        document.querySelector(`[data-uid="${openActionsId}"] .card-actions-toggle`)?.classList.remove('open');
        openActionsId = null;
    }
    if (openDetailsId && openDetailsId !== uid) document.querySelector(`[data-uid="${openDetailsId}"] .card-details`)?.classList.remove('show');
    openDetailsId = openDetailsId === uid ? null : uid;
    document.querySelector(`[data-uid="${uid}"] .card-details`)?.classList.toggle('show', openDetailsId === uid);
    document.querySelector(`[data-uid="${uid}"] .new-tag`)?.remove();
}

function toggleActions(uid) {
    // Закриваємо дії інших карток
    if (openActionsId && openActionsId !== uid) {
        document.querySelector(`[data-uid="${openActionsId}"] .card-actions`)?.classList.remove('show');
        document.querySelector(`[data-uid="${openActionsId}"] .card-actions-toggle`)?.classList.remove('open');
    }
    // Закриваємо деталі інших карток
    if (openDetailsId && openDetailsId !== uid) {
        document.querySelector(`[data-uid="${openDetailsId}"] .card-details`)?.classList.remove('show');
        openDetailsId = null;
    }
    openActionsId = openActionsId === uid ? null : uid;
    document.querySelector(`[data-uid="${uid}"] .card-actions`)?.classList.toggle('show', openActionsId === uid);
    document.querySelector(`[data-uid="${uid}"] .card-actions-toggle`)?.classList.toggle('open', openActionsId === uid);
}

function toggleSelect(uid) { 
    selectedIds.has(uid) ? selectedIds.delete(uid) : selectedIds.add(uid); 
    document.querySelector(`[data-uid="${uid}"]`)?.classList.toggle('selected', selectedIds.has(uid)); 
    updateBulkBar();
}

function toggleSelectAll() { 
    const data = getFilteredData(); 
    if (document.getElementById('selectAll').checked) {
        data.forEach(p => {
            const uid = (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : `local_${data.indexOf(p)}`;
            selectedIds.add(uid);
        });
    } else {
        selectedIds.clear();
    }
    render();
}

function clearSelection() { 
    selectedIds.clear(); 
    render(); 
    // Ховаємо sidebar тільки тут
    const sidebar = document.getElementById('bulkActionsSidebar');
    if (sidebar) sidebar.classList.remove('show');
    const bar = document.getElementById('bulkActionsBar');
    if (bar) bar.classList.remove('show');
    document.getElementById('bulkCount').textContent = 0;
    const sidebarCount = document.getElementById('bulkCountSidebar');
    if (sidebarCount) sidebarCount.textContent = 0;
    // Повертаємо collapse btn, контент і bottom-nav
    const collapseBtn = document.getElementById('pcSidebarCollapseBtn');
    if (collapseBtn) collapseBtn.style.display = '';
    const contentArea = document.querySelector('.main-content-area');
    if (contentArea) contentArea.classList.remove('shifted-by-bulk');
    const bottomNav = document.querySelector('.bottom-nav');
    if (bottomNav) {
        bottomNav.classList.remove('hidden-by-bulk');
        bottomNav.style.display = '';
    }
}

function switchToMenu() {
    // Ховаємо bulk sidebar, показуємо PC sidebar
    const bulk = document.getElementById('bulkActionsSidebar');
    if (bulk) bulk.classList.remove('show');
    const pcSidebar = document.getElementById('pcSidebar');
    if (pcSidebar) {
        pcSidebar.classList.remove('collapsed-sidebar');
        const btn = document.getElementById('pcSidebarCollapseBtn');
        if (btn) { btn.textContent = '◀'; btn.style.left = '300px'; btn.classList.remove('sidebar-hidden'); btn.style.display = ''; }
    }
    // Зсув контенту не потрібен — PC sidebar тепер видимий
    const contentArea = document.querySelector('.main-content-area');
    if (contentArea) contentArea.classList.remove('shifted-by-bulk');
}

function updateBulkBar() {
    const bar = document.getElementById('bulkActionsBar');
    const sidebar = document.getElementById('bulkActionsSidebar');
    const count = selectedIds.size;
    
    // Оновлюємо лічильники
    document.getElementById('bulkCount').textContent = count;
    const sidebarCount = document.getElementById('bulkCountSidebar');
    if (sidebarCount) sidebarCount.textContent = count;
    
    // Mobile bar - показуємо/ховаємо
    bar.classList.toggle('show', count > 0);
    
    // PC Sidebar - тільки ПОКАЗУЄМО, не ховаємо (ховає clearSelection)
    if (sidebar && count > 0) sidebar.classList.add('show');

    // Ховаємо collapse btn коли bulk sidebar відкритий
    const collapseBtn = document.getElementById('pcSidebarCollapseBtn');
    if (collapseBtn) collapseBtn.style.display = count > 0 ? 'none' : '';

    // Зсув контенту коли bulk sidebar відкритий
    const contentArea = document.querySelector('.main-content-area');
    if (contentArea) contentArea.classList.toggle('shifted-by-bulk', count > 0);

    // Ховаємо bottom-nav коли bulk sidebar відкритий
    const bottomNav = document.querySelector('.bottom-nav');
    if (bottomNav) {
        bottomNav.classList.toggle('hidden-by-bulk', count > 0);
        bottomNav.style.display = count > 0 ? 'none' : '';
    }
    
    const isRouteView = filters.statusFilter === 'route' && filters.routeVehicle;
    const isArchiveView = filters.showArchive;
    const isSpecialStatus = !!filters.specialStatus; // archived, refused, transferred, deleted
    const canRestore = isArchiveView || isSpecialStatus;
    const canDeleteForever = filters.specialStatus === 'deleted';
    
    // Mobile кнопки
    const restoreBtn = document.getElementById('btnBulkRestore');
    const notifyBtn = document.getElementById('btnBulkNotify');
    if (restoreBtn) restoreBtn.style.display = canRestore ? 'inline-flex' : 'none';
    if (notifyBtn) notifyBtn.style.display = isRouteView ? 'inline-flex' : 'none';
    
    // PC Sidebar кнопки
    const sidebarNotify = document.getElementById('btnSidebarNotify');
    const sidebarRestore = document.getElementById('btnSidebarRestore');
    const sidebarDeleteForever = document.getElementById('btnSidebarDeleteForever');
    if (sidebarNotify) sidebarNotify.style.display = isRouteView ? 'flex' : 'none';
    if (sidebarRestore) sidebarRestore.style.display = canRestore ? 'flex' : 'none';
    if (sidebarDeleteForever) sidebarDeleteForever.style.display = canDeleteForever ? 'flex' : 'none';
}

function handleSearch() { filters.search = document.getElementById('searchInput').value; render(); }

function updateAllCounts() {
    // Активні = без закритих статусів
    const hiddenStatuses = ['archived', 'refused', 'transferred', 'deleted'];
    const active = passengers.filter(p => !hiddenStatuses.includes(p.status));
    const archived = passengers.filter(p => p.status === 'archived');
    const refused = passengers.filter(p => p.status === 'refused');
    const transferred = passengers.filter(p => p.status === 'transferred');
    const deleted = passengers.filter(p => p.status === 'deleted');
    const inRoute = active.filter(p => p.status === 'route');
    const noVehicle = active.filter(p => !p.vehicle);
    const uaEu = active.filter(p => p.direction === 'ua-eu');
    const euUa = active.filter(p => p.direction === 'eu-ua');
    
    // Нові заявки за останні 24 години
    const now = new Date();
    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    const yesterdayStr = yesterday.toISOString().split('T')[0];
    const newLeads = active.filter(p => (p.dateReg && p.dateReg >= yesterdayStr) || p.isNew24h);
    
    document.getElementById('countAll').textContent = active.length;
    // countRoute оновлюється через updateAllRoutesCount() API
    document.getElementById('countArchive').textContent = archived.length;
    document.getElementById('countNoVehicle').textContent = noVehicle.length;
    
    // Лічильники в popup напрямків
    const dAll = document.getElementById('countDirAll');
    const dUaEu = document.getElementById('countDirUaEu');
    const dEuUa = document.getElementById('countDirEuUa');
    if (dAll) dAll.textContent = active.length;
    if (dUaEu) dUaEu.textContent = uaEu.length;
    if (dEuUa) dEuUa.textContent = euUa.length;
    
    // Мобільні лічильники
    const mAll = document.getElementById('mobileCountAll');
    const mNew = document.getElementById('mobileCountNew');
    // mobileCountRoute оновлюється через updateAllRoutesCount() API
    const mArch = document.getElementById('mobileCountArchive');
    const mNoVeh = document.getElementById('mobileCountNoVehicle');
    const mUaEu = document.getElementById('mobileCountUaEu');
    const mEuUa = document.getElementById('mobileCountEuUa');
    const mRefused = document.getElementById('mobileCountRefused');
    const mTransferred = document.getElementById('mobileCountTransferred');
    const mDeleted = document.getElementById('mobileCountDeleted');
    if (mAll) mAll.textContent = active.length;
    if (mNew) mNew.textContent = newLeads.length;
    // НЕ перезаписуємо mobileCountRoute - він оновлюється через API
    if (mArch) mArch.textContent = archived.length;
    if (mNoVeh) mNoVeh.textContent = noVehicle.length;
    if (mUaEu) mUaEu.textContent = uaEu.length;
    if (mEuUa) mEuUa.textContent = euUa.length;
    if (mRefused) mRefused.textContent = refused.length;
    if (mTransferred) mTransferred.textContent = transferred.length;
    if (mDeleted) mDeleted.textContent = deleted.length;
    
    // PC Sidebar лічильники
    const pcAll = document.getElementById('pcCountAll');
    const pcNew = document.getElementById('pcCountNew');
    const pcUaEu = document.getElementById('pcCountUaEu');
    const pcEuUa = document.getElementById('pcCountEuUa');
    const pcNoVeh = document.getElementById('pcCountNoVehicle');
    const pcRoute = document.getElementById('pcCountRoute');
    const pcArch = document.getElementById('pcCountArchive');
    const pcRefused = document.getElementById('pcCountRefused');
    const pcTransferred = document.getElementById('pcCountTransferred');
    const pcDeleted = document.getElementById('pcCountDeleted');
    if (pcAll) pcAll.textContent = active.length;
    if (pcNew) pcNew.textContent = newLeads.length;
    if (pcUaEu) pcUaEu.textContent = uaEu.length;
    if (pcEuUa) pcEuUa.textContent = euUa.length;
    if (pcNoVeh) pcNoVeh.textContent = noVehicle.length;
    if (pcRoute) pcRoute.textContent = inRoute.length;
    if (pcArch) pcArch.textContent = archived.length;
    if (pcRefused) pcRefused.textContent = refused.length;
    if (pcTransferred) pcTransferred.textContent = transferred.length;
    if (pcDeleted) pcDeleted.textContent = deleted.length;
    
    // Dashboard лічильники
    const dashArch = document.getElementById('dashArchived');
    const dashRefused = document.getElementById('dashRefused');
    const dashTransferred = document.getElementById('dashTransferred');
    const dashDeleted = document.getElementById('dashDeleted');
    if (dashArch) dashArch.textContent = archived.length;
    if (dashRefused) dashRefused.textContent = refused.length;
    if (dashTransferred) dashTransferred.textContent = transferred.length;
    if (dashDeleted) dashDeleted.textContent = deleted.length;
    
    // Оновлюємо списки маршрутів та авто
    updateRoutesList();
    updatePcVehiclesList();
}

// Оновлення списку авто в PC Sidebar
function updatePcVehiclesList() {
    const container = document.getElementById('pcVehiclesList');
    if (!container) return;
    
    container.innerHTML = vehicles.map(v => {
        const count = passengers.filter(p => (p.vehicle === v.id || p.vehicle === v.name) && p.status !== 'archived').length;
        const isActive = filters.vehicle === v.id;
        return `<div class="pc-sidebar-item ${isActive ? 'active' : ''}" style="display:flex;justify-content:space-between;align-items:center;">
            <div onclick="setVehicleFilter('${v.id}')" style="flex:1;cursor:pointer;">
                <span class="item-icon">🚐</span>${v.name}
            </div>
            <span class="item-count" style="margin-right:8px;">${count}</span>
            <button onclick="event.stopPropagation();deleteVehicle('${v.id}')" style="background:none;border:none;cursor:pointer;font-size:12px;opacity:0.5;padding:4px;" title="Видалити авто">🗑️</button>
        </div>`;
    }).join('');
}

// ROUTES LIST - оновлюємо з реальними даними з таблиці
function updateRoutesList() {
    // Спочатку показуємо з локальними даними
    renderRoutesListLocal();
    
    // Потім асинхронно оновлюємо з API
    vehicles.forEach(v => {
        fetch(ROUTE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                action: 'getRoutePassengers',
                payload: { vehicleName: v.name }
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Оновлюємо badge в desktop dropdown
                const desktopBadge = document.querySelector(`#routesList [data-vehicle="${v.id}"] .badge`);
                if (desktopBadge) {
                    desktopBadge.textContent = data.stats.total;
                    desktopBadge.style.background = data.stats.total > 0 ? 'var(--success)' : 'var(--border)';
                    desktopBadge.style.color = data.stats.total > 0 ? 'white' : 'var(--text-secondary)';
                }
                
                // Оновлюємо badge в mobile menu
                const mobileBadge = document.querySelector(`#mobileRoutesList [data-vehicle="${v.id}"] .side-menu-item-count`);
                if (mobileBadge) {
                    mobileBadge.textContent = data.stats.total;
                }
                
                // Оновлюємо badge в PC sidebar
                const pcBadge = document.querySelector(`#pcRoutesList [data-vehicle="${v.id}"] .item-count`);
                if (pcBadge) {
                    pcBadge.textContent = data.stats.total;
                }
            }
        })
        .catch(() => {});
    });
}

// Рендер списку маршрутів з локальними даними (швидко)
function renderRoutesListLocal() {
    const routesHtml = vehicles.map(v => {
        const count = passengers.filter(p => (p.vehicle === v.id || p.vehicle === v.name) && p.status === 'route').length;
        return `<div class="dropdown-item" data-vehicle="${v.id}" onclick="showVehicleRoute('${v.id}')">
            <span>🚐 ${v.name}</span>
            <span class="badge" style="background:${count > 0 ? 'var(--success)' : 'var(--border)'};color:${count > 0 ? 'white' : 'var(--text-secondary)'}">${count}</span>
        </div>`;
    }).join('');
    
    const routesList = document.getElementById('routesList');
    if (routesList) routesList.innerHTML = routesHtml;
    
    // Mobile routes
    const mobileRoutesHtml = vehicles.map(v => {
        const count = passengers.filter(p => (p.vehicle === v.id || p.vehicle === v.name) && p.status === 'route').length;
        return `<div class="side-menu-item route ${filters.routeVehicle === v.id ? 'active' : ''}" data-vehicle="${v.id}" onclick="showVehicleRoute('${v.id}'); closeSideMenu();">
            <span class="side-menu-item-left">🚐 ${v.name}</span>
            <span class="side-menu-item-count">${count}</span>
        </div>`;
    }).join('');
    
    const mobileRoutesList = document.getElementById('mobileRoutesList');
    if (mobileRoutesList) mobileRoutesList.innerHTML = mobileRoutesHtml;
    
    // PC Sidebar routes
    const pcRoutesHtml = vehicles.map(v => {
        const count = passengers.filter(p => (p.vehicle === v.id || p.vehicle === v.name) && p.status === 'route').length;
        const isActive = filters.routeVehicle === v.id;
        return `<div class="pc-sidebar-item route ${isActive ? 'active' : ''}" data-vehicle="${v.id}" onclick="showVehicleRoute('${v.id}')">
            <span><span class="item-icon">🚐</span>${v.name}</span>
            <span class="item-count">${count}</span>
        </div>`;
    }).join('');
    
    const pcRoutesList = document.getElementById('pcRoutesList');
    if (pcRoutesList) pcRoutesList.innerHTML = pcRoutesHtml;
    
    // Оновлюємо лічильник "Всі маршрути" через API
    updateAllRoutesCount();
}

// Оновлення лічильника "Всі маршрути" через API
async function updateAllRoutesCount() {
    try {
        const response = await fetch(ROUTE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'getAvailableRoutes' })
        });
        const data = await response.json();
        
        if (data.success && data.routes) {
            // Фільтруємо: тільки аркуші маршрутів (ігноруємо логи, розсилка тощо)
            const validRoutes = data.routes.filter(r => isRouteSheet(r.name));
            // Рахуємо суму всіх записів
            const totalCount = validRoutes.reduce((sum, r) => sum + (r.count || 0), 0);
            
            // Оновлюємо всі лічильники "Всі маршрути"
            const countRoute = document.getElementById('countRoute');
            const pcCount = document.getElementById('pcCountRoute');
            const mobileCount = document.getElementById('mobileCountRoute');
            
            if (countRoute) countRoute.textContent = totalCount;
            if (pcCount) pcCount.textContent = totalCount;
            if (mobileCount) mobileCount.textContent = totalCount;
        }
    } catch (err) {
        console.error('Error updating all routes count:', err);
    }
}

function showAllRoutes() {
    // Показати всі маршрути - завантажуємо всі авто
    filters.statusFilter = 'route';
    filters.routeVehicle = 'all';
    filters.showArchive = false;
    document.getElementById('routeDropdown')?.classList.remove('show');
    closeSideMenu();
    
    // Завантажуємо всі маршрути (loader всередині функції)
    loadAllRoutePassengers();
}

function showVehicleRoute(vehicleId) {
    const v = vehicles.find(x => x.id === vehicleId);
    if (!v) return showToast('❌ Авто не знайдено');
    
    filters.statusFilter = 'route';
    filters.routeVehicle = vehicleId;
    filters.showArchive = false;
    document.getElementById('routeDropdown')?.classList.remove('show');
    closeSideMenu();
    
    showLoader(`Завантаження: ${v.name}`, '');
    
    // Завантажуємо дані з таблиці маршрутів + статус розсилки
    Promise.all([
        fetch(ROUTE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                action: 'getRoutePassengers',
                payload: { vehicleName: v.name }
            })
        }).then(r => r.json()),
        fetch(ROUTE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'getMailingStatus' })
        }).then(r => r.json())
    ])
    .then(([routeData, mailingData]) => {
        hideLoader();
        
        // Зберігаємо mailingIds
        if (mailingData.success) {
            mailingIds = mailingData.mailingIds || [];
        }
        
        if (routeData.success) {
            // Зберігаємо дані маршруту
            routePassengers = routeData.passengers.map((p, idx) => ({
                ...p,
                _uid: `route_${v.id}_${idx}`,
                _isRouteData: true,
                _vehicleId: v.id,
                _vehicleName: v.name
            }));
            routeStats = routeData.stats;
            currentRouteVehicle = v;
            
            // Рендеримо
            renderRoutePassengers();
            updateFilterButtons();
            showToast(`🚐 ${v.name}: ${routeData.stats.total} пасажирів`);
        } else {
            showToast('❌ ' + routeData.error);
        }
    })
    .catch(err => {
        hideLoader();
        console.error('Route load error:', err);
        showToast('❌ Помилка завантаження');
    });
}

// Завантажити всі маршрути
async function loadAllRoutePassengers() {
    routePassengers = [];
    routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0, notified: 0, notNotified: 0 };
    currentRouteVehicle = null;
    
    // Показуємо loader
    showLoader('Завантаження маршрутів...', '');
    
    // Паралельно завантажуємо: статус розсилки + список маршрутів
    try {
        const [mailingResponse, routesResponse] = await Promise.all([
            fetch(ROUTE_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'getMailingStatus' })
            }).then(r => r.json()).catch(() => ({ success: false })),
            fetch(ROUTE_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'getAvailableRoutes' })
            }).then(r => r.json()).catch(() => ({ success: false }))
        ]);
        
        // Зберігаємо mailingIds
        if (mailingResponse.success) {
            mailingIds = mailingResponse.mailingIds || [];
        }
        
        if (routesResponse.success && routesResponse.routes && routesResponse.routes.length > 0) {
            // Фільтруємо: тільки аркуші маршрутів (ігноруємо логи, розсилка тощо)
            const routes = routesResponse.routes.filter(r => isRouteSheet(r.name));
            if (routes.length === 0) {
                hideLoader();
                renderRoutePassengers();
                updateFilterButtons();
                showToast('📋 Маршрутів не знайдено');
                return;
            }
            updateLoader('Завантаження пасажирів...', `0 / ${routes.length}`);
            
            // Паралельно завантажуємо ВСІ маршрути одночасно
            const routePromises = routes.map(route => 
                fetch(ROUTE_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'getRoutePassengers',
                        payload: { sheetName: route.name }
                    })
                })
                .then(r => r.json())
                .then(data => ({ route, data }))
                .catch(err => ({ route, data: { success: false, error: err } }))
            );
            
            // Чекаємо всі результати
            const results = await Promise.all(routePromises);
            
            // Обробляємо результати
            let loaded = 0;
            for (const { route, data } of results) {
                loaded++;
                updateLoader(`Обробка: ${route.name}`, `${loaded} / ${routes.length}`);
                
                if (data.success && data.passengers && data.passengers.length > 0) {
                    // Знаходимо відповідне авто (точний збіг по routeSheet або name)
                    const matchedVehicle = vehicles.find(v =>
                        v.routeSheet === route.name ||
                        v.name === route.name
                    );

                    // Якщо не знайшли точний збіг - шукаємо по включенню
                    const finalVehicle = matchedVehicle || vehicles.find(v =>
                        route.name.includes(v.name)
                    );

                    // Фільтруємо тільки валідних пасажирів (мають хоча б телефон або ім'я)
                    const validPassengers = data.passengers.filter(p =>
                        (p.phone && p.phone.trim()) || (p.name && p.name.trim()) || (p.id && p.id.trim())
                    );

                    const mapped = validPassengers.map((p, idx) => ({
                        ...p,
                        _uid: `route_${route.name.replace(/\s+/g, '_')}_${idx}`,
                        _isRouteData: true,
                        _vehicleId: finalVehicle?.id || route.name,
                        _vehicleName: finalVehicle?.name || route.name
                    }));
                    routePassengers = routePassengers.concat(mapped);
                    
                    // Додаємо статистику
                    if (data.stats) {
                        routeStats.total += data.stats.total || 0;
                        routeStats.pending += data.stats.pending || 0;
                        routeStats.inProgress += data.stats.inProgress || 0;
                        routeStats.completed += data.stats.completed || 0;
                        routeStats.cancelled += data.stats.cancelled || 0;
                        routeStats.archived += data.stats.archived || 0;
                    }
                }
            }
        }
    } catch (err) {
        console.error('Error loading routes:', err);
    }
    
    hideLoader();
    renderRoutePassengers();
    updateFilterButtons();
    showToast(`📋 Всі маршрути: ${routeStats.total} пасажирів`);
}

// Loader functions
function showLoader(text, progress) {
    document.getElementById('loaderText').textContent = text || 'Завантаження...';
    document.getElementById('loaderProgress').textContent = progress || '';
    document.getElementById('globalLoader').classList.add('show');
}
function updateLoader(text, progress) {
    if (text) document.getElementById('loaderText').textContent = text;
    if (progress !== undefined) document.getElementById('loaderProgress').textContent = progress;
}
function hideLoader() {
    document.getElementById('globalLoader').classList.remove('show');
}

// Глобальні змінні для маршрутів
let routePassengers = [];
let routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0, notified: 0, notNotified: 0 };
let currentRouteVehicle = null;
let routeStatusFilter = 'all'; // Фільтр по статусу в маршруті
let mailingIds = []; // ІД тих хто отримав розсилку

// Рендер пасажирів маршруту в основному списку
function renderRoutePassengers() {
    const container = document.getElementById('cardsList');
    if (!container) return;
    
    // Скролимо до верху
    container.scrollTop = 0;
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    updateBulkBar();
    
    if (routePassengers.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:40px;color:var(--text-secondary);">
                <div style="font-size:48px;margin-bottom:12px;">📭</div>
                <div style="font-size:14px;font-weight:600;">Маршрут порожній</div>
                <div style="font-size:12px;margin-top:8px;">Додайте пасажирів через кнопку "🚀 Маршрут"</div>
            </div>
        `;
        return;
    }
    
    // Фільтруємо по статусу
    let filteredPassengers = routePassengers;
    if (routeStatusFilter === 'not-notified') {
        filteredPassengers = routePassengers.filter(p => !mailingIds.includes(String(p.id)));
    } else if (routeStatusFilter === 'notified') {
        filteredPassengers = routePassengers.filter(p => mailingIds.includes(String(p.id)));
    } else if (routeStatusFilter !== 'all') {
        filteredPassengers = routePassengers.filter(p => p.driverStatus === routeStatusFilter);
    }
    
    // Рахуємо сповіщення
    const notifiedCount = routePassengers.filter(p => mailingIds.includes(String(p.id))).length;
    const notNotifiedCount = routePassengers.length - notifiedCount;
    routeStats.notified = notifiedCount;
    routeStats.notNotified = notNotifiedCount;
    
    let html = '';
    
    // Статистика зверху - клікабельна, адаптивна
    html += `
        <div class="route-stats-box">
            <div class="route-stats-grid">
                <div class="route-stat-item ${routeStatusFilter === 'all' ? 'active' : ''}" onclick="filterRouteByStatus('all')">
                    <div class="route-stat-num">${routeStats.total}</div>
                    <div class="route-stat-label">Всього</div>
                </div>
                <div class="route-stat-item ${routeStatusFilter === 'pending' ? 'active pending' : ''}" onclick="filterRouteByStatus('pending')" style="${routeStatusFilter !== 'pending' ? 'color:#6c757d;' : ''}">
                    <div class="route-stat-num">${routeStats.pending}</div>
                    <div class="route-stat-label">⏳ Очікує</div>
                </div>
                <div class="route-stat-item ${routeStatusFilter === 'in-progress' ? 'active in-progress' : ''}" onclick="filterRouteByStatus('in-progress')" style="${routeStatusFilter !== 'in-progress' ? 'color:#007bff;' : ''}">
                    <div class="route-stat-num">${routeStats.inProgress}</div>
                    <div class="route-stat-label">🔄 В дорозі</div>
                </div>
                <div class="route-stat-item ${routeStatusFilter === 'completed' ? 'active completed' : ''}" onclick="filterRouteByStatus('completed')" style="${routeStatusFilter !== 'completed' ? 'color:#28a745;' : ''}">
                    <div class="route-stat-num">${routeStats.completed}</div>
                    <div class="route-stat-label">✅ Готово</div>
                </div>
                <div class="route-stat-item ${routeStatusFilter === 'cancelled' ? 'active cancelled' : ''}" onclick="filterRouteByStatus('cancelled')" style="${routeStatusFilter !== 'cancelled' ? 'color:#dc3545;' : ''}">
                    <div class="route-stat-num">${routeStats.cancelled}</div>
                    <div class="route-stat-label">❌ Відмова</div>
                </div>
                <div class="route-stat-item ${routeStatusFilter === 'not-notified' ? 'active not-notified' : ''}" onclick="filterRouteByStatus('not-notified')" style="${routeStatusFilter !== 'not-notified' ? 'color:#f97316;' : ''}">
                    <div class="route-stat-num">${notNotifiedCount}</div>
                    <div class="route-stat-label">🔔 Не спов.</div>
                </div>
            </div>
            ${currentRouteVehicle ? `<div style="text-align:center;margin-top:10px;"><button onclick="showVehicleRoute('${currentRouteVehicle.id}')" style="padding:8px 20px;border:none;border-radius:6px;background:var(--info);color:white;font-weight:600;cursor:pointer;font-size:12px;">🔄 Оновити</button></div>` : ''}
        </div>
    `;
    
    if (filteredPassengers.length === 0) {
        html += `<div style="text-align:center;padding:30px;color:var(--text-secondary);">Немає записів з цим статусом</div>`;
        container.innerHTML = html;
        return;
    }
    
    // Картки пасажирів - використовуємо стандартний стиль lead-card
    filteredPassengers.forEach((p, idx) => {
        // Визначаємо клас по статусу водія
        let statusClass = '';
        let statusBadge = '<span class="status-badge pending">⏳ Очікує</span>';
        
        if (p.driverStatus === 'completed') {
            statusClass = 'driver-completed';
            statusBadge = '<span class="status-badge completed">✅ Готово</span>';
        } else if (p.driverStatus === 'in-progress') {
            statusClass = 'driver-in-progress';
            statusBadge = '<span class="status-badge in-progress">🔄 В дорозі</span>';
        } else if (p.driverStatus === 'cancelled') {
            statusClass = 'driver-cancelled';
            statusBadge = '<span class="status-badge cancelled">❌ Відмова</span>';
        } else if (p.driverStatus === 'archived') {
            statusClass = 'driver-archived';
            statusBadge = '<span class="status-badge archived">📦 Архів</span>';
        }
        
        // Перевіряємо чи сповіщений
        const isNotified = mailingIds.includes(String(p.id));
        const notifyBadge = isNotified 
            ? '<span style="background:#f97316;color:white;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600;">🔔 Сповіщено</span>' 
            : '';
        const notifyClass = isNotified ? 'is-notified' : '';
        
        const veh = vehicles.find(v => v.id === p._vehicleId || v.name === p._vehicleName);
        const vehicleBadge = veh 
            ? `<span class="card-vehicle-badge">${veh.name}</span>` 
            : `<span class="card-vehicle-badge">${p._vehicleName || '?'}</span>`;
        
        const isSelected = selectedIds.has(p._uid);
        
        html += `
            <div class="lead-card ${statusClass} ${notifyClass} ${isSelected ? 'selected' : ''}" data-uid="${p._uid}">
                <div class="card-header" onclick="toggleRouteCardDetails('${p._uid}')">
                    <div class="card-checkbox-wrap">
                        <input type="checkbox" class="card-checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation();toggleSelect('${p._uid}')">
                        <span class="route-order-num">${idx + 1}</span>
                    </div>
                    <div class="card-body">
                        <div class="card-top-row">
                            <span class="card-phone">${p.phone || '—'}</span>
                            <span class="card-seats">👥 ${p.seats || 1}</span>
                            <span class="card-date">${p.date || '—'}</span>
                            ${p.payment ? `<span class="card-price">💰 ${p.payment}</span>` : ''}
                        </div>
                        <div class="card-row2-wrap">
                            <div class="card-route-row">
                                <span class="card-route">${p.from || '?'} <span class="card-route-arrow">→</span> ${p.to || '?'}</span>
                            </div>
                            <div class="card-info-row">
                                <span class="card-id">${p.id || '—'}</span>
                                <span class="card-name">${p.name || '—'}</span>
                            </div>
                        </div>
                        <div style="margin-top:6px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                            ${statusBadge}
                            ${notifyBadge}
                            ${p.timing ? `<span style="font-size:10px;color:#666;">⏰ ${p.timing}</span>` : ''}
                        </div>
                        ${p.note ? `<div style="font-size:10px;color:#666;margin-top:4px;font-style:italic;">📝 ${p.note}</div>` : ''}
                    </div>
                    <div class="card-right-section">
                        <div class="card-vehicle">
                            ${vehicleBadge}
                        </div>
                        <button class="card-actions-toggle" onclick="event.stopPropagation();toggleRouteActions('${p._uid}')">▼</button>
                    </div>
                </div>
                <div class="card-details" id="details_${p._uid}" style="display:none;">
                    <div class="details-grid">
                        <div class="detail-item"><span class="detail-label">📞 Телефон</span><span class="detail-value">${p.phone || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">📞 Реєстратор</span><span class="detail-value">${p.phoneReg || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">👤 ПІБ</span><span class="detail-value">${p.name || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">👥 Місць</span><span class="detail-value">${p.seats || 1}</span></div>
                        <div class="detail-item"><span class="detail-label">📍 Звідки</span><span class="detail-value">${p.from || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">📍 Куди</span><span class="detail-value">${p.to || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">💰 Оплата</span><span class="detail-value">${p.payment || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">📊 Відсоток</span><span class="detail-value">${p.percent || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">⏰ Таймінг</span><span class="detail-value">${p.timing || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">📅 Дата виїзду</span><span class="detail-value">${p.date || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">👨‍💼 Диспетчер</span><span class="detail-value">${p.dispatcher || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">⚖️ Вага</span><span class="detail-value">${p.weight || '—'}</span></div>
                    </div>
                    ${p.note ? `<div class="detail-note"><span class="detail-label">📝 Примітка</span><div>${p.note}</div></div>` : ''}
                </div>
                <div class="card-actions" id="actions_${p._uid}" style="display:none;">
                    <button class="btn-card-action btn-call" onclick="event.stopPropagation();location.href='tel:${p.phone}'">📞 Дзвонити</button>
                    <button class="btn-card-action btn-map" onclick="event.stopPropagation();openRouteMap('${encodeURIComponent(p.from || '')}','${encodeURIComponent(p.to || '')}')">🗺️ Карта</button>
                    <button class="btn-card-action btn-delete" onclick="event.stopPropagation();showRouteDeleteChoice('${p._uid}')">🗑️ Видалити</button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Фільтр по статусу в маршруті
function filterRouteByStatus(status) {
    routeStatusFilter = status;
    renderRoutePassengers();
}

// Розгортання деталей картки маршруту
function toggleRouteCardDetails(uid) {
    const details = document.getElementById('details_' + uid);
    const card = details?.closest('.lead-card');
    if (!details || !card) return;

    const isOpen = details.style.display !== 'none';

    // Закриваємо всі інші деталі
    document.querySelectorAll('.card-details').forEach(d => {
        d.style.display = 'none';
        d.closest('.lead-card')?.classList.remove('expanded');
    });

    // Відкриваємо/закриваємо поточну
    if (!isOpen) {
        details.style.display = 'block';
        card.classList.add('expanded');
    }
}

// Розгортання дій картки маршруту (▼ кнопка)
function toggleRouteActions(uid) {
    const actions = document.getElementById('actions_' + uid);
    const card = actions?.closest('.lead-card');
    if (!actions || !card) return;

    const isOpen = actions.style.display !== 'none';

    // Закриваємо всі інші дії
    document.querySelectorAll('.card-actions[id^="actions_route"]').forEach(a => {
        a.style.display = 'none';
        a.closest('.lead-card')?.querySelector('.card-actions-toggle')?.classList.remove('open');
    });

    // Відкриваємо/закриваємо поточну
    if (!isOpen) {
        actions.style.display = 'grid';
        card.querySelector('.card-actions-toggle')?.classList.add('open');
    }
}

// Відкрити Google Maps для маршрутного пасажира
function openRouteMap(fromEncoded, toEncoded) {
    const from = decodeURIComponent(fromEncoded);
    const to = decodeURIComponent(toEncoded);
    if (from && to) {
        window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from)}&destination=${encodeURIComponent(to)}`, '_blank');
    } else if (from) {
        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(from)}`, '_blank');
    } else if (to) {
        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(to)}`, '_blank');
    } else {
        showToast('⚠️ Немає адреси');
    }
}

// Вибір типу видалення в маршруті
function showRouteDeleteChoice(uid) {
    const p = routePassengers.find(rp => rp._uid === uid);
    if (!p) return;

    document.getElementById('routeDeleteChoiceModal')?.remove();

    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'routeDeleteChoiceModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:380px;">
            <div class="modal-header" style="background:#fee2e2;border-bottom:1px solid #fecaca;">
                <span class="modal-title" style="color:#dc2626;">🗑️ Видалити</span>
                <button class="modal-close" onclick="document.getElementById('routeDeleteChoiceModal').remove()">✕</button>
            </div>
            <div class="modal-body" style="padding:20px;">
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:600;">${p.name || 'Без імені'}</div>
                    <div style="font-size:12px;color:var(--text-secondary);">${p.phone || '—'}</div>
                </div>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <button onclick="deleteFromRouteOnly('${uid}')" style="padding:14px;border:none;border-radius:10px;background:#f59e0b;color:white;font-weight:600;font-size:13px;cursor:pointer;">
                        📋 Видалити з маршруту<br>
                        <span style="font-size:11px;font-weight:400;opacity:0.9;">Лід залишиться в головному списку</span>
                    </button>
                    <button onclick="deleteFromRouteAndTrash('${uid}')" style="padding:14px;border:none;border-radius:10px;background:#dc2626;color:white;font-weight:600;font-size:13px;cursor:pointer;">
                        🗑️ Видалити в корзину<br>
                        <span style="font-size:11px;font-weight:400;opacity:0.9;">Лід буде архівовано</span>
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Видалити тільки з маршруту (лід залишається в основному списку)
function deleteFromRouteOnly(uid) {
    document.getElementById('routeDeleteChoiceModal')?.remove();
    const p = routePassengers.find(rp => rp._uid === uid);
    if (!p) return;

    const sheetName = currentRouteVehicle?.routeSheet || p._vehicleName;
    if (!sheetName) return showToast('❌ Невідомий аркуш маршруту');

    showRouteProgress('Видаляю з маршруту...');

    fetch(ROUTE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'deleteRoutePassenger',
            payload: { sheetName: sheetName, rowNum: p.rowNum }
        })
    })
    .then(r => r.json())
    .then(data => {
        hideRouteProgress();
        if (data.success) {
            // Видаляємо з локального масиву
            routePassengers = routePassengers.filter(rp => rp._uid !== uid);
            routeStats.total = routePassengers.length;
            renderRoutePassengers();
            updateAllCounts();
            showToast('📋 Видалено з маршруту');
        } else {
            showToast('❌ ' + (data.error || 'Помилка'));
        }
    })
    .catch(err => {
        hideRouteProgress();
        console.error('deleteFromRouteOnly error:', err);
        showToast('❌ Помилка видалення');
    });
}

// Видалити з маршруту + в архів (корзину)
function deleteFromRouteAndTrash(uid) {
    document.getElementById('routeDeleteChoiceModal')?.remove();
    const p = routePassengers.find(rp => rp._uid === uid);
    if (!p) return;

    const sheetName = currentRouteVehicle?.routeSheet || p._vehicleName;
    if (!sheetName) return showToast('❌ Невідомий аркуш маршруту');

    showRouteProgress('Видаляю...');

    // 1) Видаляємо з маршруту
    fetch(ROUTE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'deleteRoutePassenger',
            payload: { sheetName: sheetName, rowNum: p.rowNum }
        })
    })
    .then(r => r.json())
    .then(data => {
        // 2) Архівуємо в головному списку
        const mainPassenger = passengers.find(mp => String(mp.id) === String(p.id));
        if (mainPassenger) {
            mainPassenger.status = 'archived';
            mainPassenger.archiveDate = new Date().toISOString().split('T')[0];
            updatePassengerOnServer(mainPassenger);
            saveSettings();
        }

        hideRouteProgress();
        // Видаляємо з локального масиву маршруту
        routePassengers = routePassengers.filter(rp => rp._uid !== uid);
        routeStats.total = routePassengers.length;
        renderRoutePassengers();
        updateAllCounts();
        showToast('🗑️ Видалено в корзину');
    })
    .catch(err => {
        hideRouteProgress();
        console.error('deleteFromRouteAndTrash error:', err);
        showToast('❌ Помилка видалення');
    });
}

// Оновити кількість в маршрутах (викликається при відкритті dropdown)
function updateRoutesCounts() {
    vehicles.forEach(v => {
        fetch(ROUTE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                action: 'getRoutePassengers',
                payload: { vehicleName: v.name }
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Оновлюємо badge в dropdown
                const badges = document.querySelectorAll(`[data-route-vehicle="${v.id}"] .side-menu-item-count, [data-route-count="${v.id}"]`);
                badges.forEach(badge => {
                    badge.textContent = data.stats.total;
                });
            }
        })
        .catch(() => {});
    });
}

function updateFilterButtons() {
    if (filters.date) {
        const d = new Date(filters.date);
        document.getElementById('dateLabel').textContent = d.getDate() + ' ' + d.toLocaleDateString('uk',{month:'short'});
        document.getElementById('dateCount').style.display = 'inline';
        document.getElementById('dateCount').textContent = getFilteredData().length;
        document.getElementById('btnDate').classList.add('active');
    } else {
        document.getElementById('dateLabel').textContent = 'Дата';
        document.getElementById('dateCount').style.display = 'none';
        document.getElementById('btnDate').classList.remove('active');
    }
    document.getElementById('btnArchive')?.classList.toggle('active', filters.showArchive);
    document.getElementById('btnRoute')?.classList.toggle('active', filters.statusFilter === 'route');
}

function toggleDropdown(id) { document.querySelectorAll('.dropdown-menu').forEach(d => { if(d.id !== id) d.classList.remove('show'); }); document.getElementById(id).classList.toggle('show'); if(id === 'dateDropdown') renderCalendarTo('desktopCalendar'); }
function resetFilters() { filters.date = ''; filters.vehicle = ''; filters.showArchive = false; filters.statusFilter = ''; filters.routeVehicle = ''; routePassengers = []; routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0 }; currentRouteVehicle = null; routeStatusFilter = 'all'; render(); renderCalendars(); updateVehiclesList(); updateAllCounts(); updatePcVehiclesList(); }
function setVehicleFilter(id) { 
    filters.vehicle = id; 
    filters.statusFilter = ''; 
    filters.routeVehicle = '';
    routePassengers = [];
    routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0 };
    currentRouteVehicle = null;
    routeStatusFilter = 'all';
    document.getElementById('vehicleDropdown')?.classList.remove('show'); 
    render(); 
    updatePcVehiclesList();
}
function filterByStatus(status) { filters.statusFilter = filters.statusFilter === status ? '' : status; filters.showArchive = false; filters.routeVehicle = ''; routePassengers = []; routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0 }; currentRouteVehicle = null; routeStatusFilter = 'all'; render(); updateFilterButtons(); }
function toggleArchiveFilter() { filters.showArchive = !filters.showArchive; filters.statusFilter = ''; filters.routeVehicle = ''; routePassengers = []; routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0 }; currentRouteVehicle = null; routeStatusFilter = 'all'; render(); updateAllCounts(); updateFilterButtons(); }

// SINGLE ACTIONS
function moveOneToRoute(id) {
    const p = passengers.find(x => x.id === id);
    if (!p) return;
    if (!p.vehicle) return showToast('⚠️ Спочатку призначте авто');
    p.status = 'route';
    saveSettings();
    render();
    updateAllCounts();
    showToast('🚀 В маршруті');
}

function archivePassenger(id) {
    const p = passengers.find(x => x.id === id);
    if (p) { p.status = 'archived'; saveSettings(); render(); updateAllCounts(); renderCalendars(); showToast('📦 В архіві'); }
}

function restorePassenger(id) {
    const p = passengers.find(x => x.id === id);
    if (p) { p.status = 'new'; saveSettings(); render(); updateAllCounts(); renderCalendars(); showToast('♻️ Відновлено'); }
}

function bulkRestore() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    
    const closedStatuses = ['archived', 'refused', 'transferred', 'deleted'];
    
    // Збираємо дані для API
    const passengersToRestore = [];
    selectedIds.forEach(uid => {
        const p = findPassengerByUid(uid);
        if (p && p._sheet && p._rowNum && closedStatuses.includes(p.status)) {
            passengersToRestore.push({
                sheet: p._sheet,
                rowNum: p._rowNum
            });
        }
    });
    
    if (passengersToRestore.length === 0) {
        return showToast('⚠️ Немає заявок для відновлення');
    }
    
    showLoader('Відновлюю...', '');
    
    // Викликаємо API
    fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'restorePassengers',
            payload: { passengers: passengersToRestore }
        })
    })
    .then(r => r.json())
    .then(data => {
        hideLoader();
        if (data.success) {
            // Оновлюємо локально
            selectedIds.forEach(uid => {
                const p = findPassengerByUid(uid);
                if (p && closedStatuses.includes(p.status)) {
                    p.status = 'new';
                    p.statusDate = '';
                    // Очищаємо причину відмови/пересадки з примітки
                    if (p.note) {
                        p.note = p.note.replace(/^(Відмова|Пересадка|Видалено):.*?\|?\s*/i, '');
                    }
                }
            });
            clearSelection();
            render();
            updateAllCounts();
            showToast(`↩️ Відновлено: ${data.restored || passengersToRestore.length}`);
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        hideLoader();
        console.error('Restore error:', err);
        // Відновлюємо локально
        selectedIds.forEach(uid => {
            const p = findPassengerByUid(uid);
            if (p && closedStatuses.includes(p.status)) {
                p.status = 'new';
                p.statusDate = '';
            }
        });
        clearSelection();
        saveSettings();
        render();
        updateAllCounts();
        showToast('↩️ Відновлено локально');
    });
}

// Відмітити як сповіщених
function bulkMarkNotified() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть пасажирів');
    
    // Питаємо ім'я (поки немає системи логіну)
    const userName = prompt('Введіть ваше ім\'я:');
    if (!userName || !userName.trim()) {
        return showToast('⚠️ Введіть ім\'я');
    }
    
    // Збираємо записи для додавання
    const records = [];
    selectedIds.forEach(uid => {
        // Шукаємо в routePassengers (бо ми в режимі маршруту)
        const p = routePassengers.find(x => x._uid === uid);
        if (p && p.id) {
            // Перевіряємо чи вже не сповіщений
            if (!mailingIds.includes(String(p.id))) {
                records.push({
                    date: p.date || new Date().toLocaleDateString('uk-UA'),
                    id: p.id
                });
            }
        }
    });
    
    if (records.length === 0) {
        return showToast('⚠️ Всі вибрані вже сповіщені');
    }
    
    showLoader('Збереження...', '');
    
    fetch(ROUTE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'addMailingRecord',
            payload: {
                records: records,
                userName: userName.trim()
            }
        })
    })
    .then(r => r.json())
    .then(data => {
        hideLoader();
        if (data.success) {
            // Оновлюємо локальний список mailingIds
            records.forEach(r => mailingIds.push(String(r.id)));
            
            clearSelection();
            renderRoutePassengers();
            showToast(`🔔 Сповіщено: ${data.added}`);
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        hideLoader();
        console.error('Mailing error:', err);
        showToast('❌ Помилка збереження');
    });
}

// BULK ACTIONS
let selectedBulkVehicleId = null;

function openBulkVehicleModal() {
    selectedBulkVehicleId = null;
    document.getElementById('bulkVehicleCount').textContent = selectedIds.size;
    document.getElementById('bulkVehicleList').innerHTML = vehicles.map(v =>
        `<div class="vehicle-select-item" id="vsi_${v.id}" onclick="selectBulkVehicle('${v.id}')" style="cursor:pointer;border:2px solid transparent;transition:all 0.2s;"><span class="vehicle-select-name">🚐 ${v.name}</span><span class="vehicle-select-info">${v.seats} місць</span></div>`
    ).join('');
    const confirmBtn = document.getElementById('bulkVehicleConfirmBtn');
    confirmBtn.disabled = true;
    confirmBtn.style.opacity = '0.5';
    document.getElementById('bulkVehicleModal').classList.add('show');
}

function selectBulkVehicle(vehicleId) {
    selectedBulkVehicleId = vehicleId;
    // Підсвічуємо вибране авто
    document.querySelectorAll('#bulkVehicleList .vehicle-select-item').forEach(el => {
        el.style.borderColor = 'transparent';
        el.style.background = '';
    });
    const selectedEl = document.getElementById('vsi_' + vehicleId);
    if (selectedEl) {
        selectedEl.style.borderColor = 'var(--info)';
        selectedEl.style.background = '#f0f7ff';
    }
    // Активуємо кнопку підтвердження
    const confirmBtn = document.getElementById('bulkVehicleConfirmBtn');
    confirmBtn.disabled = false;
    confirmBtn.style.opacity = '1';
}

function confirmBulkAssignVehicle() {
    if (!selectedBulkVehicleId) return showToast('⚠️ Оберіть авто');
    bulkAssignVehicle(selectedBulkVehicleId);
}

function bulkAssignVehicle(vehicleId) {
    const veh = vehicles.find(v => v.id === vehicleId);
    if (!veh) return showToast('❌ Авто не знайдено');

    let count = 0;
    selectedIds.forEach(uid => {
        const p = findPassengerByUid(uid);
        if (p && p.status !== 'archived') {
            p.vehicle = veh.name;
            if (p.status === 'new') p.status = 'work';
            // Оновлюємо на сервері
            updatePassengerOnServer(p);
            count++;
        }
    });
    saveSettings();
    closeModal('bulkVehicleModal');
    render();
    updateBulkBar();
    updateAllCounts();
    updateVehiclesList();
    showToast(`🚐 ${veh.name} призначено: ${count}`);
}

function bulkMoveToRoute() {
    // Збираємо вибраних пасажирів
    const selected = [...selectedIds].map(uid => findPassengerByUid(uid)).filter(Boolean);
    if (!selected.length) return showToast('⚠️ Оберіть пасажирів');
    
    // Перевіряємо чи є авто
    const withVehicle = selected.filter(p => p.vehicle);
    if (!withVehicle.length) return showToast('⚠️ Спочатку призначте авто');
    
    // Групуємо по авто
    const byVehicle = {};
    withVehicle.forEach(p => {
        const veh = vehicles.find(v => v.id === p.vehicle || v.name === p.vehicle);
        const vName = veh ? veh.name : p.vehicle;
        if (!byVehicle[vName]) byVehicle[vName] = [];
        byVehicle[vName].push(p);
    });
    
    // Показуємо ненав'язливий прогрес
    showRouteProgress('Перевіряю маршрути...');

    // Спочатку перевіряємо чи є записи в маршрутах
    fetch(ROUTE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'checkRouteSheets',
            payload: { vehicleNames: Object.keys(byVehicle) }
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.existing && data.existing.length > 0) {
            // Є існуючі записи - показуємо діалог
            showRouteConflictModal(data.existing, byVehicle, withVehicle);
        } else {
            // Немає конфліктів - копіюємо
            executeCopyToRoute(byVehicle, withVehicle, 'add');
        }
    })
    .catch(err => {
        console.error('Check route error:', err);
        // При помилці все одно пробуємо копіювати
        executeCopyToRoute(byVehicle, withVehicle, 'add');
    });
}

// Toggle collapsible secondary bulk actions
function toggleBulkSecondary() {
    const sec = document.getElementById('bulkSecondaryActions');
    const tog = document.getElementById('bulkMoreToggle');
    if (sec.classList.contains('expanded')) {
        sec.classList.remove('expanded');
        tog.classList.remove('expanded');
    } else {
        sec.classList.add('expanded');
        tog.classList.add('expanded');
    }
}

// Route progress overlay helpers
function showRouteProgress(text) {
    let el = document.getElementById('routeProgressOverlay');
    if (!el) {
        el = document.createElement('div');
        el.className = 'route-progress-overlay';
        el.id = 'routeProgressOverlay';
        el.innerHTML = '<div class="route-progress-card"><div class="route-progress-spinner"></div><div class="route-progress-text"></div></div>';
        document.body.appendChild(el);
    }
    el.querySelector('.route-progress-text').textContent = text || 'Обробка маршруту...';
    el.style.display = 'flex';
}
function hideRouteProgress() {
    const el = document.getElementById('routeProgressOverlay');
    if (el) el.style.display = 'none';
}
function updateRouteProgress(text) {
    const el = document.getElementById('routeProgressOverlay');
    if (el) el.querySelector('.route-progress-text').textContent = text;
}

// Модалка конфлікту маршрутів - redesigned as bottom sheet
function showRouteConflictModal(existing, byVehicle, withVehicle) {
    hideRouteProgress();

    const list = existing.map(e => `
        <div class="route-conflict-item">
            <div class="route-conflict-item-icon">🚐</div>
            <div>
                <div class="route-conflict-item-text">${e.vehicle}</div>
                <div class="route-conflict-item-sub">${e.count} записів у маршруті</div>
            </div>
        </div>
    `).join('');

    const overlay = document.createElement('div');
    overlay.className = 'route-conflict-overlay';
    overlay.id = 'routeConflictModal';
    overlay.innerHTML = `
        <div class="route-conflict-sheet">
            <div class="route-conflict-handle"></div>
            <div class="route-conflict-title">В маршрутах вже є записи</div>
            <div class="route-conflict-info">
                ${list}
            </div>
            <div class="route-conflict-actions">
                <button class="route-conflict-btn add" onclick="handleRouteConflict('add')">
                    <span class="btn-emoji">➕</span>
                    <span class="btn-label">Додати</span>
                </button>
                <button class="route-conflict-btn archive" onclick="handleRouteConflict('archive')">
                    <span class="btn-emoji">📦</span>
                    <span class="btn-label">Архівувати старі</span>
                </button>
                <button class="route-conflict-btn clear" onclick="handleRouteConflict('clear')">
                    <span class="btn-emoji">🗑️</span>
                    <span class="btn-label">Очистити старі</span>
                </button>
                <button class="route-conflict-btn cancel" onclick="closeRouteConflict()">
                    Скасувати
                </button>
            </div>
        </div>
    `;

    // Close on overlay click
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeRouteConflict();
    });

    document.body.appendChild(overlay);
    // Trigger animation
    requestAnimationFrame(() => overlay.classList.add('show'));

    window._routeConflictData = { byVehicle, withVehicle };
}

function closeRouteConflict() {
    const overlay = document.getElementById('routeConflictModal');
    if (!overlay) return;
    overlay.classList.remove('show');
    setTimeout(() => overlay.remove(), 350);
}

function handleRouteConflict(action) {
    const { byVehicle, withVehicle } = window._routeConflictData;
    closeRouteConflict();
    executeCopyToRoute(byVehicle, withVehicle, action);
}

function executeCopyToRoute(byVehicle, withVehicle, conflictAction) {
    showRouteProgress('Записую в маршрут...');

    const payload = {
        action: 'copyToRoute',
        payload: {
            passengersByVehicle: byVehicle,
            conflictAction: conflictAction
        }
    };

    fetch(ROUTE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        hideRouteProgress();
        if (data.success) {
            withVehicle.forEach(p => {
                p.status = 'route';
                p.mark = 'Маршрут';
            });
            saveSettings();
            render();
            updateBulkBar();
            updateAllCounts();

            let msg = `🚀 ${data.copied} записано в маршрут`;
            if (data.archived) msg += `, 📦 ${data.archived} архівовано`;
            if (data.cleared) msg += `, 🗑️ ${data.cleared} видалено`;
            showToast(msg);
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        hideRouteProgress();
        console.error('Route error:', err);
        showToast('❌ Помилка запису');
    });
}

function bulkArchive() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    
    // Збираємо дані для API
    const passengersToArchive = [];
    selectedIds.forEach(uid => {
        const p = findPassengerByUid(uid);
        if (p && p._sheet && p._rowNum) {
            passengersToArchive.push({
                sheet: p._sheet,
                rowNum: p._rowNum
            });
        }
    });
    
    if (passengersToArchive.length === 0) {
        return showToast('⚠️ Немає заявок для архівації');
    }
    
    showLoader('Архівую...', '');
    
    // Викликаємо API
    fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'archivePassengers',
            payload: { passengers: passengersToArchive }
        })
    })
    .then(r => r.json())
    .then(data => {
        hideLoader();
        if (data.success) {
            // Оновлюємо локально
            selectedIds.forEach(uid => {
                const p = findPassengerByUid(uid);
                if (p) {
                    p.status = 'archived';
                    p.statusDate = new Date().toISOString().split('T')[0];
                }
            });
            clearSelection();
            render();
            updateAllCounts();
            renderCalendars();
            showToast(`📦 Архівовано: ${data.archived}`);
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        hideLoader();
        console.error('Archive error:', err);
        showToast('❌ Помилка архівації');
    });
}

// ВІДМОВА - з вибором причини
function bulkRefuse() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    showRefuseModal();
}

function showRefuseModal() {
    document.getElementById('refuseModal')?.remove();
    
    const reasons = [
        'Ціна завелика',
        'Дата не підходить',
        'Знайшов інший варіант',
        'Передумав їхати',
        'Немає місць',
        'Інше'
    ];
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'refuseModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;">
            <div class="modal-header" style="background:#fee2e2;">
                <span class="modal-title" style="color:#dc2626;">❌ Причина відмови</span>
                <button class="modal-close" onclick="document.getElementById('refuseModal').remove()">✕</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:12px;font-size:13px;color:var(--text-secondary);">Вибрано: <strong>${selectedIds.size}</strong> заявок</div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    ${reasons.map(r => `
                        <label style="display:flex;align-items:center;gap:10px;padding:10px;border:2px solid var(--border);border-radius:8px;cursor:pointer;">
                            <input type="radio" name="refuseReason" value="${r}" style="width:18px;height:18px;">
                            <span style="font-size:13px;">${r}</span>
                        </label>
                    `).join('')}
                </div>
                <div id="refuseOtherWrap" style="display:none;margin-top:10px;">
                    <input type="text" id="refuseOtherText" placeholder="Вкажіть причину..." style="width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-family:inherit;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('refuseModal').remove()">Скасувати</button>
                <button class="btn-save" style="background:#dc2626;" onclick="confirmRefuse()">❌ Відмовити</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Показати поле "Інше" при виборі
    modal.querySelectorAll('input[name="refuseReason"]').forEach(input => {
        input.addEventListener('change', () => {
            document.getElementById('refuseOtherWrap').style.display = 
                input.value === 'Інше' ? 'block' : 'none';
        });
    });
}

function confirmRefuse() {
    const selected = document.querySelector('input[name="refuseReason"]:checked');
    if (!selected) return showToast('⚠️ Оберіть причину');
    
    let reason = selected.value;
    if (reason === 'Інше') {
        reason = document.getElementById('refuseOtherText')?.value || 'Інше';
    }
    
    document.getElementById('refuseModal').remove();
    applyStatusToSelected('refused', `Відмова: ${reason}`);
}

// ПЕРЕСАДКА - з вказанням кому
function bulkTransfer() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    showTransferModal();
}

function showTransferModal() {
    document.getElementById('transferModal')?.remove();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'transferModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;">
            <div class="modal-header" style="background:#ccfbf1;">
                <span class="modal-title" style="color:#0d9488;">🤝 Пересадка</span>
                <button class="modal-close" onclick="document.getElementById('transferModal').remove()">✕</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:12px;font-size:13px;color:var(--text-secondary);">Вибрано: <strong>${selectedIds.size}</strong> заявок</div>
                <label style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;display:block;">Кому пересадили?</label>
                <input type="text" id="transferToText" placeholder="Назва перевізника, авто..." style="width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-family:inherit;font-size:14px;">
                <div style="margin-top:8px;font-size:11px;color:var(--text-secondary);">Наприклад: Укрбус, Авто Петра</div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('transferModal').remove()">Скасувати</button>
                <button class="btn-save" style="background:#14b8a6;" onclick="confirmTransfer()">🤝 Пересадити</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('transferToText')?.focus();
}

function confirmTransfer() {
    const transferTo = document.getElementById('transferToText')?.value?.trim();
    if (!transferTo) return showToast('⚠️ Вкажіть кому пересадили');
    
    document.getElementById('transferModal').remove();
    applyStatusToSelected('transferred', `Пересадка: ${transferTo}`);
}

// ВИДАЛЕННЯ - з причиною
function bulkDelete() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    showDeleteModal();
}

function showDeleteModal() {
    document.getElementById('deleteModal')?.remove();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'deleteModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;">
            <div class="modal-header" style="background:#f3f4f6;">
                <span class="modal-title" style="color:#6b7280;">🗑️ Видалення</span>
                <button class="modal-close" onclick="document.getElementById('deleteModal').remove()">✕</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:12px;font-size:13px;color:var(--text-secondary);">Вибрано: <strong>${selectedIds.size}</strong> заявок</div>
                <label style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;display:block;">Причина видалення</label>
                <input type="text" id="deleteReasonText" placeholder="Дубль, тест, помилка..." style="width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-family:inherit;font-size:14px;">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('deleteModal').remove()">Скасувати</button>
                <button class="btn-save" style="background:#6b7280;" onclick="confirmDelete()">🗑️ Видалити</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('deleteReasonText')?.focus();
}

function confirmDelete() {
    const reason = document.getElementById('deleteReasonText')?.value?.trim() || 'Без причини';
    document.getElementById('deleteModal').remove();
    applyStatusToSelected('deleted', `Видалено: ${reason}`);
}

// ВИДАЛИТИ НАЗАВЖДИ
function bulkDeleteForever() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    
    if (!confirm(`💀 УВАГА!\n\nВи точно хочете НАЗАВЖДИ видалити ${selectedIds.size} заявок?\n\nЦю дію НЕ МОЖНА скасувати!`)) {
        return;
    }
    
    showLoader('Видаляю назавжди...', '');
    
    // TODO: API для повного видалення
    // Поки що просто ховаємо локально
    selectedIds.forEach(uid => {
        const idx = passengers.findIndex(p => {
            const pUid = (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : `local_${passengers.indexOf(p)}`;
            return pUid === uid;
        });
        if (idx !== -1) {
            passengers.splice(idx, 1);
        }
    });
    
    hideLoader();
    clearSelection();
    saveSettings();
    render();
    updateAllCounts();
    showToast(`💀 Видалено назавжди: ${selectedIds.size}`);
}

// Універсальна функція застосування статусу
function applyStatusToSelected(status, note) {
    showLoader('Обробка...', '');
    
    const today = new Date().toISOString().split('T')[0];
    let count = 0;
    
    selectedIds.forEach(uid => {
        const p = findPassengerByUid(uid);
        if (p) {
            p.status = status;
            p.statusDate = today;
            p.note = note + (p.note ? ` | ${p.note}` : '');
            p.isNew = false;
            count++;
            
            // Оновлюємо на сервері якщо є дані
            if (p._sheet && p._rowNum) {
                updatePassengerOnServer(p);
            }
        }
    });
    
    hideLoader();
    clearSelection();
    saveSettings();
    render();
    updateAllCounts();
    renderCalendars();
    
    const statusNames = {
        'refused': '❌ Відмова',
        'transferred': '🤝 Пересадка', 
        'deleted': '🗑️ Видалено',
        'archived': '📦 Архів'
    };
    showToast(`${statusNames[status] || status}: ${count}`);
}

// Показати фільтр по статусу
function showStatusFilter(status) {
    // Скидаємо ВСІ фільтри щоб нічого не ховало записи
    filters.showArchive = false;
    filters.statusFilter = '';
    filters.routeVehicle = '';
    filters.direction = 'all';
    filters.date = '';
    filters.vehicle = '';
    filters.showNewOnly = false;
    filters.search = '';
    filters.specialStatus = status; // Новий фільтр

    routePassengers = [];
    currentRouteVehicle = null;
    routeStatusFilter = 'all';

    // Очищаємо поле пошуку в UI
    const searchInput = document.getElementById('searchInput');
    if (searchInput) searchInput.value = '';

    render();
    updateAllCounts();
    updateFilterButtons();
    renderCalendars();
    showToast(`📋 ${getStatusName(status)}`);
}

function getStatusName(status) {
    const names = {
        'archived': '📦 Архів',
        'refused': '❌ Відмови',
        'transferred': '🤝 Пересадки',
        'deleted': '🗑️ Видалені'
    };
    return names[status] || status;
}

// SELECT ALL VISIBLE
function selectAllVisible() {
    // Визначаємо чи ми в режимі маршруту
    const isRouteView = filters.statusFilter === 'route' && filters.routeVehicle;

    let visibleUids;
    if (isRouteView && routePassengers.length > 0) {
        // В маршруті — використовуємо routePassengers
        visibleUids = routePassengers.map(p => p._uid);
    } else {
        const data = getFilteredData();
        visibleUids = data.map((p, idx) =>
            (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : `local_${idx}`
        );
    }

    // Перевіряємо чи всі вже вибрані
    const allSelected = visibleUids.every(uid => selectedIds.has(uid));

    if (allSelected) {
        // Знімаємо всі галочки (але НЕ ховаємо sidebar)
        visibleUids.forEach(uid => selectedIds.delete(uid));
        if (isRouteView) {
            renderRoutePassengers();
        } else {
            render();
        }
        // Оновлюємо тільки лічильники, НЕ ховаємо панель
        document.getElementById('bulkCount').textContent = selectedIds.size;
        const sidebarCount = document.getElementById('bulkCountSidebar');
        if (sidebarCount) sidebarCount.textContent = selectedIds.size;
        showToast(`☐ Знято ${visibleUids.length}`);
    } else {
        // Ставимо всі галочки
        visibleUids.forEach(uid => selectedIds.add(uid));
        if (isRouteView) {
            renderRoutePassengers();
        } else {
            render();
        }
        updateBulkBar();
        showToast(`☑️ Вибрано ${visibleUids.length}`);
    }
}

// ============================================
// ОПТИМІЗАЦІЯ МАРШРУТУ
// ============================================
let optimizeBy = 'from';
let optimizePassengersList = [];

function runOptimization() {
    // Беремо пасажирів по поточних фільтрах (дата + авто)
    const data = getFilteredData().filter(p => p.status !== 'archived');
    if (!data.length) return showToast('⚠️ Немає заявок для оптимізації');
    openOptimizeModal(data);
}

function bulkOptimize() {
    // Беремо вибраних пасажирів
    const selected = [...selectedIds].map(uid => findPassengerByUid(uid)).filter(Boolean);
    if (!selected.length) return showToast('⚠️ Оберіть пасажирів');
    openOptimizeModal(selected);
}

function openOptimizeModal(passengersList) {
    optimizePassengersList = passengersList;
    optimizeBy = 'from';
    
    // Оновлюємо UI
    document.getElementById('optimizeCount').textContent = passengersList.length;
    document.getElementById('optimizeStart').value = '';
    document.getElementById('optimizeEnd').value = '';
    document.getElementById('optFrom').classList.add('selected');
    document.getElementById('optTo').classList.remove('selected');
    
    // Показуємо форму, ховаємо результат
    document.getElementById('optimizeFormBody').style.display = 'block';
    document.getElementById('optimizeResultBody').style.display = 'none';
    document.getElementById('optimizeLoadingBody').style.display = 'none';
    document.getElementById('optimizeFormFooter').style.display = 'flex';
    document.getElementById('optimizeResultFooter').style.display = 'none';
    
    document.getElementById('optimizeModal').classList.add('show');
}

function selectOptimizeBy(by) {
    optimizeBy = by;
    document.getElementById('optFrom').classList.toggle('selected', by === 'from');
    document.getElementById('optTo').classList.toggle('selected', by === 'to');
}

// ============================================
// КЛІЄНТСЬКА ОПТИМІЗАЦІЯ (Google Maps JS API)
// ============================================
const OPTIMIZE_MAX_WAYPOINTS = 23; // Ліміт Google Directions API

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// Геокодування однієї адреси через Google Maps JS API
function geocodeClient(address) {
    return new Promise(resolve => {
        if (!window.mapsGeocoder) {
            console.warn('Geocode skipped: mapsGeocoder not available');
            return resolve(null);
        }
        let settled = false;
        const timeout = setTimeout(() => {
            if (!settled) {
                settled = true;
                console.warn('Geocode timeout (10s):', address);
                resolve(null);
            }
        }, 10000);
        try {
            window.mapsGeocoder.geocode({ address: address }, (results, status) => {
                if (settled) return;
                settled = true;
                clearTimeout(timeout);
                if (status === 'OK' && results && results[0]) {
                    resolve({
                        lat: results[0].geometry.location.lat(),
                        lng: results[0].geometry.location.lng()
                    });
                } else {
                    console.warn('Geocode failed:', address, '→', status);
                    resolve(null);
                }
            });
        } catch(e) {
            if (!settled) {
                settled = true;
                clearTimeout(timeout);
                console.error('Geocode exception:', e);
                resolve(null);
            }
        }
    });
}

// Оптимізація через Google Directions API (реальні дороги)
function optimizeDirectionsClient(geocodedPassengers, startCoords, endCoords) {
    return new Promise((resolve, reject) => {
        if (!window.mapsDirections) return reject(new Error('Maps API not ready'));

        let settled = false;
        const timeout = setTimeout(() => {
            if (!settled) {
                settled = true;
                reject(new Error('Directions API timeout (30s)'));
            }
        }, 30000);

        const waypoints = geocodedPassengers.map(p => ({
            location: new google.maps.LatLng(p.coords.lat, p.coords.lng),
            stopover: true
        }));

        const origin = new google.maps.LatLng(startCoords.lat, startCoords.lng);
        let destination, routeWaypoints;

        if (endCoords) {
            destination = new google.maps.LatLng(endCoords.lat, endCoords.lng);
            routeWaypoints = waypoints;
        } else {
            destination = waypoints[waypoints.length - 1].location;
            routeWaypoints = waypoints.slice(0, -1);
        }

        window.mapsDirections.route({
            origin: origin,
            destination: destination,
            waypoints: routeWaypoints,
            optimizeWaypoints: true,
            travelMode: google.maps.TravelMode.DRIVING
        }, (response, status) => {
            if (settled) return;
            settled = true;
            clearTimeout(timeout);
            if (status === 'OK') {
                const order = response.routes[0].waypoint_order;
                if (endCoords) {
                    resolve(order);
                } else {
                    const result = order.slice();
                    result.push(geocodedPassengers.length - 1);
                    resolve(result);
                }
            } else {
                reject(new Error('Directions API: ' + status));
            }
        });
    });
}

// Fallback: Nearest Neighbor (по прямій)
function nearestNeighborClient(geocodedPassengers, startCoords) {
    const n = geocodedPassengers.length;
    if (n === 0) return [];
    if (n === 1) return [0];

    function haversine(c1, c2) {
        const R = 6371;
        const dLat = (c2.lat - c1.lat) * Math.PI / 180;
        const dLng = (c2.lng - c1.lng) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(c1.lat*Math.PI/180) * Math.cos(c2.lat*Math.PI/180) * Math.sin(dLng/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // Знаходимо найближчу до старту
    let currentIdx = 0;
    let minDist = Infinity;
    for (let i = 0; i < n; i++) {
        const d = haversine(startCoords, geocodedPassengers[i].coords);
        if (d < minDist) { minDist = d; currentIdx = i; }
    }

    const visited = Array(n).fill(false);
    const tour = [currentIdx];
    visited[currentIdx] = true;

    for (let step = 1; step < n; step++) {
        let nearest = -1, nearDist = Infinity;
        for (let j = 0; j < n; j++) {
            if (!visited[j]) {
                const d = haversine(geocodedPassengers[currentIdx].coords, geocodedPassengers[j].coords);
                if (d < nearDist) { nearDist = d; nearest = j; }
            }
        }
        if (nearest === -1) break;
        tour.push(nearest);
        visited[nearest] = true;
        currentIdx = nearest;
    }
    return tour;
}

// Генерація посилань на Google Maps
function generateOptimizeMapLinks(orderedPassengers, startAddr, endAddr) {
    const MAX_PER_MAP = 25;
    const links = [];
    const total = orderedPassengers.length;
    if (total === 0) return links;

    const perChunk = MAX_PER_MAP - 1;
    let chunkStart = 0;

    while (chunkStart < total) {
        const chunkEnd = Math.min(chunkStart + perChunk, total);
        const chunk = orderedPassengers.slice(chunkStart, chunkEnd);

        const origin = chunkStart === 0
            ? (startAddr || 'Ужгород')
            : orderedPassengers[chunkStart - 1].address;

        let destination, waypointItems;
        if (chunkEnd >= total && endAddr) {
            destination = endAddr;
            waypointItems = chunk;
        } else {
            destination = chunk[chunk.length - 1].address;
            waypointItems = chunk.slice(0, -1);
        }

        let url = 'https://www.google.com/maps/dir/' + encodeURIComponent(origin);
        waypointItems.forEach(p => { url += '/' + encodeURIComponent(p.address); });
        url += '/' + encodeURIComponent(destination);

        links.push({ url, from: chunkStart + 1, to: chunkEnd, total });
        chunkStart = chunkEnd;
    }
    return links;
}

// ГОЛОВНА ФУНКЦІЯ ОПТИМІЗАЦІЇ (клієнтська)
async function startOptimization() {
    if (!optimizePassengersList.length) return;

    // Перевірка Maps API
    if (!window.mapsApiReady || !window.mapsGeocoder) {
        showToast('❌ Google Maps API не завантажено. Перезавантажте сторінку.');
        console.error('Maps API state:', { ready: window.mapsApiReady, geocoder: !!window.mapsGeocoder, directions: !!window.mapsDirections });
        return;
    }

    // UI → loading
    document.getElementById('optimizeFormBody').style.display = 'none';
    document.getElementById('optimizeLoadingBody').style.display = 'block';
    document.getElementById('optimizeFormFooter').style.display = 'none';

    // Хелпер для оновлення тексту в модалці оптимізації
    function updateOptStatus(text, progress) {
        const el = document.getElementById('optimizeLoadingText');
        const pr = document.getElementById('optimizeLoadingProgress');
        if (el && text) el.textContent = text;
        if (pr && progress !== undefined) pr.textContent = progress;
    }

    const startAddress = document.getElementById('optimizeStart').value.trim() || 'Ужгород';
    const endAddress = document.getElementById('optimizeEnd').value.trim();
    const optimizeLabel = optimizeBy === 'from' ? 'Адреса ВІДПРАВКИ' : 'Адреса ПРИБУТТЯ';

    try {
        // 1. Збираємо пасажирів з адресами
        const allPassengers = optimizePassengersList.map(p => ({
            id: p.id || '',
            name: p.name || '',
            phone: p.phone || '',
            from: p.from || '',
            to: p.to || '',
            seats: p.seats || 1,
            date: p.date || '',
            payment: p.payment || '',
            direction: p.direction || '',
            vehicle: p.vehicle || '',
            address: (optimizeBy === 'from' ? p.from : p.to) || '',
            coords: null,
            _uid: (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : null,
            _sheet: p._sheet,
            _rowNum: p._rowNum
        }));

        const withAddress = allPassengers.filter(p => p.address && p.address.trim());
        const withoutAddress = allPassengers.filter(p => !p.address || !p.address.trim());

        if (withAddress.length === 0) {
            throw new Error(`Жоден лід не має адреси (поле "${optimizeBy === 'from' ? 'Звідки' : 'Куди'}")`);
        }

        // 2. Геокодуємо всі адреси
        updateOptStatus('Геокодування адрес...', `0 / ${withAddress.length}`);
        const geocoded = [];
        const notGeocodedList = [];

        for (let i = 0; i < withAddress.length; i++) {
            const shortAddr = withAddress[i].address.length > 30 ? withAddress[i].address.substring(0, 30) + '...' : withAddress[i].address;
            updateOptStatus(`📍 ${shortAddr}`, `${i + 1} / ${withAddress.length}`);

            const coords = await geocodeClient(withAddress[i].address);
            if (coords) {
                withAddress[i].coords = coords;
                geocoded.push(withAddress[i]);
            } else {
                notGeocodedList.push({
                    id: withAddress[i].id,
                    name: withAddress[i].name,
                    address: withAddress[i].address,
                    uid: withAddress[i]._uid
                });
            }

            // Rate limit
            if (i < withAddress.length - 1) await sleep(150);
        }

        if (geocoded.length === 0) {
            throw new Error('Жодну адресу не вдалось геокодувати! Перевірте що Maps JavaScript API увімкнено в Google Cloud Console.');
        }

        // 3. Геокодуємо старт та фініш
        updateOptStatus('📍 Геокодування старту...', '');
        const startCoords = await geocodeClient(startAddress) || { lat: 48.6209, lng: 22.2879 };
        let endCoords = null;
        if (endAddress) {
            updateOptStatus('📍 Геокодування фінішу...', '');
            endCoords = await geocodeClient(endAddress);
        }

        // 4. Оптимізація маршруту
        updateOptStatus('🗺️ Оптимізація маршруту...', `${geocoded.length} точок`);
        let optimizedOrder = null;
        let method = '';

        if (geocoded.length <= OPTIMIZE_MAX_WAYPOINTS) {
            try {
                optimizedOrder = await optimizeDirectionsClient(geocoded, startCoords, endCoords);
                method = 'Google Directions API (реальні дороги)';
            } catch(e) {
                console.warn('Directions API fallback:', e.message);
            }
        }

        if (!optimizedOrder || optimizedOrder.length === 0) {
            optimizedOrder = nearestNeighborClient(geocoded, startCoords);
            method = 'Nearest Neighbor (по прямій)';
        }

        // 5. Формуємо результат
        const orderedPassengers = optimizedOrder.map(idx => geocoded[idx]);
        const mapLinks = generateOptimizeMapLinks(orderedPassengers, startAddress, endAddress);

        console.log('✅ Optimization done:', {
            total: withAddress.length,
            geocoded: geocoded.length,
            optimized: orderedPassengers.length,
            method,
            notGeocoded: notGeocodedList.length
        });

        // 6. Показуємо результат
        document.getElementById('optimizeLoadingBody').style.display = 'none';
        showOptimizationResult({
            success: true,
            optimizeBy: optimizeLabel,
            start: startAddress,
            end: endAddress || '(остання точка)',
            stats: {
                total: withAddress.length,
                geocoded: geocoded.length,
                optimized: orderedPassengers.length
            },
            method: method,
            mapLinks: mapLinks,
            orderedPassengers: orderedPassengers,
            notGeocodedList: notGeocodedList
        });

        // 7. Оновлюємо порядок в CRM
        applyOptimizedOrder(orderedPassengers, notGeocodedList);

    } catch(err) {
        console.error('Optimize error:', err);
        document.getElementById('optimizeFormBody').style.display = 'block';
        document.getElementById('optimizeLoadingBody').style.display = 'none';
        document.getElementById('optimizeFormFooter').style.display = 'flex';
        showToast('❌ ' + err.message);
    }
}

function showOptimizationResult(data) {
    // Показуємо результат
    document.getElementById('optimizeLoadingBody').style.display = 'none';
    document.getElementById('optimizeResultBody').style.display = 'block';
    document.getElementById('optimizeResultFooter').style.display = 'flex';
    
    // Статистика
    const statsHtml = `
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">📋 Оптимізація по:</span>
            <span class="optimize-stat-value">${data.optimizeBy}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">📍 Старт:</span>
            <span class="optimize-stat-value">${data.start}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">🏁 Фініш:</span>
            <span class="optimize-stat-value">${data.end}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">👥 Пасажирів:</span>
            <span class="optimize-stat-value">${data.stats.total}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">✅ Геокодовано:</span>
            <span class="optimize-stat-value">${data.stats.geocoded}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">✅ Оптимізовано:</span>
            <span class="optimize-stat-value">${data.stats.optimized}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">🗺️ Метод:</span>
            <span class="optimize-stat-value">${data.method}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">🔗 Карта:</span>
            <span class="optimize-stat-value">${data.mapLinks.length} посилань</span>
        </div>
    `;
    document.getElementById('optimizeStats').innerHTML = statsHtml;
    
    // Не геокодовані адреси
    if (data.notGeocodedList && data.notGeocodedList.length > 0) {
        document.getElementById('optimizeNotGeocoded').style.display = 'block';
        const listHtml = data.notGeocodedList.map(item => 
            `<div class="optimize-not-geocoded-item">
                <strong>${item.id}</strong> ${item.name ? '(' + item.name + ')' : ''}<br>
                <small>${item.address}</small>
            </div>`
        ).join('');
        document.getElementById('optimizeNotGeocodedList').innerHTML = listHtml;
    } else {
        document.getElementById('optimizeNotGeocoded').style.display = 'none';
    }
    
    // Посилання на карту
    let mapHtml = '';
    if (data.mapLinks.length === 1) {
        mapHtml = `<a href="${data.mapLinks[0].url}" target="_blank" class="optimize-map-btn">🗺️ Відкрити маршрут на карті</a>`;
    } else {
        mapHtml = data.mapLinks.map((link, i) => 
            `<a href="${link.url}" target="_blank" class="optimize-map-btn">🗺️ Частина ${i + 1} з ${data.mapLinks.length} (точки ${link.from} - ${link.to})</a>`
        ).join('');
    }
    document.getElementById('optimizeMapLinks').innerHTML = mapHtml;
    
    // Оновлюємо порядок пасажирів в CRM
    applyOptimizedOrder(data.orderedPassengers, data.notGeocodedList);
}

function applyOptimizedOrder(orderedPassengers, notGeocodedList) {
    // Створюємо Set з uid не геокодованих
    const notGeocodedUids = new Set();
    if (notGeocodedList) {
        notGeocodedList.forEach(item => {
            if (item.uid) notGeocodedUids.add(item.uid);
        });
    }
    
    // Оновлюємо порядок в масиві passengers
    orderedPassengers.forEach((op, idx) => {
        const uid = op._uid || (op._sheet && op._rowNum ? `${op._sheet}_${op._rowNum}` : null);
        if (!uid) return;
        
        const p = findPassengerByUid(uid);
        if (p) {
            p.order = idx;
            p.status = 'optimize';
            p._notGeocoded = notGeocodedUids.has(uid);
        }
    });
    
    saveSettings();
    render();
    updateBulkBar();
    updateAllCounts();
}

// Закрити панель оптимізації
function closeOptimization() {
    document.getElementById('optimizationPanel')?.classList.remove('show');
}

// Відкрити Google Maps з оптимізованими точками
function openGoogleMaps() {
    const optimized = passengers.filter(p => p.status === 'optimize').sort((a, b) => (a.order || 0) - (b.order || 0));
    if (!optimized.length) return showToast('⚠️ Немає оптимізованих заявок');

    // Будуємо URL маршруту через waypoints
    const addresses = optimized.map(p => optimizeBy === 'from' ? p.from : p.to).filter(Boolean);
    if (addresses.length === 0) return showToast('❌ Немає адрес');

    const origin = encodeURIComponent(addresses[0]);
    const destination = encodeURIComponent(addresses[addresses.length - 1]);
    const waypoints = addresses.slice(1, -1).map(a => encodeURIComponent(a)).join('|');

    let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
    if (waypoints) url += `&waypoints=${waypoints}`;

    window.open(url, '_blank');
}

// Підтвердити оптимізацію → перевести в маршрут
function confirmOptimization() {
    const optimized = passengers.filter(p => p.status === 'optimize');
    if (!optimized.length) return showToast('⚠️ Немає оптимізованих заявок');

    // Виділяємо їх та переводимо в маршрут
    selectedIds.clear();
    optimized.forEach(p => {
        const uid = (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : null;
        if (uid) selectedIds.add(uid);
    });

    if (selectedIds.size > 0) {
        bulkMoveToRoute();
    } else {
        showToast('⚠️ Синхронізуй дані перед маршрутом');
    }
    closeOptimization();
}

// UNDO SYSTEM
function saveForUndo(action) {
    // Зберігаємо копію стану вибраних пасажирів
    const snapshot = [...selectedIds].map(uid => {
        const p = findPassengerByUid(uid);
        return p ? { ...p } : null;
    }).filter(Boolean);

    undoHistory.push({ action, snapshot, timestamp: Date.now() });

    // Максимум 10 дій в історії
    if (undoHistory.length > 10) undoHistory.shift();

    // Показуємо кнопку undo (якщо є)
    const btnUndo = document.getElementById('btnUndo');
    if (btnUndo) btnUndo.style.display = 'flex';
}

function undoLastAction() {
    if (!undoHistory.length) return showToast('↩️ Немає дій для відміни');
    
    const last = undoHistory.pop();
    
    // Відновлюємо стан пасажирів
    last.snapshot.forEach(snap => {
        const idx = passengers.findIndex(p => p.id === snap.id);
        if (idx !== -1) {
            passengers[idx] = { ...snap };
        }
    });
    
    saveSettings();
    render();
    updateAllCounts();
    renderCalendars();
    
    // Ховаємо кнопку якщо історія пуста
    const btnUndoEl = document.getElementById('btnUndo');
    if (!undoHistory.length && btnUndoEl) {
        btnUndoEl.style.display = 'none';
    }
    
    showToast(`↩️ Відмінено: ${last.action}`);
}

// VEHICLES
function updateVehiclesList() {
    document.getElementById('vehiclesList').innerHTML = vehicles.map(v => {
        // Базовий фільтр: авто + не архів
        let filtered = passengers.filter(p => (p.vehicle === v.id || p.vehicle === v.name) && p.status !== 'archived');
        
        // Фільтр по напрямку
        if (filters.direction && filters.direction !== 'all') {
            filtered = filtered.filter(p => p.direction === filters.direction);
        }
        
        // Фільтр по даті
        if (filters.date) {
            filtered = filtered.filter(p => p.date === filters.date);
        }
        
        const count = filtered.length;
        return `<div class="dropdown-item" onclick="setVehicleFilter('${v.id}')">${v.name} <span class="badge">${count}</span></div>`;
    }).join('');
    document.getElementById('fVehicle').innerHTML = '<option value="">—</option>' + vehicles.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
    
    // Оновлюємо "Без авто" теж з фільтрами
    let noVehicle = passengers.filter(p => !p.vehicle && p.status !== 'archived');
    if (filters.direction && filters.direction !== 'all') {
        noVehicle = noVehicle.filter(p => p.direction === filters.direction);
    }
    if (filters.date) {
        noVehicle = noVehicle.filter(p => p.date === filters.date);
    }
    document.getElementById('countNoVehicle').textContent = noVehicle.length;
}

function openAddVehicleModal() {
    document.getElementById('vehicleDropdown')?.classList.remove('show');
    document.getElementById('vName').value = '';
    document.getElementById('vSeats').value = 8;
    document.getElementById('vehicleModal').classList.add('show');
}

function saveVehicle() {
    const name = document.getElementById('vName').value.trim();
    const seats = parseInt(document.getElementById('vSeats').value) || 8;
    
    if (!name) return showToast('❌ Введіть назву авто');
    
    // Перевіряємо чи таке авто вже є
    if (vehicles.find(v => v.name.toLowerCase() === name.toLowerCase())) {
        return showToast('❌ Авто з такою назвою вже існує');
    }
    
    showToast('📤 Створюю авто та аркуш...');
    
    // Створюємо аркуш на сервері
    fetch(ROUTE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'createRouteSheet',
            payload: { vehicleName: name }
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Додаємо авто локально
            const newVehicle = {
                id: 'v' + Date.now(),
                name: name,
                seats: seats,
                routeSheet: data.sheetName
            };
            vehicles.push(newVehicle);
            saveSettings();
            updateVehiclesList();
            updateMobileVehicles();
            updateRoutesList(); // Оновлюємо список маршрутів
            updatePcVehiclesList(); // Оновлюємо PC sidebar авто
            updateAllCounts(); // Оновлюємо всі лічильники
            closeModal('vehicleModal');
            showToast(`✅ ${name} створено`);
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        console.error('Create vehicle error:', err);
        showToast('❌ Помилка створення');
    });
}

// Видалення авто
function deleteVehicle(vehicleId) {
    const v = vehicles.find(x => x.id === vehicleId);
    if (!v) return showToast('❌ Авто не знайдено');
    
    if (!confirm(`Видалити авто "${v.name}" та його аркуш маршруту?`)) {
        return;
    }
    
    showToast('🗑️ Видаляю...');
    
    // Видаляємо аркуш на сервері
    fetch(ROUTE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'deleteRouteSheet',
            payload: { vehicleName: v.name, force: true }
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Видаляємо локально
            vehicles = vehicles.filter(x => x.id !== vehicleId);
            saveSettings();
            updateVehiclesList();
            updateMobileVehicles();
            updateRoutesList();
            updatePcVehiclesList();
            updateAllCounts();
            showToast(`🗑️ ${v.name} видалено`);
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        console.error('Delete vehicle error:', err);
        showToast('❌ Помилка видалення');
    });
}

// PASSENGERS
function openAddModal() { 
    editingId = null; 
    document.getElementById('passengerModalTitle').textContent = 'Додати'; 
    document.getElementById('fDate').value = filters.date || new Date().toISOString().split('T')[0]; 
    document.getElementById('fDirection').value = filters.direction !== 'all' ? filters.direction : 'ua-eu';
    ['fName','fPhone','fPhoneReg','fFrom','fTo','fPayment','fPercent','fMark','fDispatcher','fWeight','fTiming','fNote'].forEach(id => document.getElementById(id).value = ''); 
    document.getElementById('fSeats').value = 1; 
    document.getElementById('fVehicle').value = filters.vehicle || ''; 
    document.getElementById('fDateReg').value = new Date().toISOString().split('T')[0];
    document.getElementById('passengerModal').classList.add('show'); 
}

function editPassenger(uid) {
    const p = findPassengerByUid(uid);
    if (!p) return;
    editingId = uid;
    updateVehiclesList(); // Оновлюємо список авто
    document.getElementById('passengerModalTitle').textContent = 'Редагувати';
    document.getElementById('fDirection').value = p.direction || 'ua-eu';
    document.getElementById('fDate').value = p.date || '';
    document.getElementById('fName').value = p.name || '';
    document.getElementById('fPhone').value = p.phone || '';
    document.getElementById('fPhoneReg').value = p.phoneReg || '';
    document.getElementById('fFrom').value = p.from || '';
    document.getElementById('fTo').value = p.to || '';
    document.getElementById('fSeats').value = p.seats || 1;
    document.getElementById('fPayment').value = p.payment || '';
    document.getElementById('fPercent').value = p.percent || '';
    document.getElementById('fVehicle').value = p.vehicle || '';
    document.getElementById('fMark').value = p.mark || '';
    document.getElementById('fDispatcher').value = p.dispatcher || '';
    document.getElementById('fWeight').value = p.weight || '';
    document.getElementById('fTiming').value = p.timing || '';
    document.getElementById('fDateReg').value = p.dateReg || '';
    document.getElementById('fNote').value = p.note || '';
    // Закриваємо дії картки
    openActionsId = null;
    document.querySelectorAll('.card-actions').forEach(el => el.classList.remove('show'));
    document.querySelectorAll('.card-actions-toggle').forEach(el => el.classList.remove('open'));
    document.getElementById('passengerModal').classList.add('show');
}

// Видалення ліда (в архів з підтвердженням)
function deletePassenger(uid) {
    const p = findPassengerByUid(uid);
    if (!p) return;
    
    // Показуємо модалку підтвердження
    const name = p.name || 'Без імені';
    const phone = p.phone || '—';
    const id = p.id || '—';
    
    showDeleteConfirmModal(uid, `${name} (${phone})`, id);
}

function showDeleteConfirmModal(uid, displayName, passengerId) {
    document.getElementById('deleteConfirmModal')?.remove();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'deleteConfirmModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;">
            <div class="modal-header" style="background:#fee2e2;border-bottom:1px solid #fecaca;">
                <span class="modal-title" style="color:#dc2626;">🗑️ Видалити ліда?</span>
                <button class="modal-close" onclick="document.getElementById('deleteConfirmModal').remove()">✕</button>
            </div>
            <div class="modal-body" style="text-align:center;padding:24px;">
                <div style="font-size:48px;margin-bottom:16px;">⚠️</div>
                <div style="font-size:14px;margin-bottom:8px;">Ви впевнені що хочете видалити:</div>
                <div style="font-size:16px;font-weight:700;color:var(--primary);margin-bottom:4px;">${displayName}</div>
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">ID: ${passengerId}</div>
                <div style="background:#fef3c7;padding:12px;border-radius:8px;font-size:12px;color:#92400e;">
                    Лід буде переміщений в <strong>Архів</strong>.<br>
                    Ви зможете відновити його пізніше.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('deleteConfirmModal').remove()">Скасувати</button>
                <button class="btn-save" style="background:#dc2626;" onclick="confirmDeletePassenger('${uid}')">🗑️ Видалити</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function confirmDeletePassenger(uid) {
    document.getElementById('deleteConfirmModal')?.remove();
    
    const p = findPassengerByUid(uid);
    if (!p) return;
    
    // Встановлюємо статус archived та дату
    p.status = 'archived';
    p.archiveDate = new Date().toISOString().split('T')[0];
    p.isNew = false;
    
    // Закриваємо дії картки
    openActionsId = null;
    
    // Якщо є серверні дані - архівуємо на сервері
    if (p._sheet && p._rowNum) {
        showLoader('Видалення...', '');
        
        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                action: 'archivePassengers',
                payload: {
                    passengers: [{ sheet: p._sheet, rowNum: p._rowNum }]
                }
            })
        })
        .then(r => r.json())
        .then(data => {
            hideLoader();
            if (data.success) {
                saveSettings();
                render();
                updateAllCounts();
                showToast('🗑️ Переміщено в архів');
            } else {
                showToast('❌ ' + (data.error || 'Помилка'));
            }
        })
        .catch(err => {
            hideLoader();
            console.error('Delete error:', err);
            // Все одно зберігаємо локально
            saveSettings();
            render();
            updateAllCounts();
            showToast('🗑️ Видалено локально');
        });
    } else {
        // Локальний лід - просто оновлюємо
        saveSettings();
        render();
        updateAllCounts();
        showToast('🗑️ Переміщено в архів');
    }
}

function savePassenger() { 
    const isEditing = !!editingId;
    const existingP = isEditing ? findPassengerByUid(editingId) : null;
    
    const d = {
        id: existingP?.id || 'p' + Date.now(),
        direction: document.getElementById('fDirection').value,
        date: document.getElementById('fDate').value,
        name: document.getElementById('fName').value || '—',
        phone: document.getElementById('fPhone').value,
        phoneReg: document.getElementById('fPhoneReg').value,
        from: document.getElementById('fFrom').value,
        to: document.getElementById('fTo').value,
        seats: parseInt(document.getElementById('fSeats').value) || 1,
        payment: document.getElementById('fPayment').value,
        percent: document.getElementById('fPercent').value,
        vehicle: document.getElementById('fVehicle').value,
        mark: document.getElementById('fMark').value,
        dispatcher: document.getElementById('fDispatcher').value,
        weight: document.getElementById('fWeight').value,
        timing: document.getElementById('fTiming').value,
        dateReg: document.getElementById('fDateReg').value,
        note: document.getElementById('fNote').value,
        status: existingP?.status || 'new',
        isNew: !editingId,
        order: passengers.length * 10
    }; 
    
    if (isEditing && existingP) {
        // Знаходимо індекс в масиві
        const i = passengers.findIndex(p => p._sheet === existingP._sheet && p._rowNum === existingP._rowNum);
        if (i !== -1) {
            d._sheet = passengers[i]._sheet;
            d._rowNum = passengers[i]._rowNum;
            passengers[i] = {...passengers[i], ...d};
            // Оновлюємо на сервері
            updatePassengerOnServer(passengers[i]);
        }
    } else {
        passengers.unshift(d);
        // Додаємо на сервер
        savePassengerToServer(d);
    }
    
    editingId = null;
    saveSettings(); 
    closeModal('passengerModal'); 
    render(); 
    updateVehiclesList(); 
    updateAllCounts(); 
    renderCalendars(); 
}

// COLUMNS
function openColumnsModal() { renderColumnsList(); document.getElementById('columnsModal').classList.add('show'); }
function renderColumnsList() { 
    const keys = Object.keys(ALL_COLUMNS); 
    document.getElementById('headerColList').innerHTML = keys.map(k => 
        `<div class="column-item" onclick="toggleHeaderCol('${k}')">
            <input type="checkbox" ${colSettings.header.includes(k)?'checked':''} onclick="event.stopPropagation();toggleHeaderCol('${k}')">
            <label>${ALL_COLUMNS[k].label}</label>
        </div>`
    ).join(''); 
    document.getElementById('detailsColList').innerHTML = keys.map(k => { 
        const inH = colSettings.header.includes(k); 
        return `<div class="column-item ${inH?'disabled':''}" onclick="${inH?'':`toggleDetailsCol('${k}')`}">
            <input type="checkbox" ${colSettings.details.includes(k)&&!inH?'checked':''} ${inH?'disabled':''} onclick="event.stopPropagation();${inH?'':`toggleDetailsCol('${k}')`}">
            <label>${ALL_COLUMNS[k].label}${inH?' (заг)':''}</label>
        </div>`; 
    }).join(''); 
}
function toggleHeaderCol(k) { 
    const i = colSettings.header.indexOf(k); 
    i !== -1 ? colSettings.header.splice(i,1) : colSettings.header.push(k); 
    renderColumnsList(); 
}
function toggleDetailsCol(k) { 
    if(colSettings.header.includes(k)) return; 
    const i = colSettings.details.indexOf(k); 
    i === -1 ? colSettings.details.push(k) : colSettings.details.splice(i,1); 
    renderColumnsList(); 
}
function resetColumnsSettings() {
    colSettings = {
        header: ['name','phone','seats','from','to','date','payment'],
        details: ['percent','note','mark','dispatcher','phoneReg','timing','dateReg','weight']
    };
    renderColumnsList();
    showToast('🔄 Скинуто');
}
function saveColumnsSettings() { 
    saveSettings(); 
    closeModal('columnsModal'); 
    render(); 
    showToast('✅ Колонки збережено'); 
}

function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

// DIRECTION FILTER
function toggleDirectionPopup() {
    document.getElementById('directionPopup').classList.toggle('show');
}

function setDirection(dir) {
    filters.direction = dir;
    filters.showNewOnly = false; // Вимикаємо фільтр "Нові"
    
    // Виходимо з режиму маршруту та спеціальних статусів
    filters.statusFilter = '';
    filters.routeVehicle = '';
    filters.specialStatus = '';
    filters.showArchive = false;
    routePassengers = [];
    routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0 };
    currentRouteVehicle = null;
    routeStatusFilter = 'all';
    
    document.getElementById('directionPopup')?.classList.remove('show');
    
    // Оновлюємо активні стани
    document.querySelectorAll('.direction-option').forEach(el => {
        el.classList.toggle('active', el.dataset.dir === dir);
    });
    
    // Оновлюємо мобільні
    document.getElementById('mobileDirectionAll')?.classList.toggle('active', dir === 'all');
    document.getElementById('mobileDirectionUaEu')?.classList.toggle('active', dir === 'ua-eu');
    document.getElementById('mobileDirectionEuUa')?.classList.toggle('active', dir === 'eu-ua');
    document.getElementById('mobileNewLeads')?.classList.remove('active');
    
    // Оновлюємо PC sidebar
    document.getElementById('pcDirectionAll')?.classList.toggle('active', dir === 'all');
    document.getElementById('pcDirectionUaEu')?.classList.toggle('active', dir === 'ua-eu');
    document.getElementById('pcDirectionEuUa')?.classList.toggle('active', dir === 'eu-ua');
    document.getElementById('pcNewLeads')?.classList.remove('active');
    
    // Оновлюємо label
    const labels = {'all': 'Пасажири', 'ua-eu': '🇺🇦→🇪🇺', 'eu-ua': '🇪🇺→🇺🇦'};
    const navLabel = document.getElementById('navPassengersLabel');
    if (navLabel) navLabel.textContent = labels[dir] || 'Пасажири';
    
    render();
    updateVehiclesList();
    updateAllCounts();
}

// Показати тільки нові ліди (за останні 24 години)
function showNewLeads() {
    filters.showNewOnly = true;
    filters.direction = 'all';
    filters.statusFilter = '';
    filters.routeVehicle = '';
    filters.specialStatus = '';
    filters.showArchive = false;
    filters.date = '';
    filters.vehicle = '';
    routePassengers = [];
    
    // Оновлюємо активні стани
    document.getElementById('mobileDirectionAll')?.classList.remove('active');
    document.getElementById('mobileDirectionUaEu')?.classList.remove('active');
    document.getElementById('mobileDirectionEuUa')?.classList.remove('active');
    document.getElementById('mobileNewLeads')?.classList.add('active');
    
    document.getElementById('pcDirectionAll')?.classList.remove('active');
    document.getElementById('pcDirectionUaEu')?.classList.remove('active');
    document.getElementById('pcDirectionEuUa')?.classList.remove('active');
    document.getElementById('pcNewLeads')?.classList.add('active');
    
    const navLabel = document.getElementById('navPassengersLabel');
    if (navLabel) navLabel.textContent = '🆕 Нові';
    
    render();
    updateAllCounts();
    showToast('🆕 Нові заявки за 24 год');
}

// ============================================
// MAP MODAL
// ============================================
let currentMapPassengerId = null;

function openMapModal(uid) {
    const p = findPassengerByUid(uid);
    if (!p) return;
    
    currentMapPassengerId = uid;
    
    document.getElementById('mapFromAddress').textContent = p.from || '—';
    document.getElementById('mapToAddress').textContent = p.to || '—';
    document.getElementById('mapRouteAddress').textContent = (p.from && p.to) ? `${p.from} → ${p.to}` : '—';
    
    document.getElementById('mapModal').classList.add('show');
}

function openMapLocation(type) {
    const p = findPassengerByUid(currentMapPassengerId);
    if (!p) return;
    
    let url = '';
    
    if (type === 'from' && p.from) {
        url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.from)}`;
    } else if (type === 'to' && p.to) {
        url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.to)}`;
    } else if (type === 'route' && p.from && p.to) {
        url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(p.from)}&destination=${encodeURIComponent(p.to)}`;
    }
    
    if (url) {
        window.open(url, '_blank');
        closeModal('mapModal');
    } else {
        showToast('❌ Адреса не вказана');
    }
}

// ============================================
// GOOGLE SHEETS API
// ============================================
const API_URL = 'https://script.google.com/macros/s/AKfycbwMfbmmDWQ5fUnurCsEmp6XDCZCdTyXdpbN63rWxIplF7zfzf8fTZEh_FD5sy9klqpJ/exec';

// API для маршрутів (окрема таблиця)
const ROUTE_API_URL = 'https://script.google.com/macros/s/AKfycbwcota7jx-I9FTaRH3KmMqK3WX18-Fauy8uJfKxf0tMiShWCqSJoexobbQCIxGStXHN/exec';

// Нормалізація дати до формату YYYY-MM-DD
function normalizeDate(dateStr) {
    if (!dateStr) return '';
    // Якщо вже в форматі YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
    // Якщо формат DD.MM.YYYY
    if (/^\d{2}\.\d{2}\.\d{4}$/.test(dateStr)) {
        const [d, m, y] = dateStr.split('.');
        return `${y}-${m}-${d}`;
    }
    // Якщо це Date об'єкт або ISO string
    try {
        const d = new Date(dateStr);
        if (!isNaN(d.getTime())) {
            return d.toISOString().split('T')[0];
        }
    } catch(e) {}
    return '';
}

// SYNC - Отримати всіх пасажирів (POST запит!)
function syncWithSheets() {
    showLoader('Синхронізація...', '');
    
    fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'getAll' })
    })
    .then(r => r.json())
    .then(data => {
        hideLoader();
        if (data.success) {
            // Мержимо з локальними (зберігаємо локальні зміни)
            const serverPassengers = data.passengers.map(p => {
                // Нормалізуємо статус (lowercase, trim)
                let normalizedStatus = (p.status || '').toString().toLowerCase().trim();
                if (!normalizedStatus) normalizedStatus = 'new';
                
                return {
                    id: p.id || 'srv_' + p.rowNum,
                    date: normalizeDate(p.date),
                    name: p.name || '',
                    phone: p.phone || '',
                    phoneReg: p.phoneReg || '',
                    from: p.from || '',
                    to: p.to || '',
                    seats: p.seats || 1,
                    payment: p.payment || '',
                    percent: p.percent || '',
                    mark: p.mark || '',
                    dispatcher: p.dispatcher || '',
                    weight: p.weight || '',
                    vehicle: p.vehicle || '',
                    timing: p.timing || '',
                    dateReg: normalizeDate(p.dateReg),
                    note: p.note || '',
                    direction: p.direction,
                    status: normalizedStatus,
                    statusDate: p.statusDate || '',
                    isNew: p.isNew,
                    isNew24h: p.isNew, // Зберігаємо для фільтра "Нові" (не зникає при кліку)
                    // Зберігаємо інфо для оновлення
                    _sheet: p.sheet,
                    _rowNum: p.rowNum
                };
            });
            
            passengers = serverPassengers;
            saveSettings();
            render();
            updateAllCounts();
            renderCalendars();
            
            showToast(`✅ Завантажено: ${data.counts.total}`);
        } else {
            showToast('❌ Помилка: ' + (data.error || 'Невідома'));
        }
    })
    .catch(err => {
        hideLoader();
        console.error('Sync error:', err);
        showToast('❌ Помилка зв\'язку');
    });
}

// SAVE - Додати нового пасажира на сервер
function savePassengerToServer(passenger) {
    showLoader('Збереження...', '');
    
    const payload = {
        action: 'addPassenger',
        payload: {
            direction: passenger.direction,
            initials: getUserInitials(),
            date: passenger.date,
            from: passenger.from,
            to: passenger.to,
            seats: passenger.seats,
            name: passenger.name,
            phone: passenger.phone,
            phoneReg: passenger.phoneReg,
            mark: passenger.mark,
            payment: passenger.payment,
            percent: passenger.percent,
            dispatcher: passenger.dispatcher || 'CRM',
            weight: passenger.weight,
            vehicle: passenger.vehicle,
            timing: passenger.timing,
            dateReg: passenger.dateReg,
            note: passenger.note
        }
    };
    
    fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        hideLoader();
        if (data.success) {
            // Оновлюємо локальний ID
            const p = passengers.find(x => x.id === passenger.id);
            if (p) {
                p.id = data.id;
                p._sheet = data.sheet;
                p._rowNum = data.rowNum;
            }
            saveSettings();
            render();
            showToast('✅ Збережено: ' + data.id);
            
            // Перевіряємо місткість після додавання
            checkAllCapacityWarnings();
        } else {
            showToast('⚠️ Помилка: ' + data.error);
        }
    })
    .catch(err => {
        hideLoader();
        console.error('Save error:', err);
        showToast('⚠️ Збережено локально');
    });
}

// UPDATE - Оновити пасажира на сервері
function updatePassengerOnServer(passenger) {
    if (!passenger._sheet || !passenger._rowNum) {
        console.warn('❌ Немає _sheet або _rowNum:', passenger);
        showToast('⚠️ Синхронізуй спочатку');
        return;
    }
    
    const payload = {
        action: 'updatePassenger',
        payload: {
            sheet: passenger._sheet,
            rowNum: passenger._rowNum,
            date: passenger.date,
            from: passenger.from,
            to: passenger.to,
            seats: passenger.seats,
            name: passenger.name,
            phone: passenger.phone,
            phoneReg: passenger.phoneReg,
            mark: passenger.mark || '',
            payment: passenger.payment,
            percent: passenger.percent,
            dispatcher: passenger.dispatcher,
            weight: passenger.weight,
            vehicle: passenger.vehicle,
            timing: passenger.timing,
            dateReg: passenger.dateReg,
            note: passenger.note
        }
    };
    
    fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('✅ Збережено');
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        console.error('❌ Fetch error:', err);
        showToast('❌ Помилка зв\'язку');
    });
}

// Отримати ініціали користувача (поки що заглушка)
function getUserInitials() {
    // TODO: Брати з профілю користувача
    return 'CRM';
}

// ============================================
// 🏷️ SMART SENDER TAGGING
// ============================================
const TAG_PROXY_URL = 'https://botisystem.com/yuratransportation/manager/proxy_pass_19v.php';

function openTagModal() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть пасажирів');
    document.getElementById('tagSelectedCount').textContent = selectedIds.size;
    document.getElementById('tagNameInput').value = '';
    document.getElementById('tagFormBody').style.display = '';
    document.getElementById('tagProgressBody').style.display = 'none';
    document.getElementById('tagFormFooter').style.display = '';
    document.getElementById('tagResultFooter').style.display = 'none';
    document.getElementById('tagLog').innerHTML = '';
    document.getElementById('tagModal').classList.add('show');
    setTimeout(() => document.getElementById('tagNameInput').focus(), 100);
}

function closeTagModal() {
    document.getElementById('tagModal').classList.remove('show');
}

function tagErrorText(code) {
    const map = {
        'E01': 'Помилка запиту (E01)',
        'E02': 'Немає ID контакту (E02)',
        'E03': 'Немає назви тегу (E03)',
        'E10': 'Сервер тегів недоступний (E10)',
        'E11': 'Помилка пошуку тегу (E11)',
        'E20': 'Сервер тегів недоступний (E20)',
        'E21': 'Не вдалось створити тег (E21)',
        'E22': 'Тег існує, але не знайдено (E22)',
        'E30': 'Smart Sender недоступний (E30)',
        'E31': 'Контакт не знайдено в SS (E31)',
        'E32': 'Помилка перевірки контакту (E32)',
        'E40': 'Не вдалось повісити тег (E40)',
        'E41': 'Контакт або тег не знайдено (E41)',
        'E42': 'Помилка привʼязки тегу (E42)'
    };
    return map[code] || 'Невідома помилка (' + code + ')';
}

async function startTagging() {
    const tagName = document.getElementById('tagNameInput').value.trim();
    if (!tagName) return showToast('⚠️ Введіть назву тегу');

    // Збираємо всіх з перевіркою на немає ІД та дублі
    const items = [];
    const noId = [];
    const seenIds = new Set();
    const dupes = [];

    selectedIds.forEach(uid => {
        const p = findPassengerByUid(uid);
        if (!p) return;
        const name = p.name || '—';
        if (!p.id) {
            noId.push(name);
            return;
        }
        if (seenIds.has(String(p.id))) {
            dupes.push(name + ' (ІД ' + p.id + ')');
            return;
        }
        seenIds.add(String(p.id));
        items.push({ userId: p.id, name: name });
    });

    if (items.length === 0 && noId.length === 0 && dupes.length === 0) return showToast('⚠️ Нікого не вибрано');

    // UI → прогрес
    document.getElementById('tagFormBody').style.display = 'none';
    document.getElementById('tagProgressBody').style.display = '';
    document.getElementById('tagFormFooter').style.display = 'none';

    const logEl = document.getElementById('tagLog');
    const bar = document.getElementById('tagProgressBar');
    const txt = document.getElementById('tagProgressText');
    logEl.innerHTML = '';
    bar.style.width = '0%';
    bar.style.background = '#7c3aed';

    let ok = 0, fail = 0, skip = 0;
    tagLog(logEl, '🏷️ Тег: "' + tagName + '"');
    tagLog(logEl, '👥 Вибрано: ' + selectedIds.size + ' | До тегування: ' + items.length);

    // Логуємо пасажирів без ІД
    if (noId.length > 0) {
        tagLog(logEl, '─'.repeat(30));
        noId.forEach(name => {
            tagLog(logEl, '⛔ ' + name + ' — Немає ІД в системі');
            fail++;
        });
    }

    // Логуємо дублі
    if (dupes.length > 0) {
        tagLog(logEl, '─'.repeat(30));
        dupes.forEach(d => {
            tagLog(logEl, '🔁 ' + d + ' — Дубль ІД, пропущено');
            skip++;
        });
    }

    if (items.length === 0) {
        tagLog(logEl, '─'.repeat(30));
        tagLog(logEl, '📊 Нікого тегувати — всі без ІД або дублі');
        bar.style.width = '100%';
        bar.style.background = 'var(--warning)';
        txt.textContent = '⚠️ Нікого тегувати';
        document.getElementById('tagResultFooter').style.display = '';
        return;
    }

    tagLog(logEl, '─'.repeat(30));

    for (let i = 0; i < items.length; i++) {
        const item = items[i];
        bar.style.width = Math.round(((i+1)/items.length)*100) + '%';
        txt.textContent = '⏳ Тегування: ' + (i+1) + '/' + items.length + '...';

        try {
            const res = await fetch(TAG_PROXY_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId: item.userId, tagName: tagName })
            });
            const data = await res.json();

            if (data.error) {
                tagLog(logEl, '❌ ' + item.name + ' — ' + tagErrorText(data.error));
                fail++;
            } else if (data.state === true || data.id || data.tagId) {
                const note = data.note === 'already_tagged' ? ' (вже був)' : '';
                tagLog(logEl, '✅ ' + item.name + ' — OK' + note);
                ok++;
            } else {
                tagLog(logEl, '⚠️ ' + item.name + ' — Невідома відповідь (EUNK)');
                fail++;
            }
        } catch(e) {
            tagLog(logEl, '❌ ' + item.name + ' — Немає зв\'язку (ENET)');
            fail++;
        }

        if (i < items.length - 1) await new Promise(r => setTimeout(r, 300));
    }

    tagLog(logEl, '─'.repeat(30));
    let summary = '📊 ✅' + ok;
    if (fail > 0) summary += ' ❌' + fail;
    if (skip > 0) summary += ' 🔁' + skip;
    tagLog(logEl, summary);

    const allGood = fail === 0 && skip === 0 && noId.length === 0;
    txt.textContent = allGood
        ? '✅ Протеговано ' + ok + '!'
        : '⚠️ ✅' + ok + (fail > 0 ? ' ❌' + fail : '') + (skip > 0 ? ' 🔁' + skip : '');
    bar.style.width = '100%';
    bar.style.background = allGood ? 'var(--success)' : 'var(--warning)';
    document.getElementById('tagResultFooter').style.display = '';

    showToast(allGood ? '🏷️ Протеговано: ' + ok : '🏷️ ✅' + ok + (fail > 0 ? ' ❌' + fail : '') + (skip > 0 ? ' 🔁' + skip : ''));
}

function tagLog(el, text) {
    el.innerHTML += text + '\n';
    el.scrollTop = el.scrollHeight;
}

// Close dropdowns on outside click
document.addEventListener('click', e => { 
    if (!e.target.closest('.dropdown-container')) document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('show')); 
    if (!e.target.closest('.card-vehicle-badge') && !e.target.closest('.vehicle-dropdown')) document.querySelectorAll('.vehicle-dropdown').forEach(d => d.classList.remove('show'));
    if (!e.target.closest('#navPassengers') && !e.target.closest('.direction-popup')) document.getElementById('directionPopup')?.classList.remove('show');
});
</script>
</body>
</html>